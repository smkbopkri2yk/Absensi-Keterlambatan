<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi & Keterlambatan - Enhanced (Fixed)</title> <!-- Title updated -->

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Font Awesome for Icons (Optional, for Theme Toggle) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


  <!-- TAMBAHKAN CDN: Firebase SDK v8.10.0 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Tambahkan SDK Firebase lain jika dibutuhkan (misal, auth, storage) -->


  <style>
    /* ... (CSS Anda tetap sama) ... */
     /* ========== RESET & GLOBAL STYLES ========== */
     :root {
        /* Default Light Theme Colors */
        --bg-color: #f0f2f5;
        --text-color: #333;
        --card-bg-color: #fff;
        --header-bg-color: #4a90e2;
        --header-text-color: #fff;
        --nav-bg-color: #fff;
        --nav-item-bg-color: #e0e6ed;
        --nav-item-text-color: #333;
        --nav-item-active-bg-color: #4a90e2;
        --nav-item-active-text-color: #fff;
        --input-bg-color: #fff;
        --input-border-color: #ccc;
        --table-header-bg-color: #4a90e2;
        --table-header-text-color: #fff;
        --table-row-even-bg-color: #f9f9f9;
        --table-row-hover-bg-color: #eef4f9;
        --link-color: #333; /* Default link color */
        --link-hover-color: #000;
        --modal-bg-color: #fff;
        --box-shadow-color: rgba(0,0,0,0.1);
        --primary-color: #4a90e2;
        --secondary-color: #95a5a6;
        --danger-color: #e74c3c;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --info-color: #3498db;
    }

    [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --card-bg-color: #2c2c2c;
        --header-bg-color: #357ABD; /* Slightly darker blue */
        --header-text-color: #f0f0f0;
        --nav-bg-color: #252525;
        --nav-item-bg-color: #404040;
        --nav-item-text-color: #e0e0e0;
        --nav-item-active-bg-color: #357ABD;
        --nav-item-active-text-color: #fff;
        --input-bg-color: #333;
        --input-border-color: #555;
        --table-header-bg-color: #357ABD;
        --table-header-text-color: #f0f0f0;
        --table-row-even-bg-color: #303030;
        --table-row-hover-bg-color: #454545;
        --link-color: #e0e0e0;
        --link-hover-color: #fff;
        --modal-bg-color: #2c2c2c;
        --box-shadow-color: rgba(255,255,255,0.1);
        --primary-color: #357ABD;
        --secondary-color: #7f8c8d;
        --danger-color: #c0392b;
        --success-color: #27ae60;
        --warning-color: #e67e22;
        --info-color: #2980b9;
    }


    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
        scroll-behavior: smooth;
    }
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
       transition: background-color 0.3s ease, color 0.3s ease; /* Transition for theme change */
    }
    a {
      text-decoration: none;
      color: var(--link-color);
    }
    a:hover {
        color: var(--link-hover-color);
    }
    button {
      cursor: pointer;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      position: relative; /* For potential loading indicators */
      color: #fff; /* Default button text color - ensure contrast */
    }
     button.btn-secondary, button.btn-warning { color: #fff; } /* Ensure contrast for these too */
     [data-theme="dark"] button { color: #fff; } /* Ensure contrast in dark mode */
     [data-theme="dark"] button.btn-secondary { color: #fff; }
     [data-theme="dark"] button.btn-warning { color: #333; } /* Warning text dark on dark */


    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--box-shadow-color);
    }
    button:disabled {
        cursor: not-allowed;
        background-color: #ccc !important;
        transform: none;
        box-shadow: none;
         color: #666 !important; /* Disabled text color */
    }
    button .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-block-start: 2px solid #fff;
        border-radius: 50%;
        inline-size: 1em;
        block-size: 1em;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-inline-start: 8px;
        vertical-align: middle;
    }

    /* ========== HEADER STYLES ========== */
    header {
      background-color: var(--header-bg-color);
      color: var(--header-text-color);
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 4px var(--box-shadow-color);
      display: flex; /* For Theme Toggle */
      justify-content: center; /* Center title */
      align-items: center;
      position: relative; /* For positioning toggle */
    }
    header h1 {
      font-size: 2rem;
      margin: 0;
      flex-grow: 1; /* Allow title to take space */
      text-align: center; /* Ensure centered */
      /* Adjust padding if toggle button pushes title */
      padding: 0 50px; /* Add padding to sides */
    }
     /* NEW FEATURE: Theme Toggle Button */
    #themeToggle {
      position: absolute;
      inset-inline-end: 20px; /* Position on the right */
      font-size: 1.2rem;
      background: none;
      border: none;
      color: var(--header-text-color);
      cursor: pointer;
      padding: 5px;
    }

    /* ========== NAVBAR STYLES ========== */
    nav {
      background-color: var(--nav-bg-color);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px 0;
      box-shadow: 0 2px 4px var(--box-shadow-color);
      position: sticky;
      inset-block-start: 0;
      z-index: 100;
    }
    nav .nav-item {
      margin: 5px 10px;
      padding: 10px 15px;
      background-color: var(--nav-item-bg-color);
      color: var(--nav-item-text-color);
      border-radius: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
      border: 1px solid transparent;
    }
    nav .nav-item:hover {
      background-color: #d1d9e1; /* Keep hover distinct or use variables */
      color: #000;
      [data-theme="dark"] & { /* Dark mode hover */
         background-color: #555;
         color: #fff;
      }
    }
    nav .nav-item.active {
      background-color: var(--nav-item-active-bg-color);
      color: var(--nav-item-active-text-color);
      font-weight: bold;
      border-color: #357ABD;
       [data-theme="dark"] & { border-color: #4a90e2; }
    }
     /* NEW FEATURE: Help Nav Item */
     #navHelp { /* Style similarly to other nav items */ }


    /* ========== CONTAINER & SCREEN STYLES ========== */
    .container {
      max-inline-size: 1200px;
      margin: 30px auto;
      padding: 25px;
      background-color: var(--card-bg-color);
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--box-shadow-color);
    }
    .screen {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    .screen.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
        color: var(--text-color); /* Use variable */
        margin-block-end: 25px;
        border-block-end: 2px solid var(--primary-color); /* Use variable */
        padding-block-end: 10px;
    }
    h3 {
        color: var(--text-color); /* Use variable */
        margin-block-start: 20px;
        margin-block-end: 15px;
    }

    /* ========== FORM & INPUT STYLES ========== */
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: 600;
      color: var(--text-color); /* Use variable */
    }
    input[type="text"],
    input[type="date"],
    input[type="time"], /* Added for Time Input */
    input[type="month"],
    input[type="search"],
    input[type="number"], /* Added for Range Filter */
    select,
    input[type="file"] {
      inline-size: 100%;
      padding: 12px;
      border: 1px solid var(--input-border-color);
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background-color: var(--input-bg-color);
      color: var(--text-color); /* Ensure text is readable */
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    input[type="month"]:focus,
    input[type="search"]:focus,
    input[type="number"]:focus,
    select:focus,
    input[type="file"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
       [data-theme="dark"] & { box-shadow: 0 0 0 3px rgba(53, 122, 189, 0.3); }
    }
     /* Make datalist options visible in dark mode */
     [data-theme="dark"] option {
         background-color: var(--input-bg-color);
         color: var(--text-color);
     }
     [data-theme="dark"] select option {
         background: var(--input-bg-color); /* For select dropdowns */
         color: var(--text-color);
     }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-block-end: 15px;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .input-group {
        margin-block-end: 20px;
    }
    .form-actions {
        margin-block-start: 25px;
    }
    .filter-section {
        background-color: var(--nav-item-bg-color); /* Use theme variable */
        padding: 15px;
        border-radius: 8px;
        margin-block-end: 25px;
        border: 1px solid var(--input-border-color); /* Use theme variable */
    }
     .filter-section h3 {
        margin-block-start: 0;
        margin-block-end: 15px;
     }
    .filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }
    .filter-controls > div {
        flex: 1 1 180px; /* Adjust base width */
    }
     .filter-controls label {
        margin-block-start: 0;
     }
     .filter-controls input[type="number"] {
        inline-size: calc(50% - 8px); /* For range inputs */
     }
    .search-bar {
        margin-block-end: 15px;
    }
    .search-bar input[type="search"] {
        max-inline-size: 400px;
        display: inline-block;
    }

    /* ========== BUTTON STYLES ========== */
    .btn { margin-inline-end: 8px; margin-block-end: 8px;}
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .btn-primary:hover { background-color: #357ABD; [data-theme="dark"] & { background-color: #4a90e2; } }
    .btn-danger { background-color: var(--danger-color); color: #fff; }
    .btn-danger:hover { background-color: #c0392b; [data-theme="dark"] & { background-color: #e74c3c; } }
    .btn-secondary { background-color: var(--secondary-color); color: #fff; }
    .btn-secondary:hover { background-color: #7f8c8d; [data-theme="dark"] & { background-color: #95a5a6; } }
    .btn-warning { background-color: var(--warning-color); color: #fff; [data-theme="dark"] & { color: #333; } }
    .btn-warning:hover { background-color: #e67e22; [data-theme="dark"] & { background-color: #f39c12; } }
    .btn-success { background-color: var(--success-color); color: #fff; }
    .btn-success:hover { background-color: #27ae60; [data-theme="dark"] & { background-color: #2ecc71; } }


    /* ========== TABLE STYLES ========== */
    .table-container {
        overflow-x: auto;
    }
    table {
      inline-size: 100%;
      border-collapse: collapse;
      margin-block-start: 20px;
      background-color: var(--card-bg-color);
      box-shadow: 0 2px 4px var(--box-shadow-color);
    }
    th, td {
      padding: 12px 15px;
      text-align: start;
      border-block-end: 1px solid var(--input-border-color); /* Use theme variable */
      vertical-align: middle;
    }
    th {
      background-color: var(--table-header-bg-color);
      color: var(--table-header-text-color);
      font-weight: 600;
      white-space: nowrap;
    }
    th.sortable {
        cursor: pointer;
        position: relative;
        padding-inline-end: 25px;
    }
    th.sortable:hover {
        background-color: #357ABD;
        [data-theme="dark"] & { background-color: #4a90e2; }
    }
    th .sort-icon {
        position: absolute;
        inset-inline-end: 8px;
        inset-block-start: 50%;
        transform: translateY(-50%);
        font-size: 0.8em;
        color: var(--table-header-text-color);
    }
    tr:nth-child(even) {
      background-color: var(--table-row-even-bg-color);
    }
    tr:hover {
      background-color: var(--table-row-hover-bg-color);
    }
    td button {
        margin-inline-end: 5px;
        padding: 5px 10px;
        font-size: 0.9rem;
    }
    /* NEW FEATURE: Clickable Row/Name for Detail View */
    .clickable-name {
        cursor: pointer;
        color: var(--primary-color);
        text-decoration: underline;
    }
    .clickable-name:hover {
        color: var(--info-color);
    }


    /* ========== STATUS BOX / FILTER RESULT STYLES ========== */
    .status-box {
      margin: 15px 0;
      padding: 15px;
      border-radius: 5px;
      font-weight: 500;
      border: 1px solid;
    }
    .status-box.info { background-color: #eaf2f8; border-color: #aed6f1; color: #2e86c1; [data-theme="dark"] & { background-color: #2c3e50; border-color: #3498db; color: #ecf0f1;} }
    .status-box.success { background-color: #dff0d8; border-color: #d0e9c6; color: #3c763d; [data-theme="dark"] & { background-color: #27ae60; border-color: #2ecc71; color: #fff;} }
    .status-box.warning { background-color: #fcf8e3; border-color: #faebcc; color: #8a6d3b; [data-theme="dark"] & { background-color: #f39c12; border-color: #e67e22; color: #333;} }
    .status-box.error { background-color: #f2dede; border-color: #ebccd1; color: #a94442; [data-theme="dark"] & { background-color: #c0392b; border-color: #e74c3c; color: #fff;} }


    /* ========== DASHBOARD STYLES ========== */
    .dashboard-section {
      margin-block-end: 40px;
    }
    .dashboard-card {
      padding: 25px;
      background-color: var(--card-bg-color);
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--box-shadow-color);
      border-block-start: 4px solid var(--primary-color);
    }
    .dashboard-card h3 {
      margin-block-start: 0;
      margin-block-end: 20px;
      color: var(--text-color);
      font-size: 1.3rem;
    }

    /* ========== MODAL STYLES ========== */
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      inset-inline-start: 0;
      inset-block-start: 0;
      inline-size: 100%;
      block-size: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7); /* Darker overlay */
      align-items: start; /* Align modal to top */
      justify-content: center;
      padding: 40px 20px 20px 20px; /* Add padding top */
    }
    .modal-content {
      background-color: var(--modal-bg-color);
      padding: 30px;
      border-radius: 10px;
      inline-size: 90%;
      max-inline-size: 700px; /* Increase max-width for detail modal */
      position: relative;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      margin-bottom: 40px; /* Add margin bottom for scroll */
    }
    @keyframes slideIn {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-content h3 {
        margin-block-start: 0;
        color: var(--text-color);
    }
    .close {
      position: absolute;
      inset-block-start: 15px;
      inset-inline-end: 20px;
      font-size: 1.8rem;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      transition: color 0.3s ease;
      line-height: 1;
    }
    .close:hover {
      color: var(--text-color);
    }
    .modal-actions {
        margin-block-start: 25px;
        text-align: end;
    }
    .modal-actions button {
        margin-inline-start: 10px;
    }
     /* NEW FEATURE: Siswa Detail Modal Specific Styles */
     #siswaDetailModalContent .siswa-info {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
         gap: 10px 20px;
         margin-bottom: 25px;
         padding-bottom: 15px;
         border-bottom: 1px solid var(--input-border-color);
     }
      #siswaDetailModalContent .siswa-info p { margin: 5px 0; }
      #siswaDetailModalContent .siswa-info strong { color: var(--primary-color); }
      #siswaDetailHistoryTableContainer { max-height: 300px; overflow-y: auto; }


    /* ========== FOOTER STYLES ========== */
    footer {
      background-color: var(--nav-bg-color); /* Use theme variable */
      padding: 25px 0;
      text-align: center;
      box-shadow: 0 -2px 8px var(--box-shadow-color);
      margin-block-start: 50px;
    }
    .footer-line {
      inline-size: 60px;
      block-size: 4px;
      background-color: var(--primary-color);
      margin: 0 auto 15px auto;
      border-radius: 2px;
    }
    footer p {
      color: var(--secondary-color); /* Use theme variable */
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* ========== NOTIFICATION STYLES ========== */
    #notification-area {
        position: fixed;
        inset-block-start: 80px;
        inset-inline-end: 20px;
        z-index: 1050;
        inline-size: 300px;
        max-inline-size: 90%;
    }
    .toast {
        background-color: #333;
        color: #fff;
        padding: 15px;
        margin-block-end: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        transform: translateX(100%);
    }
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    /* Use theme variables for toast backgrounds */
    .toast.toast-success { background-color: var(--success-color); color: #fff; }
    .toast.toast-error { background-color: var(--danger-color); color: #fff; }
    .toast.toast-info { background-color: var(--info-color); color: #fff; }
    .toast.toast-warning { background-color: var(--warning-color); color: #333; }


    /* ========== LOADER STYLES ========== */
    .loader-container {
        text-align: center;
        padding: 40px;
    }
    .loader {
      border: 6px solid #f3f3f3;
       [data-theme="dark"] & { border-color: #444; }
      border-block-start: 6px solid var(--primary-color);
      border-radius: 50%;
      inline-size: 50px;
      block-size: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ========== NEW FEATURE: Bulk Input Styles ========== */
    #bulkAbsensiSiswaList {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--input-border-color);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    #bulkAbsensiSiswaList label {
        display: block; /* Each student on a new line */
        margin-bottom: 5px;
    }

     /* ========== NEW FEATURE: Help Screen Styles ========== */
     #helpScreen .help-section {
         margin-bottom: 30px;
         padding: 20px;
         background-color: var(--nav-item-bg-color); /* Use theme color */
         border-radius: 8px;
         border: 1px solid var(--input-border-color);
     }
     #helpScreen .help-section h3 {
         margin-top: 0;
         border-bottom: 1px solid var(--primary-color);
         padding-bottom: 8px;
     }


    /* ========== RESPONSIVE STYLES ========== */
    @media (max-width: 992px) { /* Adjust breakpoint */
       .filter-controls > div {
           flex-basis: 220px; /* Allow slightly more space */
       }
    }
    @media (max-width: 768px) {
      header h1 { font-size: 1.5rem; padding: 0 40px;} /* Adjust padding */
       #themeToggle { font-size: 1rem; inset-inline-end: 10px; }
      nav {
        inset-block-start: 0;
        padding: 10px 5px;
      }
       nav .nav-item {
           font-size: 0.9rem;
           padding: 8px 12px;
           margin: 3px 5px;
       }
      .container {
          margin: 20px auto;
          padding: 15px;
      }
      h2 { font-size: 1.4rem; margin-block-end: 20px; }
      .modal-content {
        inline-size: 95%;
        padding: 20px;
        max-inline-size: 95%; /* Allow wider modal on mobile */
      }
      /* Improve table on mobile - stack or smaller font? Simple scroll is already there */
      th, td { padding: 10px 8px; font-size: 0.9rem;}
      td button { font-size: 0.8rem; padding: 4px 8px;}

       button { padding: 12px 15px; }
       .filter-controls { flex-direction: column; align-items: stretch; }
       .filter-controls > div { flex-basis: auto; inline-size: 100%; }
       .filter-controls input[type="number"] { inline-size: 100%; margin-bottom: 5px;}
       .dashboard-card { padding: 15px;}
       #siswaDetailModalContent .siswa-info { grid-template-columns: 1fr; } /* Stack info on mobile */
    }
     @media (max-width: 480px) {
         header h1 { font-size: 1.3rem; padding: 0 35px;}
         nav { flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; }
         nav .nav-item { flex-shrink: 0; }
         th, td { font-size: 0.85rem;}
     }
  </style>
</head>
<body data-theme="light"> <!-- Default theme -->

  <!-- Notification Area -->
  <div id="notification-area"></div> <!-- Pastikan ID ini ada -->

  <!-- ... (Modal HTML sama seperti sebelumnya) ... -->
   <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close" id="confirmModalClose">&times;</span>
      <h3>Konfirmasi</h3>
      <p id="confirmModalMessage" style="margin: 20px 0;">Apakah Anda yakin?</p>
      <div class="modal-actions">
        <button id="confirmModalCancel" class="btn btn-secondary">Batal</button>
        <button id="confirmModalConfirm" class="btn btn-danger">Konfirmasi</button>
      </div>
    </div>
  </div>

  <!-- NEW FEATURE: Siswa Detail Modal -->
  <div id="siswaDetailModal" class="modal">
      <div id="siswaDetailModalContent" class="modal-content">
          <span class="close" id="siswaDetailModalClose">&times;</span>
          <h3>Detail Siswa & Riwayat Absensi</h3>
          <div class="siswa-info">
              <p><strong>Nama:</strong> <span id="detailNamaSiswa">-</span></p>
              <p><strong>Kelas:</strong> <span id="detailKelasSiswa">-</span></p>
              <p><strong>NIS:</strong> <span id="detailNisSiswa">-</span></p>
              <p><strong>Wali Kelas:</strong> <span id="detailWaliKelasSiswa">-</span></p>
              <p><strong>Total Terlambat:</strong> <span id="detailTotalTerlambat">-</span></p>
              <p><strong>Total Izin:</strong> <span id="detailTotalIzin">-</span></p>
              <p><strong>Total Sakit:</strong> <span id="detailTotalSakit">-</span></p>
              <p><strong>Total Alpha:</strong> <span id="detailTotalAlpha">-</span></p>
          </div>
          <h4>Riwayat:</h4>
          <div id="siswaDetailHistoryTableContainer" class="table-container">
              <table>
                  <thead>
                      <tr>
                          <th>Tanggal</th>
                          <th>Status</th>
                          <th>Waktu</th> <!-- Added -->
                          <th>Alasan</th>
                          <th>Pengisi</th>
                      </tr>
                  </thead>
                  <tbody id="siswaDetailHistoryTableBody">
                      <!-- Detail history loaded by JS -->
                      <tr><td colspan="5" style="text-align:center;">Memuat riwayat...</td></tr>
                  </tbody>
              </table>
          </div>
          <div class="modal-actions">
              <button id="siswaDetailModalCloseBtn" class="btn btn-secondary">Tutup</button>
              <!-- Add action buttons if needed, e.g., Print Report -->
          </div>
      </div>
  </div>


  <!-- HEADER -->
  <header>
    <h1>Absensi & Keterlambatan</h1>
    <!-- NEW FEATURE: Theme Toggle Button -->
    <button id="themeToggle" title="Ganti Tema"><i class="fas fa-sun"></i></button>
  </header>

  <!-- NAVBAR -->
  <nav id="mainNav">
    <a href="#" id="navHome" class="nav-item active">Home</a>
    <a href="#" id="navAbsensi" class="nav-item">Input Absensi</a>
    <a href="#" id="navBulkAbsensi" class="nav-item">Input Bulk</a> <!-- NEW FEATURE -->
    <a href="#" id="navTerlambat" class="nav-item">Data Keterlambatan</a>
    <a href="#" id="navHistory" class="nav-item">History</a>
    <a href="#" id="navStatistik" class="nav-item">Statistik</a>
    <a href="#" id="navSettings" class="nav-item">Settings</a>
    <a href="#" id="navProfile" class="nav-item">Profile</a>
    <a href="#" id="navDataSiswa" class="nav-item">Data Siswa</a>
    <a href="#" id="navHelp" class="nav-item">Bantuan</a> <!-- NEW FEATURE -->
  </nav>


  <!-- ... (Konten HTML lainnya (container, screens) tetap sama) ... -->
    <!-- MAIN CONTAINER -->
  <div class="container">

    <!-- ========== SCREEN: HOME (DASHBOARD) ========== -->
    <div id="homeScreen" class="screen active">
      <h2>Dashboard Home</h2>
       <!-- Optional: Add breadcrumbs here -->
       <!-- <div id="breadcrumbs" style="margin-bottom: 15px; font-size: 0.9em; color: var(--secondary-color);">Home</div> -->

      <!-- Grafik Keterlambatan Bulanan -->
      <div class="dashboard-section">
        <div class="dashboard-card">
          <h3>Grafik Keterlambatan Siswa (Bulan Terakhir)</h3>
          <div id="chartLatenessLineContainer">
            <canvas id="chartLatenessLine" style="max-inline-size:100%;"></canvas>
            <div class="loader-container" style="display: none;">
                <div class="loader"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top 5 Siswa dengan Keterlambatan Terbanyak -->
      <div class="dashboard-section">
        <div class="dashboard-card">
          <h3>Top 5 Siswa Sering Terlambat (Total)</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Nama Siswa</th>
                  <th>Total Keterlambatan</th>
                </tr>
              </thead>
              <tbody id="dashboardTop5TableBody">
                 <tr><td colspan="3" style="text-align:center;">Memuat data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: INPUT ABSENSI ========== -->
    <div id="absensiScreen" class="screen">
      <h2>Form Absensi</h2>
      <div id="absensiStatusBox" class="status-box info" style="display:none;"></div>
      <form id="absensiForm">
        <div class="input-group">
            <label for="namaSiswa">Nama Siswa:</label>
            <input type="text" id="namaSiswa" list="siswaList" required>
            <datalist id="siswaList">
              <!-- Options will be filled by JavaScript -->
            </datalist>
        </div>

        <div class="input-group">
            <label for="tanggalAbsen">Tanggal:</label>
            <input type="date" id="tanggalAbsen" required>
             <small id="holidayWarning" style="color: red; display:none; margin-top: 5px;">Tanggal terpilih adalah hari libur.</small>
        </div>

        <div class="input-group">
            <label for="statusKedatangan">Status Kedatangan:</label>
            <select id="statusKedatangan" required>
              <option value="">-- Pilih Status --</option>
              <option value="late">Terlambat</option>
              <option value="izin">Izin</option>
              <option value="sakit">Sakit</option> <!-- NEW STATUS -->
              <option value="alpha">Alpha</option> <!-- NEW STATUS -->
              <option value="dipulangkan">Dipulangkan</option>
            </select>
        </div>

        <!-- NEW FEATURE: Input Waktu Keterlambatan -->
        <div id="waktuTerlambatContainer" class="input-group" style="display:none;">
            <label for="waktuTerlambat">Waktu Kedatangan (Jika Terlambat):</label>
            <input type="time" id="waktuTerlambat">
        </div>

        <!-- NEW FEATURE: Detail Status Sakit -->
         <div id="sakitDetailContainer" class="input-group" style="display:none;">
            <label>Detail Sakit:</label>
             <div class="radio-group">
                 <div class="radio-item">
                     <input type="radio" id="sakitSurat" name="sakitDetail" value="surat">
                     <label for="sakitSurat">Dengan Surat Dokter</label>
                 </div>
                 <div class="radio-item">
                     <input type="radio" id="sakitTanpaSurat" name="sakitDetail" value="tanpa_surat" checked> <!-- Default -->
                     <label for="sakitTanpaSurat">Tanpa Surat Dokter</label>
                 </div>
             </div>
        </div>

        <div class="input-group">
            <label for="dropdownAlasan">Alasan (Jika Terlambat/Izin/Sakit):</label> <!-- Added Sakit -->
            <select id="dropdownAlasan">
              <option value="">-- Pilih Alasan Umum --</option>
              <option value="Bangun kesiangan">Bangun kesiangan</option>
              <option value="Macet/Transportasi bermasalah">Macet/Transportasi bermasalah</option>
              <option value="Alasan kesehatan (sakit ringan)">Alasan kesehatan (sakit ringan)</option>
              <option value="Menemani keluarga yang membutuhkan">Menemani keluarga yang membutuhkan</option>
              <option value="Lupa membawa peralatan sekolah">Lupa membawa peralatan sekolah</option>
              <option value="Cuaca ekstrem (hujan/banjir)">Cuaca ekstrem (hujan/banjir)</option>
              <option value="Urusan keluarga mendadak">Urusan keluarga mendadak</option>
              <option value="Lainnya">Lainnya (Isi di bawah)</option>
            </select>
        </div>

        <div id="alasanCustomContainer" class="input-group" style="display:none;">
          <label for="alasanCustom">Alasan Lainnya / Detail:</label>
          <input type="text" id="alasanCustom" placeholder="Tulis alasan lainnya atau detail...">
        </div>

        <div class="form-actions">
            <button type="submit" id="btnCatatAbsensi" class="btn btn-primary">Catat Absensi</button>
        </div>
      </form>
    </div>

    <!-- ========== NEW FEATURE: SCREEN: INPUT BULK ABSENSI ========== -->
    <div id="bulkAbsensiScreen" class="screen">
        <h2>Input Absensi Bulk</h2>
        <form id="bulkAbsensiForm">
             <div class="input-group">
                <label for="bulkTanggalAbsen">Tanggal:</label>
                <input type="date" id="bulkTanggalAbsen" required>
                <small id="bulkHolidayWarning" style="color: red; display:none; margin-top: 5px;">Tanggal terpilih adalah hari libur.</small>
            </div>

            <div class="input-group">
                <label for="bulkStatusKedatangan">Status Kedatangan (Sama untuk Semua):</label>
                <select id="bulkStatusKedatangan" required>
                  <option value="">-- Pilih Status --</option>
                  <option value="late">Terlambat</option>
                  <option value="izin">Izin</option>
                  <option value="sakit">Sakit</option>
                  <option value="alpha">Alpha</option>
                  <option value="dipulangkan">Dipulangkan</option>
                </select>
            </div>

             <!-- Optional: Common Time for 'late' status -->
             <div id="bulkWaktuTerlambatContainer" class="input-group" style="display:none;">
                 <label for="bulkWaktuTerlambat">Waktu Kedatangan (Jika Terlambat):</label>
                 <input type="time" id="bulkWaktuTerlambat">
             </div>
              <!-- Optional: Common Sakit Detail -->
             <div id="bulkSakitDetailContainer" class="input-group" style="display:none;">
                <label>Detail Sakit:</label>
                <div class="radio-group">
                    <div class="radio-item">
                         <input type="radio" id="bulkSakitSurat" name="bulkSakitDetail" value="surat">
                         <label for="bulkSakitSurat">Dengan Surat Dokter</label>
                     </div>
                     <div class="radio-item">
                         <input type="radio" id="bulkSakitTanpaSurat" name="bulkSakitDetail" value="tanpa_surat" checked>
                         <label for="bulkSakitTanpaSurat">Tanpa Surat Dokter</label>
                     </div>
                 </div>
             </div>


             <div class="input-group">
                <label for="bulkDropdownAlasan">Alasan Umum (Sama untuk Semua, Opsional):</label>
                <select id="bulkDropdownAlasan">
                  <option value="">-- Tidak Ada Alasan Umum --</option>
                  <option value="Bangun kesiangan">Bangun kesiangan</option>
                  <option value="Macet/Transportasi bermasalah">Macet/Transportasi bermasalah</option>
                  <option value="Alasan kesehatan (sakit ringan)">Alasan kesehatan (sakit ringan)</option>
                  <option value="Menemani keluarga yang membutuhkan">Menemani keluarga yang membutuhkan</option>
                  <option value="Lupa membawa peralatan sekolah">Lupa membawa peralatan sekolah</option>
                  <option value="Cuaca ekstrem (hujan/banjir)">Cuaca ekstrem (hujan/banjir)</option>
                  <option value="Urusan keluarga mendadak">Urusan keluarga mendadak</option>
                   <option value="Lainnya">Lainnya (Isi di bawah)</option>
                </select>
            </div>
             <div id="bulkAlasanCustomContainer" class="input-group" style="display:none;">
                <label for="bulkAlasanCustom">Alasan Lainnya / Detail (Sama untuk Semua):</label>
                <input type="text" id="bulkAlasanCustom" placeholder="Tulis alasan lainnya atau detail...">
            </div>

            <div class="input-group">
                <label>Pilih Siswa:</label>
                <input type="search" id="bulkSearchSiswa" placeholder="Cari siswa untuk ditambahkan..." style="margin-bottom: 10px;">
                <div id="bulkAbsensiSiswaList">
                    <!-- Checkboxes for students loaded by JS -->
                    Memuat daftar siswa...
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="btnCatatBulkAbsensi" class="btn btn-primary">Catat Absensi Bulk</button>
            </div>
        </form>
    </div>


    <!-- ========== SCREEN: DATA KETERLAMBATAN ========== -->
    <div id="terlambatScreen" class="screen">
      <h2>Data Akumulasi Keterlambatan Siswa</h2>
        <!-- Filters -->
        <div class="filter-section">
          <h3>Filter Keterlambatan</h3>
          <div class="filter-controls">
              <div>
                <label for="searchKeterlambatan">Cari Nama:</label>
                <input type="search" id="searchKeterlambatan" placeholder="Cari Nama Siswa...">
              </div>
              <!-- NEW FEATURE: Filter by Kelas -->
              <div>
                <label for="filterKelasKeterlambatan">Filter Kelas:</label>
                <select id="filterKelasKeterlambatan">
                    <option value="">Semua Kelas</option>
                    <!-- Options populated by JS -->
                </select>
              </div>
              <!-- NEW FEATURE: Filter by Count Range -->
              <div>
                <label>Filter Jumlah:</label>
                <input type="number" id="filterMinLateness" placeholder="Min" min="0" style="inline-size: 70px;">
                -
                <input type="number" id="filterMaxLateness" placeholder="Max" min="0" style="inline-size: 70px;">
              </div>
              <div>
                 <button id="btnApplyKeterlambatanFilter" class="btn btn-secondary btn-sm">Filter</button>
                 <button id="btnResetKeterlambatanFilter" class="btn btn-warning btn-sm">Reset</button>
              </div>
          </div>
           <div id="keterlambatanFilterResult" style="display:none; margin-top:15px;" class="status-box info"></div>
        </div>

        <button id="btnResetSemuaKeterlambatan" class="btn btn-danger">Reset Semua Keterlambatan (Jadi 0)</button>
      <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-sort-column="nama">Nama <span class="sort-icon"></span></th>
                <th class="sortable" data-sort-column="kelas">Kelas <span class="sort-icon"></span></th> <!-- Added Kelas Column -->
                <th class="sortable" data-sort-column="terlambat_total">Terlambat Total <span class="sort-icon"></span></th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="dataKeterlambatanTable">
                <tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr> <!-- Updated colspan -->
            </tbody>
          </table>
        </div>
    </div>

    <!-- ========== SCREEN: HISTORY ========== -->
    <div id="historyScreen" class="screen">
      <h2>Riwayat Absensi</h2>
      <div class="filter-section">
        <h3>Filter Riwayat</h3>
        <div class="filter-controls">
             <div>
                <label for="searchHistory">Cari Teks:</label>
                <input type="search" id="searchHistory" placeholder="Nama, Alasan, Pengisi...">
             </div>
             <!-- NEW FEATURE: Filter by Kelas -->
             <div>
                 <label for="filterKelasHistory">Filter Kelas:</label>
                 <select id="filterKelasHistory">
                     <option value="">Semua Kelas</option>
                     <!-- Options populated by JS -->
                 </select>
             </div>
            <div>
                <label for="filterDate">Filter Harian:</label>
                <input type="date" id="filterDate">
            </div>
            <div>
                <label for="filterStartDate">Rentang Tanggal:</label>
                <input type="date" id="filterStartDate" placeholder="Tgl Mulai">
                <input type="date" id="filterEndDate" placeholder="Tgl Akhir" style="margin-block-start: 5px;">
            </div>
             <div>
                <label for="filterStatus">Filter Status:</label>
                <select id="filterStatus">
                    <option value="">Semua Status</option>
                    <option value="late">Terlambat</option>
                    <option value="izin">Izin</option>
                    <option value="sakit">Sakit</option> <!-- Added -->
                    <option value="alpha">Alpha</option> <!-- Added -->
                    <option value="dipulangkan">Dipulangkan</option>
                </select>
            </div>
             <div style="flex-basis: 100%; text-align: end;"> <!-- Buttons on new line -->
                 <button id="btnApplyHistoryFilter" class="btn btn-secondary">Terapkan Filter</button>
                 <button id="btnResetHistoryFilters" class="btn btn-warning">Reset Filter</button>
            </div>
        </div>
        <div id="filterResult" style="display:none; margin-block-start:15px;" class="status-box info">
        </div>
      </div>

      <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-sort-column="tanggal">Tanggal <span class="sort-icon"></span></th>
                <th class="sortable" data-sort-column="nama">Nama Siswa <span class="sort-icon"></span></th>
                 <th class="sortable" data-sort-column="kelas">Kelas <span class="sort-icon"></span></th> <!-- Added Kelas Column -->
                <th>Status</th>
                <th>Waktu</th> <!-- Added Waktu Column -->
                <th>Alasan</th>
                <th>Pengisi (Guru)</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
                <tr><td colspan="8" style="text-align:center;">Memuat data...</td></tr> <!-- Updated colspan -->
            </tbody>
          </table>
        </div>
    </div>

    <!-- ========== SCREEN: STATISTIK ========== -->
    <div id="statistikScreen" class="screen">
      <h2>Statistik Absensi & Keterlambatan</h2>
      <div class="filter-section">
         <div class="filter-controls">
            <div>
              <label for="chartOption">Pilih Grafik:</label>
              <select id="chartOption">
                <option value="siswa_telat">Top Siswa Sering Telat</option>
                <option value="alasan_telat">Top Alasan Keterlambatan</option>
                <option value="tren_harian_telat">Tren Harian Keterlambatan (Bulan)</option>
                <option value="tren_kelas_telat">Keterlambatan per Kelas (Bulan)</option> <!-- NEW -->
                <option value="tren_hari_telat">Keterlambatan per Hari (Bulan)</option> <!-- NEW -->
                <option value="status_bulanan">Distribusi Status Absensi (Bulan)</option> <!-- NEW -->
                <option value="banding_bulan">Perbandingan Keterlambatan Antar Bulan</option> <!-- NEW -->
                <!-- Add more options for Sakit/Alpha analysis -->
              </select>
            </div>
            <div>
              <label for="statistikBulan">Pilih Bulan:</label>
              <input type="month" id="statistikBulan">
            </div>
             <!-- NEW: Inputs for comparison -->
             <div id="compareMonthContainer" style="display: none;">
                 <label for="statistikBulanCompare">Bandingkan Dengan Bulan:</label>
                 <input type="month" id="statistikBulanCompare">
             </div>
             <!-- NEW: Filter by Class for some charts -->
             <div id="chartKelasFilterContainer" style="display: none;">
                 <label for="chartFilterKelas">Filter Kelas (Opsional):</label>
                 <select id="chartFilterKelas">
                     <option value="">Semua Kelas</option>
                      <!-- Options populated by JS -->
                 </select>
             </div>
            <div>
                <button id="btnRenderChart" class="btn btn-primary">Tampilkan</button>
            </div>
          </div>
      </div>

      <div id="chartStatisticContainer">
          <canvas id="chartStatistic" style="max-inline-size:100%; margin-block-start:30px; min-height: 350px;"></canvas>
           <div class="loader-container" style="display: none;">
                <div class="loader"></div>
           </div>
           <!-- NEW: Container for text-based analysis -->
           <div id="textAnalysisContainer" style="margin-top: 20px; padding: 15px; background-color: var(--nav-item-bg-color); border-radius: 5px; display:none;">
                <h4>Analisis Tambahan:</h4>
                <p id="analysisContent">Memuat analisis...</p>
           </div>
      </div>

      <div id="downloadSection" style="margin-block-start:30px; display:none;">
        <button id="btnDownloadMonthly" class="btn btn-success">Download Data Bulan Terpilih (Excel)</button>
        <!-- Optional: Button to download chart as image -->
         <button id="btnDownloadChart" class="btn btn-secondary">Download Grafik (PNG)</button>
      </div>
    </div>

    <!-- ========== SCREEN: SETTINGS ========== -->
    <div id="settingsScreen" class="screen">
      <h2>Pengaturan</h2>

      <!-- Petugas Piket Guru -->
      <div class="setting-section" style="margin-block-end:30px;">
        <h3>Petugas Piket Guru (Harian, Max 10)</h3>
        <form id="formTambahGuru" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
          <div style="flex: 1 1 200px;">
            <label for="guruNama">Nama Guru:</label>
            <input type="text" id="guruNama" placeholder="Contoh: Pak Andi" required>
          </div>
          <div style="flex: 1 1 150px;">
            <label for="guruHari">Hari Piket:</label>
            <select id="guruHari" required>
              <option value="">-- Pilih Hari --</option>
              <option value="Senin">Senin</option>
              <option value="Selasa">Selasa</option>
              <option value="Rabu">Rabu</option>
              <option value="Kamis">Kamis</option>
              <option value="Jumat">Jumat</option>
              <option value="Sabtu">Sabtu</option>
            </select>
          </div>
          <div>
            <button type="submit" id="btnTambahGuru" class="btn btn-primary">Tambah Guru</button>
          </div>
        </form>
        <div class="table-container">
            <table>
              <thead> <tr><th>Nama Guru</th><th>Hari</th><th>Aksi</th></tr> </thead>
              <tbody id="petugasGuruTable">
                   <tr><td colspan="3" style="text-align:center;">Memuat data...</td></tr>
              </tbody>
            </table>
        </div>
      </div>

      <hr style="margin: 30px 0; border-color: var(--input-border-color);">

      <!-- Petugas Piket Siswa -->
      <div class="setting-section" style="margin-block-end:30px;">
        <h3>Petugas Piket Siswa (2 Orang)</h3>
        <form id="formSimpanSiswaPiket" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
          <div style="flex: 1 1 200px;">
            <label for="siswa1">Siswa 1:</label>
            <input type="text" id="siswa1" list="siswaList" placeholder="Ketik nama siswa..." required>
          </div>
          <div style="flex: 1 1 200px;">
            <label for="siswa2">Siswa 2:</label>
            <input type="text" id="siswa2" list="siswaList" placeholder="Ketik nama siswa..." required>
          </div>
          <div>
            <button type="submit" id="btnSimpanPetugasSiswa" class="btn btn-primary">Simpan Siswa</button>
          </div>
        </form>
         <div id="currentPetugasSiswaDisplay">
             <h4>Petugas Siswa Saat Ini:</h4>
             <ul id="settingsSiswaList" style="list-style-type: disc; padding-inline-start: 20px;">
                  <li>Memuat...</li>
             </ul>
         </div>
      </div>

      <hr style="margin: 30px 0; border-color: var(--input-border-color);">

       <!-- NEW FEATURE: Kalender Sekolah / Hari Libur -->
      <div class="setting-section" style="margin-block-end:30px;">
          <h3>Kelola Hari Libur</h3>
          <form id="formTambahHariLibur" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
              <div style="flex: 1 1 150px;">
                  <label for="liburTanggal">Tanggal Libur:</label>
                  <input type="date" id="liburTanggal" required>
              </div>
              <div style="flex: 1 1 250px;">
                  <label for="liburKeterangan">Keterangan:</label>
                  <input type="text" id="liburKeterangan" placeholder="Contoh: Libur Nasional Maulid Nabi" required>
              </div>
              <div>
                  <button type="submit" id="btnTambahHariLibur" class="btn btn-primary">Tambah Libur</button>
              </div>
          </form>
          <div class="table-container">
              <table>
                  <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Aksi</th></tr></thead>
                  <tbody id="hariLiburTable">
                      <tr><td colspan="3" style="text-align:center;">Memuat data hari libur...</td></tr>
                  </tbody>
              </table>
          </div>
      </div>

       <hr style="margin: 30px 0; border-color: var(--input-border-color);">

      <!-- Pengaturan Lainnya -->
      <div class="setting-section">
        <h3>Pengaturan Lainnya</h3>
         <div style="background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
            <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: center; margin-block-end:15px;">
              <div style="flex:1;">
                <label for="languageSelect">Pilih Bahasa:</label>
                <select id="languageSelect" disabled>
                  <option value="id">Bahasa Indonesia</option>
                  <option value="en">English (Belum Tersedia)</option>
                </select>
              </div>
               <!-- Theme setting moved to header toggle -->
              <div style="align-self: flex-end;">
                <button class="btn btn-secondary" onclick="showNotification('Tidak ada pengaturan lain untuk disimpan.', 'info')">Simpan Pengaturan</button>
              </div>
            </div>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: PROFILE ========== -->
    <div id="profileScreen" class="screen">
      <h2>Profil Petugas & Pengisi</h2>
      <div class="dashboard-card" style="margin-block-end: 30px; background-color: var(--nav-item-bg-color);">
        <p style="font-size: 1.1rem;">Total Data Absensi Tercatat (Aktif + Arsip): <strong id="profileAbsensiCount">Memuat...</strong></p>
      </div>

      <!-- Daftar Petugas Guru -->
      <div class="profile-section" style="margin-block-end:30px;">
        <h3>Daftar Petugas Guru (Urutan Senin–Sabtu)</h3>
        <div class="table-container">
            <table>
              <thead> <tr><th>Hari</th><th>Nama Guru</th><th>Aksi</th></tr> </thead>
              <tbody id="profileGuruTbody">
                  <tr><td colspan="3" style="text-align:center;">Memuat data...</td></tr>
              </tbody>
            </table>
        </div>
      </div>

      <!-- Daftar Petugas Siswa -->
      <div class="profile-section" style="margin-block-end:30px;">
        <h3>Daftar Petugas Siswa Saat Ini (2 Orang)</h3>
        <ul id="profileSiswaList" style="list-style-type: disc; padding-inline-start: 20px; font-size: 1.1rem;">
             <li>Memuat...</li>
        </ul>
      </div>

      <!-- Pengisi Hari Ini -->
      <div class="profile-section">
        <h3>Pengisi Absensi Hari Ini</h3>
        <div style="background-color: var(--nav-item-bg-color); padding: 20px; border-radius: 8px;">
            <p>Hari ini: <strong id="hariAktualSpan">-</strong></p>
            <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-start:10px;">
              <div style="flex:1;">
                <label for="dropdownPengisi">Pilih Guru Pengisi (Sesuai Jadwal Piket Hari Ini):</label>
                <select id="dropdownPengisi">
                  <option value="">Memuat guru...</option>
                </select>
              </div>
              <div>
                <button id="btnSetPengisi" class="btn btn-primary">Set Sebagai Pengisi</button>
              </div>
            </div>
            <p style="margin-block-start:20px; font-weight: bold;">Pengisi Saat Ini: <strong id="currentPengisiSpan">-</strong></p> <!-- Color set by JS -->
        </div>
      </div>

      <!-- Modal untuk Mengedit Guru Piket (Shared with Settings) -->
      <div id="editGuruModal" class="modal">
        <div class="modal-content">
          <span class="close" id="editGuruModalClose">&times;</span>
          <h3>Edit Guru Piket</h3>
          <form id="editGuruForm">
            <input type="hidden" id="editGuruId">
            <div class="input-group"> <label for="editGuruNama">Nama Guru:</label> <input type="text" id="editGuruNama" required> </div>
             <div class="input-group"> <label for="editGuruHari">Hari Piket:</label> <select id="editGuruHari" required> <option value="">-- Pilih Hari --</option> <option value="Senin">Senin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Kamis">Kamis</option> <option value="Jumat">Jumat</option> <option value="Sabtu">Sabtu</option> </select> </div>
            <div class="modal-actions"> <button type="button" id="editGuruModalCancel" class="btn btn-secondary">Batal</button> <button type="submit" id="btnSimpanEditGuru" class="btn btn-primary">Simpan Perubahan</button> </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: DATA SISWA ========== -->
    <div id="dataSiswaScreen" class="screen">
      <h2>Manajemen Data Siswa</h2>

      <!-- Form Tambah Siswa -->
      <div style="margin-block-end:30px; background-color: var(--nav-item-bg-color); padding: 20px; border-radius: 8px;">
        <h3>Tambah Siswa Baru</h3>
        <form id="formTambahSiswa">
          <div style="display:flex; flex-wrap:wrap; gap:15px;">
            <div style="flex:1; min-inline-size: 150px;"> <label for="dataSiswaNama">Nama Siswa:</label> <input type="text" id="dataSiswaNama" placeholder="Nama Lengkap" required> </div>
            <div style="flex:1; min-inline-size: 100px;"> <label for="dataSiswaKelas">Kelas:</label> <input type="text" id="dataSiswaKelas" placeholder="Contoh: 10 IPA 1" required> </div>
            <div style="flex:1; min-inline-size: 100px;"> <label for="dataSiswaNIS">NIS:</label> <input type="text" id="dataSiswaNIS" placeholder="Nomor Induk Siswa" required> </div>
            <div style="flex:1; min-inline-size: 150px;"> <label for="dataSiswaWaliKelas">Wali Kelas:</label> <input type="text" id="dataSiswaWaliKelas" placeholder="Nama Wali Kelas" required> </div>
          </div>
          <button type="submit" id="btnTambahSiswa" class="btn btn-primary" style="margin-block-start:15px;">Tambah Siswa</button>
        </form>
      </div>

      <!-- Import Data Siswa -->
      <div style="margin-block-end:30px; background-color: var(--nav-item-bg-color); padding: 20px; border-radius: 8px;">
        <h3>Import Data Siswa dari Excel</h3>
        <p style="font-size: 0.9em; color: #666; margin-block-end: 10px;">File Excel harus memiliki header: `Nama`, `Kelas`, `NIS`, `WaliKelas` (sesuai urutan).</p>
        <input type="file" id="importFileSiswa" accept=".xlsx, .xls">
        <button id="btnImportDataSiswa" class="btn btn-success" style="margin-block-start:10px;">Import Data</button>
      </div>

      <!-- Tombol Aksi Tabel -->
      <div style="margin-block-end:20px;">
         <input type="search" id="searchDataSiswaTable" placeholder="Cari di tabel..." class="search-bar" style="max-inline-size: 300px; margin-inline-end: 10px;">
        <button id="btnHapusPilihSiswa" class="btn btn-warning">Hapus Siswa Terpilih</button>
        <button id="btnHapusSemuaSiswa" class="btn btn-danger">Hapus SEMUA Siswa</button>
      </div>

      <!-- Tabel Data Siswa -->
      <div class="table-container">
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllSiswa"></th>
                <th class="sortable" data-sort-column="nama">Nama Siswa <span class="sort-icon"></span></th>
                <th class="sortable" data-sort-column="kelas">Kelas <span class="sort-icon"></span></th>
                <th class="sortable" data-sort-column="nis">NIS <span class="sort-icon"></span></th>
                <th class="sortable" data-sort-column="waliKelas">Wali Kelas <span class="sort-icon"></span></th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="dataSiswaTable">
                <tr><td colspan="6" style="text-align:center;">Memuat data...</td></tr>
            </tbody>
          </table>
       </div>
    </div>

     <!-- ========== NEW FEATURE: SCREEN: BANTUAN ========== -->
     <div id="helpScreen" class="screen">
         <h2>Bantuan Penggunaan Aplikasi</h2>

         <div class="help-section">
             <h3>Navigasi</h3>
             <p>Gunakan menu navigasi di bagian atas untuk berpindah antar halaman utama:</p>
             <ul>
                 <li><strong>Home:</strong> Tampilan dashboard ringkasan.</li>
                 <li><strong>Input Absensi:</strong> Form untuk mencatat absensi harian per siswa.</li>
                 <li><strong>Input Bulk:</strong> Form untuk mencatat absensi beberapa siswa sekaligus dengan status yang sama.</li>
                 <li><strong>Data Keterlambatan:</strong> Tabel akumulasi jumlah keterlambatan per siswa.</li>
                 <li><strong>History:</strong> Riwayat semua catatan absensi yang pernah diinput.</li>
                 <li><strong>Statistik:</strong> Visualisasi data absensi dan keterlambatan dalam bentuk grafik.</li>
                 <li><strong>Settings:</strong> Pengaturan petugas piket guru, siswa, dan hari libur.</li>
                 <li><strong>Profile:</strong> Informasi petugas piket saat ini dan pengaturan pengisi absensi.</li>
                 <li><strong>Data Siswa:</strong> Manajemen data induk siswa (tambah, edit, hapus, import).</li>
                 <li><strong>Bantuan:</strong> Halaman ini.</li>
             </ul>
             <p>Tombol <i class="fas fa-sun"></i>/<i class="fas fa-moon"></i> di kanan atas untuk mengganti tema tampilan (terang/gelap).</p>
         </div>

         <div class="help-section">
             <h3>Input Absensi (Single)</h3>
             <ol>
                 <li>Pilih nama siswa dari daftar atau ketikkan namanya.</li>
                 <li>Pilih tanggal absensi (otomatis hari ini, bisa diubah). Hindari memilih hari libur.</li>
                 <li>Pilih Status Kedatangan (Terlambat, Izin, Sakit, Alpha, Dipulangkan).</li>
                 <li>Jika 'Terlambat', opsional isi Waktu Kedatangan.</li>
                 <li>Jika 'Sakit', pilih detail 'Dengan Surat' atau 'Tanpa Surat'.</li>
                 <li>Jika status memerlukan alasan (Terlambat, Izin, Sakit), pilih Alasan Umum atau pilih 'Lainnya' dan ketik alasan di kotak di bawahnya.</li>
                 <li>Klik 'Catat Absensi'.</li>
             </ol>
             <p><strong>Penting:</strong> Pastikan 'Pengisi Saat Ini' di halaman Profile sudah diatur ke nama Anda sebelum mencatat.</p>
         </div>

          <div class="help-section">
             <h3>Input Absensi (Bulk)</h3>
             <ol>
                 <li>Pilih tanggal absensi.</li>
                 <li>Pilih Status Kedatangan yang sama untuk semua siswa yang akan dipilih.</li>
                 <li>Isi Waktu (jika telat) atau Detail Sakit/Alasan jika diperlukan (akan berlaku sama untuk semua).</li>
                 <li>Cari dan centang nama siswa yang ingin dicatat di daftar bawah.</li>
                 <li>Klik 'Catat Absensi Bulk'.</li>
             </ol>
              <p>Fitur ini berguna jika beberapa siswa memiliki status dan alasan yang sama pada hari yang sama.</p>
         </div>

         <div class="help-section">
             <h3>Melihat Data</h3>
             <ul>
                 <li><strong>Data Keterlambatan:</strong> Menampilkan total berapa kali siswa terlambat. Klik nama siswa untuk detail. Gunakan filter di atas tabel untuk mencari atau menyaring berdasarkan kelas/jumlah.</li>
                 <li><strong>History:</strong> Menampilkan semua riwayat absensi. Gunakan filter untuk mencari berdasarkan teks, kelas, tanggal, atau status. Klik nama siswa untuk detail.</li>
                 <li><strong>Statistik:</strong> Pilih jenis grafik dan periode waktu (bulan) untuk melihat visualisasi data. Beberapa grafik memungkinkan filter tambahan (misal, per kelas).</li>
                 <li><strong>Detail Siswa:</strong> Muncul saat nama siswa diklik di tabel Keterlambatan atau History. Menampilkan info lengkap dan riwayat khusus siswa tersebut.</li>
             </ul>
         </div>

         <div class="help-section">
            <h3>Pengaturan (Settings)</h3>
             <ul>
                 <li><strong>Petugas Guru:</strong> Tambah, edit, atau hapus guru yang bertugas piket harian.</li>
                 <li><strong>Petugas Siswa:</strong> Atur 2 siswa yang bertugas piket.</li>
                 <li><strong>Hari Libur:</strong> Tambahkan tanggal-tanggal libur sekolah/nasional untuk validasi input tanggal.</li>
             </ul>
         </div>

          <div class="help-section">
            <h3>Tips</h3>
             <ul>
                 <li>Gunakan fitur 'Import Data Siswa' di halaman Data Siswa untuk memasukkan banyak siswa dari file Excel (.xlsx). Pastikan format header sesuai petunjuk.</li>
                 <li>Manfaatkan filter dan pencarian di tabel History dan Keterlambatan untuk menemukan data dengan cepat.</li>
                 <li>Periksa dashboard (Home) secara berkala untuk melihat tren dan siswa yang sering terlambat.</li>
                 <li>Pastikan data petugas piket dan pengisi di halaman Profile selalu terbarui.</li>
             </ul>
         </div>

     </div>


  </div> <!-- End Container -->

  <!-- FOOTER -->
  <footer>
    <div class="footer-line"></div>
    <p>
      Created by <br>
      Antonius Elga Kurnia, S.Pd.
    </p>
  </footer>

  <!-- JAVASCRIPT -->
  <script>
    // --- AWAL TAMBAHAN INISIALISASI MANUAL ---
    // TODO: Ganti placeholder di bawah ini dengan konfigurasi proyek Firebase Anda!
    // Anda bisa mendapatkannya dari Firebase Console:
    // Project settings > General > Your apps > SDK setup and configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBOIKO90GdqhRFisZIgK1B8DmYHfMrhp9k",
      authDomain: "absensiketerlambatanapp-10d87.firebaseapp.com",
      projectId: "absensiketerlambatanapp-10d87",
      storageBucket: "absensiketerlambatanapp-10d87.appspot.com", // Suffix .appspot.com biasanya benar
      messagingSenderId: "1049369715348",
      appId: "1:1049369715348:web:d2d3333fbaaaeeccba8a81"
      // measurementId: "G-7X7SYZZ3W1" // Opsional, jika menggunakan Analytics
    };

    // Initialize Firebase
    if (!firebase.apps.length) { // Hindari inisialisasi ganda
       firebase.initializeApp(firebaseConfig);
       console.log("Firebase Initialized Manually from Config.");
    } else {
       firebase.app(); // Gunakan app yang sudah ada
       console.log("Firebase already initialized.");
    }
    // --- AKHIR TAMBAHAN INISIALISASI MANUAL ---


    /********************************************************
     *                ELEMENT REFERENCES
     ********************************************************/
     // ... (Referensi elemen Anda tetap sama seperti di kode sebelumnya) ...
    // Modals & Close Buttons
    const editGuruModal = document.getElementById('editGuruModal');
    const confirmModal = document.getElementById('confirmModal');
    const siswaDetailModal = document.getElementById('siswaDetailModal'); // New
    const confirmModalMessage = document.getElementById('confirmModalMessage');
    const confirmModalConfirm = document.getElementById('confirmModalConfirm');
    const confirmModalCancel = document.getElementById('confirmModalCancel');
    const confirmModalClose = document.getElementById('confirmModalClose');
    const editGuruModalClose = document.getElementById('editGuruModalClose');
    const editGuruModalCancel = document.getElementById('editGuruModalCancel');
    const siswaDetailModalClose = document.getElementById('siswaDetailModalClose'); // New
    const siswaDetailModalCloseBtn = document.getElementById('siswaDetailModalCloseBtn'); // New

    // Notification Area - Deklarasi di global scope
    let notificationArea; // <<< FIX: Deklarasi dengan let, tanpa assignment awal

    // Screens
    const screens = document.querySelectorAll('.screen');

    // Navigation & Theme
    const mainNav = document.getElementById('mainNav');
    const navItems = mainNav.querySelectorAll('.nav-item');
    const themeToggleButton = document.getElementById('themeToggle'); // New

    // Home Screen
    const chartLatenessLineContainer = document.getElementById('chartLatenessLineContainer');
    const chartLatenessLineCanvas = document.getElementById('chartLatenessLine');
    const dashboardTop5TableBody = document.getElementById('dashboardTop5TableBody');

    // Absensi Screen (Single Input)
    const absensiForm = document.getElementById('absensiForm');
    const namaSiswaInput = document.getElementById('namaSiswa');
    const siswaDataList = document.getElementById('siswaList');
    const tanggalAbsenInput = document.getElementById('tanggalAbsen');
    const holidayWarning = document.getElementById('holidayWarning'); // New
    const statusKedatanganSelect = document.getElementById('statusKedatangan');
    const waktuTerlambatContainer = document.getElementById('waktuTerlambatContainer'); // New
    const waktuTerlambatInput = document.getElementById('waktuTerlambat'); // New
    const sakitDetailContainer = document.getElementById('sakitDetailContainer'); // New
    const dropdownAlasanSelect = document.getElementById('dropdownAlasan');
    const alasanCustomContainer = document.getElementById('alasanCustomContainer');
    const alasanCustomInput = document.getElementById('alasanCustom');
    const absensiStatusBox = document.getElementById('absensiStatusBox');
    const btnCatatAbsensi = document.getElementById('btnCatatAbsensi');

     // Absensi Screen (Bulk Input) - NEW
     const bulkAbsensiForm = document.getElementById('bulkAbsensiForm');
     const bulkTanggalAbsenInput = document.getElementById('bulkTanggalAbsen');
     const bulkHolidayWarning = document.getElementById('bulkHolidayWarning');
     const bulkStatusKedatanganSelect = document.getElementById('bulkStatusKedatangan');
     const bulkWaktuTerlambatContainer = document.getElementById('bulkWaktuTerlambatContainer');
     const bulkWaktuTerlambatInput = document.getElementById('bulkWaktuTerlambat');
     const bulkSakitDetailContainer = document.getElementById('bulkSakitDetailContainer');
     const bulkDropdownAlasanSelect = document.getElementById('bulkDropdownAlasan');
     const bulkAlasanCustomContainer = document.getElementById('bulkAlasanCustomContainer');
     const bulkAlasanCustomInput = document.getElementById('bulkAlasanCustom');
     const bulkSearchSiswaInput = document.getElementById('bulkSearchSiswa');
     const bulkAbsensiSiswaListDiv = document.getElementById('bulkAbsensiSiswaList');
     const btnCatatBulkAbsensi = document.getElementById('btnCatatBulkAbsensi');


    // Keterlambatan Screen
    const dataKeterlambatanTableBody = document.getElementById('dataKeterlambatanTable');
    const btnResetSemuaKeterlambatan = document.getElementById('btnResetSemuaKeterlambatan');
    const searchKeterlambatanInput = document.getElementById('searchKeterlambatan');
    const filterKelasKeterlambatanSelect = document.getElementById('filterKelasKeterlambatan'); // New
    const filterMinLatenessInput = document.getElementById('filterMinLateness'); // New
    const filterMaxLatenessInput = document.getElementById('filterMaxLateness'); // New
    const btnApplyKeterlambatanFilter = document.getElementById('btnApplyKeterlambatanFilter'); // New
    const btnResetKeterlambatanFilter = document.getElementById('btnResetKeterlambatanFilter'); // New
    const keterlambatanFilterResultDiv = document.getElementById('keterlambatanFilterResult'); // New


    // History Screen
    const historyTableBody = document.getElementById('historyTableBody');
    const filterDateInput = document.getElementById('filterDate');
    const btnFilterDate = document.getElementById('btnFilterDate'); // Kept for potential individual use, but consolidated filter button is better
    const filterStartDateInput = document.getElementById('filterStartDate');
    const filterEndDateInput = document.getElementById('filterEndDate');
    const btnFilterDateRange = document.getElementById('btnFilterDateRange'); // Kept
    const btnResetHistoryFilters = document.getElementById('btnResetHistoryFilters');
    const filterResultDiv = document.getElementById('filterResult');
    const searchHistoryInput = document.getElementById('searchHistory');
    const filterStatusSelect = document.getElementById('filterStatus');
    const filterKelasHistorySelect = document.getElementById('filterKelasHistory'); // New
    const btnFilterStatus = document.getElementById('btnFilterStatus'); // Kept
    const btnApplyHistoryFilter = document.getElementById('btnApplyHistoryFilter'); // New consolidated filter button


    // Statistik Screen
    const chartOptionSelect = document.getElementById('chartOption');
    const statistikBulanInput = document.getElementById('statistikBulan');
    const compareMonthContainer = document.getElementById('compareMonthContainer'); // New
    const statistikBulanCompareInput = document.getElementById('statistikBulanCompare'); // New
    const chartKelasFilterContainer = document.getElementById('chartKelasFilterContainer'); // New
    const chartFilterKelasSelect = document.getElementById('chartFilterKelas'); // New
    const btnRenderChart = document.getElementById('btnRenderChart');
    const chartStatisticContainer = document.getElementById('chartStatisticContainer');
    const chartStatisticCanvas = document.getElementById('chartStatistic');
    const textAnalysisContainer = document.getElementById('textAnalysisContainer'); // New
    const analysisContentP = document.getElementById('analysisContent'); // New
    const downloadSectionDiv = document.getElementById('downloadSection');
    const btnDownloadMonthly = document.getElementById('btnDownloadMonthly');
    const btnDownloadChart = document.getElementById('btnDownloadChart'); // New


    // Settings Screen
    const formTambahGuru = document.getElementById('formTambahGuru');
    const guruNamaInput = document.getElementById('guruNama');
    const guruHariSelect = document.getElementById('guruHari');
    const btnTambahGuru = document.getElementById('btnTambahGuru');
    const petugasGuruTableBody = document.getElementById('petugasGuruTable');
    const formSimpanSiswaPiket = document.getElementById('formSimpanSiswaPiket');
    const siswa1Input = document.getElementById('siswa1');
    const siswa2Input = document.getElementById('siswa2');
    const btnSimpanPetugasSiswa = document.getElementById('btnSimpanPetugasSiswa');
    const settingsSiswaList = document.getElementById('settingsSiswaList');
    const formTambahHariLibur = document.getElementById('formTambahHariLibur'); // New
    const liburTanggalInput = document.getElementById('liburTanggal'); // New
    const liburKeteranganInput = document.getElementById('liburKeterangan'); // New
    const btnTambahHariLibur = document.getElementById('btnTambahHariLibur'); // New
    const hariLiburTableBody = document.getElementById('hariLiburTable'); // New


    // Profile Screen
    const profileAbsensiCountSpan = document.getElementById('profileAbsensiCount');
    const profileGuruTbody = document.getElementById('profileGuruTbody');
    const profileSiswaList = document.getElementById('profileSiswaList');
    const hariAktualSpan = document.getElementById('hariAktualSpan');
    const dropdownPengisiSelect = document.getElementById('dropdownPengisi');
    const btnSetPengisi = document.getElementById('btnSetPengisi');
    const currentPengisiSpan = document.getElementById('currentPengisiSpan');
    const editGuruForm = document.getElementById('editGuruForm');
    const editGuruIdInput = document.getElementById('editGuruId');
    const editGuruNamaInput = document.getElementById('editGuruNama');
    const editGuruHariSelect = document.getElementById('editGuruHari');
    const btnSimpanEditGuru = document.getElementById('btnSimpanEditGuru');


    // Data Siswa Screen
    const formTambahSiswa = document.getElementById('formTambahSiswa');
    const dataSiswaNamaInput = document.getElementById('dataSiswaNama');
    const dataSiswaKelasInput = document.getElementById('dataSiswaKelas');
    const dataSiswaNISInput = document.getElementById('dataSiswaNIS');
    const dataSiswaWaliKelasInput = document.getElementById('dataSiswaWaliKelas');
    const btnTambahSiswa = document.getElementById('btnTambahSiswa');
    const importFileSiswaInput = document.getElementById('importFileSiswa');
    const btnImportDataSiswa = document.getElementById('btnImportDataSiswa');
    const btnHapusSemuaSiswa = document.getElementById('btnHapusSemuaSiswa');
    const btnHapusPilihSiswa = document.getElementById('btnHapusPilihSiswa');
    const dataSiswaTableBody = document.getElementById('dataSiswaTable');
    const selectAllSiswaCheckbox = document.getElementById('selectAllSiswa');
    const searchDataSiswaTableInput = document.getElementById('searchDataSiswaTable');

    // Siswa Detail Modal Elements - NEW
    const detailNamaSiswaSpan = document.getElementById('detailNamaSiswa');
    const detailKelasSiswaSpan = document.getElementById('detailKelasSiswa');
    const detailNisSiswaSpan = document.getElementById('detailNisSiswa');
    const detailWaliKelasSiswaSpan = document.getElementById('detailWaliKelasSiswa');
    const detailTotalTerlambatSpan = document.getElementById('detailTotalTerlambat');
    const detailTotalIzinSpan = document.getElementById('detailTotalIzin');
    const detailTotalSakitSpan = document.getElementById('detailTotalSakit');
    const detailTotalAlphaSpan = document.getElementById('detailTotalAlpha');
    const siswaDetailHistoryTableBody = document.getElementById('siswaDetailHistoryTableBody');



    /********************************************************
     *                GLOBAL VAR & STATE
     ********************************************************/
    let currentScreen = "homeScreen";
    let db; // Firebase Firestore instance - akan diisi di initializeFirebase

    // ... (Data Arrays, Chart Objects, Sorting State, Filtering State, Constants tetap sama) ...
     // Data Arrays
     let petugasGuru = []; // {id, nama, hari}
     let petugasSiswa = []; // array of strings [nama1, nama2]
     let currentPengisi = "";
     let historyAbsensi = []; // {id, nama, tanggal, status, alasan, pengisi, waktu?, kelas?, statusDetail?} - Added optional fields
     let archiveAbsensi = []; // same structure as history
     let databaseSiswa = []; // {id, nama, kelas, nis, waliKelas, latenessResetDate?}
     let dataKeterlambatan = []; // {nama, kelas, terlambat_total} - Added kelas
     let hariLibur = []; // {id, tanggal, keterangan} - New

     // Chart Objects
     let chartObj = null;
     let latenessLineChart = null;

     // Sorting State
     let historySort = { column: 'tanggal', direction: 'desc' };
     let siswaSort = { column: 'nama', direction: 'asc' };
     let keterlambatanSort = { column: 'terlambat_total', direction: 'desc' };

     // Filtering State (for tables)
     let currentHistoryFilters = {};
     let currentKeterlambatanFilters = {};

     // Other constants
     const dayOrder = ["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
     const lateThreshold = 3; // Configurable threshold


    /********************************************************
     *             NOTIFICATION & MODAL SYSTEM
     ********************************************************/
    // MODIFIED: showNotification includes check for notificationArea
    function showNotification(message, type = 'info', duration = 4000) {
        // FIX: Check if notificationArea is valid before using it
        if (!notificationArea) {
            console.error("Notification area not found! Cannot show notification:", message);
            // Optionally, use a simple alert as fallback
            // alert(`[${type.toUpperCase()}] ${message}`);
            return;
        }
        const toast = document.createElement('div');
        toast.classList.add('toast', `toast-${type}`);
        toast.textContent = message;
        notificationArea.appendChild(toast); // Now this should work

        setTimeout(() => { toast.classList.add('show'); }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, { once: true });
        }, duration);
    }

    // ... (showConfirmModal, closeConfirmModal, showSiswaDetailModal, closeSiswaDetailModal tetap sama) ...
    let currentConfirmCallback = null;
    function showConfirmModal(message, onConfirm) {
        currentConfirmCallback = onConfirm;
        confirmModalMessage.textContent = message;
        confirmModal.style.display = 'flex';
    }
    function closeConfirmModal() {
        confirmModal.style.display = 'none';
        currentConfirmCallback = null;
    }
    confirmModalConfirm.addEventListener('click', () => {
        if (typeof currentConfirmCallback === 'function') currentConfirmCallback();
        closeConfirmModal();
    });
    confirmModalCancel.addEventListener('click', closeConfirmModal);
    confirmModalClose.addEventListener('click', closeConfirmModal);

     // --- NEW: Siswa Detail Modal ---
     function showSiswaDetailModal(namaSiswa) {
         const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === namaSiswa.toLowerCase());
         const keterlambatanData = dataKeterlambatan.find(k => k.nama.toLowerCase() === namaSiswa.toLowerCase());
         const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
         const siswaHistory = combinedHistory
                                .filter(rec => rec.nama.toLowerCase() === namaSiswa.toLowerCase())
                                .sort((a,b) => b.tanggal.localeCompare(a.tanggal)); // Sort descending

         if (!siswa) {
             showNotification(`Data siswa "${namaSiswa}" tidak ditemukan.`, "error");
             return;
         }

         // Populate Info
         detailNamaSiswaSpan.textContent = siswa.nama;
         detailKelasSiswaSpan.textContent = siswa.kelas;
         detailNisSiswaSpan.textContent = siswa.nis;
         detailWaliKelasSiswaSpan.textContent = siswa.waliKelas;
         detailTotalTerlambatSpan.textContent = keterlambatanData?.terlambat_total || 0;
         // Calculate other totals
         detailTotalIzinSpan.textContent = siswaHistory.filter(r => r.status === 'izin').length;
         detailTotalSakitSpan.textContent = siswaHistory.filter(r => r.status === 'sakit').length;
         detailTotalAlphaSpan.textContent = siswaHistory.filter(r => r.status === 'alpha').length;


         // Populate History Table
         siswaDetailHistoryTableBody.innerHTML = ""; // Clear
         if (siswaHistory.length === 0) {
             siswaDetailHistoryTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Tidak ada riwayat absensi.</td></tr>';
         } else {
             siswaHistory.forEach(rec => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                     <td>${rec.tanggal}</td>
                     <td>${capitalizeFirstLetter(rec.status)} ${rec.statusDetail ? '('+rec.statusDetail.replace('_',' ')+')' : ''}</td>
                     <td>${rec.status === 'late' ? (rec.waktu || '-') : '-'}</td>
                     <td>${rec.alasan || "-"}</td>
                     <td>${rec.pengisi || "-"}</td>
                 `;
                 siswaDetailHistoryTableBody.appendChild(tr);
             });
         }

         siswaDetailModal.style.display = 'flex';
     }

     function closeSiswaDetailModal() {
         siswaDetailModal.style.display = 'none';
     }
     siswaDetailModalClose.addEventListener('click', closeSiswaDetailModal);
     siswaDetailModalCloseBtn.addEventListener('click', closeSiswaDetailModal);
     siswaDetailModal.addEventListener('click', (event) => { // Close on outside click
        if (event.target === siswaDetailModal) closeSiswaDetailModal();
     });


    /********************************************************
     *             FIREBASE INITIALIZATION & CRUD
     ********************************************************/
     // MODIFIED: initializeFirebase uses the globally initialized app
     function initializeFirebase() {
        // Firebase app is initialized manually at the top of the script
        // This function now just gets the Firestore instance
        try {
            if (!firebase || !firebase.apps.length) {
                throw new Error("Firebase belum diinisialisasi dengan benar.");
            }
            db = firebase.firestore();
            console.log("Firebase Firestore reference obtained.");

            // Test connection (optional)
            db.collection('settings').doc('connectivityTest').set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() })
               .then(() => console.log("Firestore connection test successful."))
               .catch(err => console.error("Firestore connection test failed:", err));

            loadAllData(); // Start loading data after getting reference
        } catch (error) {
            console.error("Getting Firestore reference failed:", error);
            showNotification("Koneksi ke database gagal. Pastikan konfigurasi Firebase benar. Cek konsol.", "error", 10000);
        }
    }


    // ... (loadAllData, loadCollection, loadCurrentPengisi, setupRealtimeListeners, handleSnapshot, handleSnapshotError, initialRender, CRUD functions, etc. tetap sama) ...
    async function loadAllData() {
        if (!db) {
            console.error("Firestore DB not initialized!");
            showNotification("Database tidak siap.", "error");
            return;
        }
        showNotification("Memuat data awal...", "info", 2000);
        try {
            await Promise.all([
                loadCollection('historyAbsensi', (data) => { historyAbsensi = data; }),
                loadCollection('archiveAbsensi', (data) => { archiveAbsensi = data; }),
                loadCollection('petugasGuru', (data) => { petugasGuru = data; }),
                loadCollection('petugasSiswa', (data) => { petugasSiswa = data.map(item => item.nama); }),
                loadCollection('databaseSiswa', (data) => { databaseSiswa = data; }),
                loadCollection('hariLibur', (data) => { hariLibur = data; }), // Load holidays
                loadCurrentPengisi()
            ]);

            console.log("Semua data awal dimuat.");
            showNotification("Data berhasil dimuat.", "success", 2000);

            recalcDataKeterlambatan();
            setupRealtimeListeners();
            initialRender();
            archiveWeeklyData();

        } catch (error) {
            console.error("Error memuat data awal:", error);
            showNotification("Gagal memuat semua data. Cek konsol.", "error", 10000);
        }
    }

    async function loadCollection(collectionName, setDataCallback) {
        try {
            const snapshot = await db.collection(collectionName).get();
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDataCallback(data);
             console.log(`Loaded ${data.length} items from ${collectionName}`);
        } catch (err) {
             console.error(`Error loading collection ${collectionName}:`, err);
             // Don't halt everything, but notify
             showNotification(`Gagal memuat data ${collectionName}.`, "warning");
             setDataCallback([]); // Reset to empty array on error
        }
    }

    async function loadCurrentPengisi() {
         try {
            const doc = await db.collection('currentPengisi').doc('pengisi').get();
            currentPengisi = doc.exists ? doc.data().nama : "";
            console.log(`Loaded current Pengisi: ${currentPengisi || 'None'}`);
         } catch (err) {
             console.error("Error loading current pengisi:", err);
             currentPengisi = ""; // Default on error
         }
    }


    function setupRealtimeListeners() {
        // Existing listeners...
        db.collection('historyAbsensi').onSnapshot(handleSnapshot('historyAbsensi', (data) => { historyAbsensi = data; }), handleSnapshotError);
        db.collection('archiveAbsensi').onSnapshot(handleSnapshot('archiveAbsensi', (data) => { archiveAbsensi = data; }), handleSnapshotError);
        db.collection('petugasGuru').onSnapshot(handleSnapshot('petugasGuru', (data) => { petugasGuru = data; renderPetugasGuruTable(); renderProfileGuru(); renderProfilePengisiToday(); }), handleSnapshotError);
        db.collection('petugasSiswa').onSnapshot(handleSnapshot('petugasSiswa', (data) => { petugasSiswa = data.map(d => d.nama); renderProfileSiswa(); renderSettingsSiswaList(); }), handleSnapshotError);
        db.collection('databaseSiswa').onSnapshot(handleSnapshot('databaseSiswa', (data) => { databaseSiswa = data; renderDataSiswaTable(); renderDataSiswaList(); populateClassFilters(); populateBulkSiswaList(); }), handleSnapshotError); // Added calls
        db.collection('currentPengisi').doc('pengisi').onSnapshot(doc => {
            currentPengisi = doc.exists ? doc.data().nama : "";
            console.log("Current Pengisi updated:", currentPengisi || 'None');
            renderProfilePengisiToday();
        }, handleSnapshotError);
         // NEW: Listener for holidays
         db.collection('hariLibur').onSnapshot(handleSnapshot('hariLibur', (data) => { hariLibur = data; renderHariLiburTable(); checkDateInputHoliday(tanggalAbsenInput, holidayWarning); checkDateInputHoliday(bulkTanggalAbsenInput, bulkHolidayWarning); }), handleSnapshotError); // Added calls
    }

    function handleSnapshot(collectionName, setDataCallback) {
        return (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDataCallback(data);
            console.log(`Realtime update for ${collectionName}: ${data.length} items`);

            // Trigger necessary recalculations and re-renders
             const needsRecalc = ['historyAbsensi', 'archiveAbsensi', 'databaseSiswa'];
             const needsHistoryRender = ['historyAbsensi', 'archiveAbsensi', 'databaseSiswa', 'hariLibur']; // Re-render history if holidays change relevant markers? Maybe not needed.
             const needsKeterlambatanRender = ['historyAbsensi', 'archiveAbsensi', 'databaseSiswa'];
             const needsHomeRender = ['historyAbsensi', 'archiveAbsensi', 'databaseSiswa'];
             const needsProfileRender = ['historyAbsensi', 'archiveAbsensi']; // For counts
             const needsSiswaRender = ['databaseSiswa'];

             if (needsRecalc.includes(collectionName)) {
                 recalcDataKeterlambatan();
             }
             if (needsHistoryRender.includes(collectionName) && currentScreen === 'historyScreen') {
                  applyHistoryFiltersAndRender(); // Use combined filter function
             }
             if (needsKeterlambatanRender.includes(collectionName) && currentScreen === 'terlambatScreen') {
                  applyKeterlambatanFiltersAndRender(); // Use combined filter function
             }
             if (needsHomeRender.includes(collectionName) && currentScreen === 'homeScreen') {
                 renderHome();
             }
              if (needsProfileRender.includes(collectionName) && currentScreen === 'profileScreen') {
                 updateProfileInfo();
             }
             if (needsSiswaRender.includes(collectionName)) {
                 if (currentScreen === 'dataSiswaScreen') renderDataSiswaTable();
                 renderDataSiswaList();
                 populateClassFilters();
                 populateBulkSiswaList();
             }
              // Specific updates (like petugasGuru) handled directly in setupRealtimeListeners
        };
    }

    function handleSnapshotError(error) {
        console.error("Firestore listener error:", error);
        showNotification("Kesalahan update data real-time.", "error");
    }

    function initialRender() {
        renderDataSiswaList();
        populateClassFilters(); // Populate filters early
        populateBulkSiswaList(); // Populate bulk list
        renderPetugasGuruTable();
        renderSettingsSiswaList();
        renderHariLiburTable(); // Render holidays
        renderProfileGuru();
        renderProfileSiswa();
        renderProfilePengisiToday();
        updateProfileInfo();
        renderDataSiswaTable();
        renderDataKeterlambatanTable();
        renderHistoryTable();
        renderHome();
         setInitialTheme(); // Apply saved theme
    }

     async function addData(collectionName, data, successMessage, buttonElement = null) {
        let originalButtonText = '';
        if (buttonElement) {
            originalButtonText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Menyimpan... <span class="spinner"></span>';
        }
        try {
            const docRef = await db.collection(collectionName).add(data);
            showNotification(successMessage || `Data berhasil ditambahkan ke ${collectionName}.`, 'success');
            return docRef; // Return the document reference if needed
        } catch (error) {
            console.error(`Error adding data to ${collectionName}:`, error);
            showNotification(`Gagal menambahkan data ke ${collectionName}. Cek konsol.`, 'error');
            throw error; // Re-throw error for specific handling if needed
        } finally {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonText;
            }
        }
    }

    // Generic function to update data
    async function updateData(collectionName, docId, data, successMessage, buttonElement = null) {
        let originalButtonText = '';
        if (buttonElement) {
            originalButtonText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Memperbarui... <span class="spinner"></span>';
        }
        try {
            await db.collection(collectionName).doc(docId).update(data);
            showNotification(successMessage || `Data di ${collectionName} berhasil diperbarui.`, 'success');
        } catch (error) {
            console.error(`Error updating data in ${collectionName} (ID: ${docId}):`, error);
            showNotification(`Gagal memperbarui data di ${collectionName}. Cek konsol.`, 'error');
            throw error;
        } finally {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonText;
            }
        }
    }

     // Generic function to delete data
    async function deleteData(collectionName, docId, successMessage) {
        try {
            await db.collection(collectionName).doc(docId).delete();
            showNotification(successMessage || `Data dari ${collectionName} berhasil dihapus.`, 'success');
        } catch (error) {
            console.error(`Error deleting data from ${collectionName} (ID: ${docId}):`, error);
            showNotification(`Gagal menghapus data dari ${collectionName}. Cek konsol.`, 'error');
            throw error;
        }
    }

     // Generic function to find documents based on criteria
     async function findDocuments(collectionName, field, value) {
        try {
            const snapshot = await db.collection(collectionName).where(field, '==', value).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error(`Error finding documents in ${collectionName} where ${field} == ${value}:`, error);
            showNotification(`Gagal mencari data di ${collectionName}.`, 'error');
            return []; // Return empty array on error
        }
    }


     // Specific function to get unique classes - NEW
     function getUniqueKelas() {
        const kelasSet = new Set(databaseSiswa.map(s => s.kelas));
        return Array.from(kelasSet).sort(); // Return sorted array
     }

     // Populate class filter dropdowns - NEW
     function populateClassFilters() {
         const uniqueKelas = getUniqueKelas();
         const selects = [filterKelasHistorySelect, filterKelasKeterlambatanSelect, chartFilterKelasSelect];

         selects.forEach(select => {
             if (!select) return; // Check if element exists
             // Preserve the first option ("Semua Kelas")
             const firstOption = select.options[0];
             select.innerHTML = ''; // Clear existing options except the first
             select.appendChild(firstOption);

             uniqueKelas.forEach(kelas => {
                 const option = document.createElement('option');
                 option.value = kelas;
                 option.textContent = kelas;
                 select.appendChild(option);
             });
         });
     }


    // Weekly Archiving Logic (remains the same)
    async function archiveWeeklyData() {
        try {
            const settingsDoc = await db.collection('settings').doc('archiveDate').get();
            const lastArchiveTimestamp = settingsDoc.exists ? settingsDoc.data().lastArchiveDate : null;
            const lastArchiveDate = lastArchiveTimestamp ? lastArchiveTimestamp.toDate() : null;
            const today = new Date();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;

            if (!lastArchiveDate) {
                await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
                console.log("Set initial archive date.");
                return;
            }

            if (today.getTime() - lastArchiveDate.getTime() >= oneWeek) {
                 showNotification("Memulai proses arsip data mingguan...", "info");
                 let batch = db.batch(); // Use let for re-assignment
                 let movedCount = 0;
                 let writeCount = 0;
                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch(); // Start new batch
                     writeCount = 0;
                 };

                 const startOfThisWeek = new Date(today);
                 startOfThisWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                 startOfThisWeek.setHours(0, 0, 0, 0);

                 const historyToArchiveSnapshot = await db.collection('historyAbsensi')
                     .where('tanggal', '<', startOfThisWeek.toISOString().split('T')[0])
                     .get();

                 historyToArchiveSnapshot.forEach(doc => {
                     const record = doc.data();
                     const archiveRef = db.collection('archiveAbsensi').doc();
                     batch.set(archiveRef, record);
                     batch.delete(doc.ref);
                     movedCount++;
                     writeCount++;
                     if (writeCount >= 490) commitBatch(); // Commit periodically within loop
                 });

                 if (writeCount > 0) await commitBatch(); // Commit remaining writes


                 if (movedCount > 0) {
                     await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
                     showNotification(`${movedCount} data absensi lama telah diarsipkan.`, "success");
                     console.log(`Archived ${movedCount} records.`);
                 } else {
                     console.log("Tidak ada data absensi lama untuk diarsipkan saat ini.");
                     await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
                 }
            } else {
                 console.log("Belum saatnya arsip mingguan.");
            }
        } catch (error) {
            console.error("Error mengarsipkan data mingguan:", error);
            showNotification("Gagal melakukan arsip data mingguan.", "error");
        }
     }



    /********************************************************
     *                NAVIGATION & SCREEN MANAGEMENT
     ********************************************************/
     // showScreen and updateActiveNav remain mostly the same, but need to handle new screens
    function showScreen(screenId) {
        screens.forEach(screen => screen.classList.remove('active'));
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) targetScreen.classList.add('active');
        currentScreen = screenId;
        updateActiveNav(screenId);
        // updateBreadcrumbs(screenId); // NEW: Update breadcrumbs

        // Trigger specific renders/updates
        switch (screenId) {
            case 'homeScreen': renderHome(); break;
            case 'bulkAbsensiScreen': populateBulkSiswaList(); break; // Ensure list is populated
            case 'terlambatScreen': applyKeterlambatanFiltersAndRender(); break; // Render with filters
            case 'historyScreen': applyHistoryFiltersAndRender(); break; // Render with filters
            case 'profileScreen': updateProfileInfo(); renderProfileGuru(); renderProfileSiswa(); renderProfilePengisiToday(); break;
            case 'settingsScreen': renderPetugasGuruTable(); renderSettingsSiswaList(); renderHariLiburTable(); break;
            case 'dataSiswaScreen': renderDataSiswaTable(); break;
            case 'statistikScreen':
                // Reset chart/analysis view
                if (chartObj) { chartObj.destroy(); chartObj = null; }
                // if (latenessLineChart) { latenessLineChart.destroy(); latenessLineChart = null; } // Don't destroy dashboard chart
                chartStatisticContainer.querySelector('.loader-container').style.display = 'none';
                chartStatisticCanvas.style.display = 'block';
                textAnalysisContainer.style.display = 'none';
                downloadSectionDiv.style.display = "none";
                handleChartOptionChange(); // Adjust UI based on default chart option
                break;
             case 'helpScreen': /* No specific action needed */ break;
        }
         window.scrollTo(0, 0);
    }

    function updateActiveNav(screenId) {
        navItems.forEach(item => {
            item.classList.remove('active');
            // Improved matching logic
            const targetIdSuffix = screenId.replace('Screen', '');
            const navIdSuffix = item.id.replace('nav', '');
            if (navIdSuffix.toLowerCase() === targetIdSuffix.toLowerCase()) {
                item.classList.add('active');
            }
        });
    }

    // setupNavListeners remains the same
    function setupNavListeners() {
        navItems.forEach(item => {
            const screenId = item.id.replace('nav', '') + 'Screen';
            // Make sure first letter is lowercase for the ID lookup
            const correctedScreenId = screenId.charAt(0).toLowerCase() + screenId.slice(1);
             if (document.getElementById(correctedScreenId)) { // Check if screen exists
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showScreen(correctedScreenId);
                });
             } else {
                 console.warn(`Screen ID ${correctedScreenId} not found for nav item ${item.id}`);
             }
        });
     }

    // NEW: Breadcrumbs (Simple Example)
    // function updateBreadcrumbs(screenId) {
    //     const breadcrumbDiv = document.getElementById('breadcrumbs');
    //     if (!breadcrumbDiv) return;
    //     const screenName = screenId.replace('Screen', '');
    //     // Basic mapping - can be more complex for sub-views
    //     const paths = { home: 'Home', absensi: 'Home / Input Absensi', ... };
    //     breadcrumbDiv.textContent = paths[screenName.toLowerCase()] || 'Home';
    // }


    /********************************************************
     *     PETUGAS GURU (Settings & Profile)
     ********************************************************/
     // tambahPetugasGuruHandler, renderPetugasGuruTable, hapusPetugasGuru,
     // openEditGuruModal, closeEditGuruModal, handleEditGuruSubmit
     // Event listeners for edit/delete remain the same...
      async function tambahPetugasGuruHandler(event) {
        event.preventDefault(); // Prevent form submission
        const nama = guruNamaInput.value.trim();
        const hari = guruHariSelect.value;

        if (!nama || !hari) {
            showNotification("Nama & Hari piket guru tidak boleh kosong!", "warning");
            return;
        }
        if (petugasGuru.length >= 10) {
            showNotification("Maksimal 10 guru piket dapat ditambahkan.", "warning");
            return;
        }
        // Check for duplicate: same name on the same day
        const dupe = petugasGuru.some(g => g.nama.toLowerCase() === nama.toLowerCase() && g.hari === hari);
        if (dupe) {
            showNotification(`Guru "${nama}" sudah terdaftar untuk hari ${hari}!`, "warning");
            return;
        }

        const guruData = { nama, hari };
        try {
            await addData('petugasGuru', guruData, `Guru "${nama}" (${hari}) berhasil ditambahkan.`, btnTambahGuru);
            formTambahGuru.reset(); // Clear the form fields
            // Data will be re-rendered by the snapshot listener
        } catch (error) {
            // Error notification handled by addData
        }
       }
      function renderPetugasGuruTable() {
        petugasGuruTableBody.innerHTML = ""; // Clear previous content
        if (petugasGuru.length === 0) {
            petugasGuruTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data guru piket.</td></tr>';
            return;
        }

        // Sort by day order then name for consistent display
        const sortedGuru = [...petugasGuru].sort((a, b) => {
            const dayDiff = dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari);
            if (dayDiff !== 0) return dayDiff;
            return a.nama.localeCompare(b.nama);
        });

        sortedGuru.forEach((item) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${item.nama}</td>
            <td>${item.hari}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-guru" data-id="${item.id}">Edit</button>
                <button class="btn btn-danger btn-sm btn-hapus-guru" data-id="${item.id}" data-nama="${item.nama}">Hapus</button>
            </td>
            `;
            petugasGuruTableBody.appendChild(tr);
        });
       }
      async function hapusPetugasGuru(guruId, guruNama) {
            showConfirmModal(`Yakin ingin menghapus guru piket "${guruNama}"?`, async () => {
                try {
                    await deleteData('petugasGuru', guruId, `Guru piket "${guruNama}" berhasil dihapus.`);
                    // Data re-rendered by listener
                    // If this teacher was the current 'pengisi', clear it
                    if (currentPengisi === guruNama) {
                        await setPengisi(""); // Clear pengisi
                    }
                } catch (error) {
                    // Notification handled by deleteData
                }
            });
       }
      function openEditGuruModal(guruId) {
            const guru = petugasGuru.find(g => g.id === guruId);
            if (!guru) {
                showNotification("Data guru tidak ditemukan.", "error");
                return;
            }
            editGuruIdInput.value = guru.id;
            editGuruNamaInput.value = guru.nama;
            editGuruHariSelect.value = guru.hari;
            editGuruModal.style.display = "flex";
       }
      function closeEditGuruModal() {
            editGuruModal.style.display = "none";
            editGuruForm.reset(); // Clear form on close
       }
      async function handleEditGuruSubmit(event) {
            event.preventDefault();
            const guruId = editGuruIdInput.value;
            const nama = editGuruNamaInput.value.trim();
            const hari = editGuruHariSelect.value;
            const originalGuru = petugasGuru.find(g => g.id === guruId);


            if (!nama || !hari) {
                showNotification("Nama & Hari piket guru tidak boleh kosong!", "warning");
                return;
            }
            // Check for duplicate only if name or day changed
            if (nama !== originalGuru.nama || hari !== originalGuru.hari) {
                const dupe = petugasGuru.some(g => g.nama.toLowerCase() === nama.toLowerCase() && g.hari === hari && g.id !== guruId);
                if (dupe) {
                    showNotification(`Kombinasi guru "${nama}" dan hari "${hari}" sudah ada!`, "warning");
                    return;
                }
            }


            try {
                await updateData('petugasGuru', guruId, { nama, hari }, `Data guru "${nama}" berhasil diperbarui.`, btnSimpanEditGuru);
                closeEditGuruModal();
                // If the edited teacher was the current 'pengisi' and name changed, update pengisi
                if (currentPengisi === originalGuru.nama && currentPengisi !== nama) {
                    await setPengisi(nama);
                } else {
                    renderProfilePengisiToday(); // Re-render dropdown in case day changed
                }
                // Table re-rendered by listener
            } catch (error) {
                // Notification handled by updateData
            }
       }
      // Event delegation listeners remain the same
        petugasGuruTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('btn-edit-guru')) {
                openEditGuruModal(event.target.dataset.id);
            }
            if (event.target.classList.contains('btn-hapus-guru')) {
                hapusPetugasGuru(event.target.dataset.id, event.target.dataset.nama);
            }
        });

        profileGuruTbody.addEventListener('click', (event) => {
            if (event.target.classList.contains('btn-edit-guru')) {
                openEditGuruModal(event.target.dataset.id);
            }
            if (event.target.classList.contains('btn-hapus-guru')) {
                hapusPetugasGuru(event.target.dataset.id, event.target.dataset.nama);
            }
        });


        editGuruForm.addEventListener('submit', handleEditGuruSubmit);
        editGuruModalClose.addEventListener('click', closeEditGuruModal);
        editGuruModalCancel.addEventListener('click', closeEditGuruModal);
        // Close modal if clicking outside content
        editGuruModal.addEventListener('click', (event) => {
            if (event.target === editGuruModal) {
                closeEditGuruModal();
            }
        });



    /********************************************************
     *     PETUGAS SISWA (Settings & Profile)
     ********************************************************/
     // simpanPetugasSiswaHandler, renderSettingsSiswaList remain the same
     async function simpanPetugasSiswaHandler(event) {
         event.preventDefault();
         const s1 = siswa1Input.value.trim();
         const s2 = siswa2Input.value.trim();

         if (!s1 || !s2) {
             showNotification("Harap isi nama kedua siswa piket!", "warning");
             return;
         }
          if (s1.toLowerCase() === s2.toLowerCase()) {
             showNotification("Nama siswa piket tidak boleh sama.", "warning");
             return;
         }

         // Validate if students exist in databaseSiswa
         const siswa1Exists = databaseSiswa.some(s => s.nama.toLowerCase() === s1.toLowerCase());
         const siswa2Exists = databaseSiswa.some(s => s.nama.toLowerCase() === s2.toLowerCase());

         if (!siswa1Exists || !siswa2Exists) {
             let missing = [];
             if (!siswa1Exists) missing.push(s1);
             if (!siswa2Exists) missing.push(s2);
             showNotification(`Siswa "${missing.join('" dan "')}" tidak ditemukan di database. Harap tambahkan dulu di menu Data Siswa.`, "error", 6000);
             return;
         }

         const newPetugasSiswa = [s1, s2];
         const btn = btnSimpanPetugasSiswa;
         let originalText = btn.innerHTML;
         btn.disabled = true;
         btn.innerHTML = 'Menyimpan... <span class="spinner"></span>';

         try {
             // Clear existing petugasSiswa collection first
             const existingSnapshot = await db.collection('petugasSiswa').get();
             const batch = db.batch();
             existingSnapshot.forEach(doc => {
                 batch.delete(doc.ref);
             });
             await batch.commit(); // Commit deletion first

             // Add new ones
             await Promise.all([
                 db.collection('petugasSiswa').add({ nama: newPetugasSiswa[0] }),
                 db.collection('petugasSiswa').add({ nama: newPetugasSiswa[1] })
             ]);

             showNotification(`Petugas siswa berhasil disimpan: ${newPetugasSiswa.join(" & ")}`, "success");
             // formSimpanSiswaPiket.reset(); // Clear form
             // Data will be updated by listener
         } catch (error) {
             console.error("Error menyimpan petugas siswa:", error);
             showNotification("Gagal menyimpan petugas siswa. Cek konsol.", "error");
         } finally {
             btn.disabled = false;
             btn.innerHTML = originalText;
         }
      }
     function renderSettingsSiswaList() {
        settingsSiswaList.innerHTML = "";
         if (petugasSiswa.length === 0) {
             settingsSiswaList.innerHTML = "<li>Belum ada petugas siswa yang diatur.</li>";
         } else {
             petugasSiswa.forEach(nama => {
                 const li = document.createElement('li');
                 li.textContent = nama;
                 settingsSiswaList.appendChild(li);
             });
             // Optionally pre-fill input fields if needed, though maybe not desirable
             // siswa1Input.value = petugasSiswa[0] || "";
             // siswa2Input.value = petugasSiswa[1] || "";
         }
      }

    /********************************************************
     *     MANAJEMEN SISWA (Data Siswa Screen)
     ********************************************************/
    // ADDED: Clearing search input after successful add/import
    async function tambahSiswaHandler(event) {
        event.preventDefault();
        const nama = dataSiswaNamaInput.value.trim();
        const kelas = dataSiswaKelasInput.value.trim();
        const nis = dataSiswaNISInput.value.trim();
        const waliKelas = dataSiswaWaliKelasInput.value.trim();

        if (!nama || !kelas || !nis || !waliKelas) {
            showNotification("Semua field (Nama, Kelas, NIS, Wali Kelas) wajib diisi!", "warning");
            return;
        }

        const dupe = databaseSiswa.some(s => s.nama.toLowerCase() === nama.toLowerCase() || s.nis === nis);
        if (dupe) {
            showNotification("Siswa dengan Nama atau NIS tersebut sudah ada!", "warning");
            return;
        }

        const siswaData = { nama, kelas, nis, waliKelas };
        try {
            await addData('databaseSiswa', siswaData, `Siswa "${nama}" berhasil ditambahkan.`, btnTambahSiswa);
            formTambahSiswa.reset();
            searchDataSiswaTableInput.value = ''; // <<< FIX: Clear search input
            // Table/Datalist updated by listener
        } catch (error) {
            // Notification handled by addData
        }
     }
    function renderDataSiswaList() {
        siswaDataList.innerHTML = "";
        const sortedSiswa = [...databaseSiswa].sort((a, b) => a.nama.localeCompare(b.nama));
        sortedSiswa.forEach(siswa => {
            const option = document.createElement('option');
            option.value = siswa.nama;
            siswaDataList.appendChild(option);
        });
     }
    async function editSiswa(siswaId) {
        const siswa = databaseSiswa.find(s => s.id === siswaId);
        if (!siswa) {
            showNotification("Data siswa tidak ditemukan untuk diedit.", "error");
            return;
        }

        const newNama = prompt("Masukkan nama baru siswa:", siswa.nama);
        if (newNama === null) return;
        const trimmedNama = newNama.trim();
        if (!trimmedNama) {
            showNotification("Nama tidak boleh kosong!", "warning"); return;
        }

        const newKelas = prompt("Masukkan kelas baru siswa:", siswa.kelas);
        if (newKelas === null) return;
        const trimmedKelas = newKelas.trim();
         if (!trimmedKelas) {
            showNotification("Kelas tidak boleh kosong!", "warning"); return;
        }

        const newNIS = prompt("Masukkan NIS baru siswa:", siswa.nis);
        if (newNIS === null) return;
        const trimmedNIS = newNIS.trim();
         if (!trimmedNIS) {
            showNotification("NIS tidak boleh kosong!", "warning"); return;
        }


        const newWaliKelas = prompt("Masukkan Wali Kelas baru siswa:", siswa.waliKelas);
        if (newWaliKelas === null) return;
        const trimmedWaliKelas = newWaliKelas.trim();
        if (!trimmedWaliKelas) {
            showNotification("Wali Kelas tidak boleh kosong!", "warning"); return;
        }


        if (trimmedNama.toLowerCase() !== siswa.nama.toLowerCase() || trimmedNIS !== siswa.nis) {
            const dupe = databaseSiswa.some(s =>
                s.id !== siswaId && (s.nama.toLowerCase() === trimmedNama.toLowerCase() || s.nis === trimmedNIS)
            );
            if (dupe) {
                showNotification("Siswa dengan Nama atau NIS baru tersebut sudah ada!", "warning");
                return;
            }
        }


        try {
            await updateData('databaseSiswa', siswaId, {
                nama: trimmedNama,
                kelas: trimmedKelas,
                nis: trimmedNIS,
                waliKelas: trimmedWaliKelas
            }, `Data siswa "${trimmedNama}" berhasil diperbarui.`);
            // Table/Datalist updated by listener
        } catch (error) {
            // Notification handled by updateData
        }
     }
    async function hapusSiswa(siswaId, siswaNama, siswaKelas) {
        showConfirmModal(`Yakin ingin menghapus data siswa: ${siswaNama} (${siswaKelas})? Ini juga akan menghapus riwayat absensi & keterlambatan terkait!`, async () => {
            try {
                // 1. Delete from databaseSiswa
                await deleteData('databaseSiswa', siswaId, `Data siswa "${siswaNama}" dihapus.`);

                // 2. Delete related data (run these in parallel)
                const batch = db.batch();

                const historySnapshot = await db.collection('historyAbsensi').where('nama', '==', siswaNama).get();
                historySnapshot.forEach(doc => batch.delete(doc.ref));

                const archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', siswaNama).get();
                archiveSnapshot.forEach(doc => batch.delete(doc.ref));

                // Note: dataKeterlambatan is recalculated, no need to delete directly.

                // Remove from petugasSiswa if present
                const petugasSnapshot = await db.collection('petugasSiswa').where('nama', '==', siswaNama).get();
                petugasSnapshot.forEach(doc => batch.delete(doc.ref));

                 // Remove from siswaDipulangkan if present (assuming collection exists)
                 const dipulangkanSnapshot = await db.collection('siswaDipulangkan').where('nama', '==', siswaNama).get();
                 dipulangkanSnapshot.forEach(doc => batch.delete(doc.ref));


                await batch.commit();
                showNotification(`Riwayat terkait siswa "${siswaNama}" juga dihapus.`, "info");

                // Table/Datalist updated by listener
                 recalcDataKeterlambatan(); // Recalculate lateness counts

            } catch (error) {
                showNotification(`Gagal menghapus data terkait siswa "${siswaNama}".`, "error");
                // Main delete notification handled by deleteData if it failed there
            }
        });
     }
    async function hapusSemuaSiswaHandler() {
        showConfirmModal("PERINGATAN: Anda yakin ingin menghapus SEMUA data siswa, petugas siswa, riwayat absensi, dan keterlambatan? Tindakan ini tidak dapat dibatalkan!", async () => {
            showNotification("Menghapus semua data siswa...", "warning", 10000);
             const btn = btnHapusSemuaSiswa;
             const originalText = btn.innerHTML;
             btn.disabled = true;
             btnHapusPilihSiswa.disabled = true; // Disable other delete btn
             btn.innerHTML = 'Menghapus... <span class="spinner"></span>';

            try {
                const collectionsToDelete = [
                    'databaseSiswa',
                    'petugasSiswa',
                    'historyAbsensi',
                    'archiveAbsensi',
                    'siswaDipulangkan' // Include this if used
                ];
                let batch = db.batch(); // Initialize first batch
                let writeCount = 0;

                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch(); // Start new batch
                     writeCount = 0;
                 };

                 for (const collectionName of collectionsToDelete) {
                    let snapshot;
                    do {
                        snapshot = await db.collection(collectionName).limit(500).get();
                        if (!snapshot.empty) {
                             console.log(`Adding ${snapshot.size} docs from ${collectionName} to delete batch.`);
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                                writeCount++;
                                if(writeCount >= 490) { // Commit before reaching limit
                                    commitBatch();
                                }
                             });
                            // Commit remaining writes in the loop's batch if snapshot was large
                            if(writeCount > 0) await commitBatch();
                        }
                    } while (!snapshot.empty);
                 }

                 // Commit final batch if any writes are pending
                 if(writeCount > 0) await commitBatch();


                showNotification("Semua data siswa dan riwayat terkait telah dihapus!", "success");
                // Arrays will be cleared by listeners, UI updated automatically
                 recalcDataKeterlambatan(); // Reset derived data
                 renderHome(); // Update dashboard

            } catch (error) {
                console.error("Error menghapus semua data siswa:", error);
                showNotification("Gagal menghapus semua data siswa. Cek konsol.", "error", 10000);
            } finally {
                btn.disabled = false;
                btnHapusPilihSiswa.disabled = false;
                btn.innerHTML = originalText;
            }
        });
     }
    async function hapusPilihSiswaHandler() {
        const selectedCheckboxes = dataSiswaTableBody.querySelectorAll('.select-siswa:checked');
        if (selectedCheckboxes.length === 0) {
            showNotification("Pilih minimal satu siswa untuk dihapus.", "warning");
            return;
        }

        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        const selectedNames = selectedIds.map(id => databaseSiswa.find(s => s.id === id)?.nama || 'ID ' + id);


        showConfirmModal(`Yakin ingin menghapus ${selectedIds.length} siswa terpilih (${selectedNames.slice(0,3).join(', ')}...)? Ini juga akan menghapus riwayat terkait!`, async () => {
             const btn = btnHapusPilihSiswa;
             const originalText = btn.innerHTML;
             btn.disabled = true;
             btnHapusSemuaSiswa.disabled = true;
             btn.innerHTML = 'Menghapus... <span class="spinner"></span>';

            try {
                const batch = db.batch();
                let namesToDelete = []; // For deleting related history
                let writeCount = 0;
                const commitBatch = async () => {
                    await batch.commit();
                    batch = db.batch();
                    writeCount = 0;
                };


                for (const siswaId of selectedIds) {
                    const siswaRef = db.collection('databaseSiswa').doc(siswaId);
                    batch.delete(siswaRef); writeCount++;
                    const siswaData = databaseSiswa.find(s => s.id === siswaId);
                     if(siswaData) namesToDelete.push(siswaData.nama);
                     if (writeCount >= 490) await commitBatch(); // Commit periodically
                }

                 // Add related data deletion to the same batch (or new ones if needed)
                 for(const nama of namesToDelete) {
                     const historySnapshot = await db.collection('historyAbsensi').where('nama', '==', nama).get();
                     historySnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });

                     const archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', nama).get();
                     archiveSnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });

                     const petugasSnapshot = await db.collection('petugasSiswa').where('nama', '==', nama).get();
                     petugasSnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });

                      const dipulangkanSnapshot = await db.collection('siswaDipulangkan').where('nama', '==', nama).get();
                     dipulangkanSnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });
                 }

                 // Commit remaining writes
                 if (writeCount > 0) await commitBatch();


                showNotification(`${selectedIds.length} siswa dan data terkait berhasil dihapus.`, "success");
                // Data updated by listeners
                 recalcDataKeterlambatan();
                 renderHome();

            } catch (error) {
                console.error("Error menghapus siswa terpilih:", error);
                showNotification("Gagal menghapus siswa terpilih. Cek konsol.", "error");
            } finally {
                btn.disabled = false;
                btnHapusSemuaSiswa.disabled = false;
                btn.innerHTML = originalText;
            }
        });
     }
    function toggleSelectAllSiswa(sourceCheckbox) {
        const checkboxes = dataSiswaTableBody.querySelectorAll('.select-siswa');
        checkboxes.forEach(cb => cb.checked = sourceCheckbox.checked);
     }
    async function importDataSiswaHandler() {
        const file = importFileSiswaInput.files[0];
        if (!file) {
            showNotification("Silakan pilih file Excel (.xlsx, .xls) terlebih dahulu.", "warning");
            return;
        }

        const btn = btnImportDataSiswa;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Mengimpor... <span class="spinner"></span>';

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length < 2) {
                    showNotification("File Excel kosong atau tidak memiliki data.", "error");
                    return;
                }

                const headers = jsonData[0].map(h => h.trim());
                const requiredHeaders = ["Nama", "Kelas", "NIS", "WaliKelas"];

                const headerIndices = {
                    nama: headers.findIndex(h => h.toLowerCase() === 'nama'),
                    kelas: headers.findIndex(h => h.toLowerCase() === 'kelas'),
                    nis: headers.findIndex(h => h.toLowerCase() === 'nis'),
                    waliKelas: headers.findIndex(h => h.toLowerCase() === 'walikelas')
                };

                if (Object.values(headerIndices).some(index => index === -1)) {
                    showNotification(`Format header Excel tidak sesuai. Harus ada kolom: ${requiredHeaders.join(", ")} (tidak case sensitive).`, "error", 7000);
                    return;
                }

                let importedCount = 0;
                let skippedCount = 0;
                let batch = db.batch(); // Initialize first batch
                let batchSize = 0;
                const currentDbNames = new Set(databaseSiswa.map(s => s.nama.toLowerCase()));
                const currentDbNis = new Set(databaseSiswa.map(s => s.nis));

                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch(); // Start new batch
                     batchSize = 0;
                 };


                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                     if (!row || row.length < requiredHeaders.length || row.every(cell => !cell || String(cell).trim() === '')) {
                        skippedCount++;
                        console.warn(`Skipping row ${i + 1}: Empty or incomplete.`);
                        continue;
                    }

                    const nama = row[headerIndices.nama]?.toString().trim();
                    const kelas = row[headerIndices.kelas]?.toString().trim();
                    const nis = row[headerIndices.nis]?.toString().trim();
                    const waliKelas = row[headerIndices.waliKelas]?.toString().trim();

                    if (!nama || !kelas || !nis || !waliKelas) {
                         console.warn(`Skipping row ${i + 1}: Missing data.`);
                        skippedCount++;
                        continue;
                    }

                    const isDupe = currentDbNames.has(nama.toLowerCase()) || currentDbNis.has(nis);

                     if (isDupe) {
                         console.warn(`Skipping row ${i + 1}: Duplicate Name/NIS found for "${nama}"/"${nis}".`);
                        skippedCount++;
                        continue;
                    }

                    const siswaData = { nama, kelas, nis, waliKelas };
                    const newDocRef = db.collection('databaseSiswa').doc();
                    batch.set(newDocRef, siswaData);
                    batchSize++;
                    importedCount++;

                    currentDbNames.add(nama.toLowerCase());
                    currentDbNis.add(nis);


                    if (batchSize >= 490) {
                         await commitBatch();
                         showNotification(`Mengimpor ${importedCount} data...`, 'info', 1000);
                    }
                }

                // Commit remaining items
                if (batchSize > 0) {
                    await commitBatch();
                }

                let message = "";
                if (importedCount > 0) message += `${importedCount} data siswa berhasil diimpor. `;
                if (skippedCount > 0) message += `${skippedCount} data dilewati (duplikat atau data tidak lengkap).`;
                if (importedCount === 0 && skippedCount === 0) message = "Tidak ada data baru untuk diimpor dari file.";
                showNotification(message, importedCount > 0 ? "success" : "info", 6000);

            } catch (error) {
                console.error("Error mengimpor data siswa:", error);
                showNotification("Gagal memproses file Excel. Pastikan format benar. Cek konsol.", "error", 7000);
            } finally {
                 if (btn) {
                     btn.disabled = false;
                     btn.innerHTML = originalText;
                 }
                importFileSiswaInput.value = "";
                searchDataSiswaTableInput.value = ''; // <<< FIX: Clear search input
                // Table/Datalist updated by listener
            }
        };
        reader.onerror = () => {
             if (btn) {
                 btn.disabled = false;
                 btn.innerHTML = originalText;
             }
             importFileSiswaInput.value = "";
             showNotification("Tidak dapat membaca file.", "error");
        };
        reader.readAsArrayBuffer(file);
     }


     // MODIFIED: renderDataSiswaTable to add clickable name and use internal search
     function renderDataSiswaTable() { // Removed filteredData parameter
        dataSiswaTableBody.innerHTML = "";
        selectAllSiswaCheckbox.checked = false;
        const searchTerm = searchDataSiswaTableInput.value.toLowerCase(); // Get current search term
        let dataToFilter = databaseSiswa;

         // Apply search term filter
         if (searchTerm) {
            dataToFilter = dataToFilter.filter(siswa =>
                 siswa.nama.toLowerCase().includes(searchTerm) ||
                 siswa.kelas.toLowerCase().includes(searchTerm) ||
                 siswa.nis.toLowerCase().includes(searchTerm) ||
                 siswa.waliKelas.toLowerCase().includes(searchTerm)
            );
         }

        const dataToRender = dataToFilter.sort((a,b) => sortData(a,b, siswaSort));
        updateSortIcons(dataSiswaTableBody.closest('table').querySelector('thead'), siswaSort);


        if (dataToRender.length === 0) {
             dataSiswaTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${searchTerm ? 'Tidak ada siswa cocok.' : 'Belum ada data siswa.'}</td></tr>`;
             return;
        }

        dataToRender.forEach((siswa) => {
            const tr = document.createElement('tr');
            tr.dataset.id = siswa.id;
            tr.innerHTML = `
            <td><input type="checkbox" class="select-siswa" value="${siswa.id}"></td>
            <td><span class="clickable-name" data-nama="${siswa.nama}" title="Lihat Detail ${siswa.nama}">${siswa.nama}</span></td> <!-- Modified -->
            <td>${siswa.kelas}</td>
            <td>${siswa.nis}</td>
            <td>${siswa.waliKelas}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-siswa" data-id="${siswa.id}">Ubah</button>
                <button class="btn btn-danger btn-sm btn-hapus-siswa" data-id="${siswa.id}" data-nama="${siswa.nama}" data-kelas="${siswa.kelas}">Hapus</button>
            </td>
            `;
            dataSiswaTableBody.appendChild(tr);
        });
    }

     // Event delegation for Data Siswa table actions (including detail view click)
     dataSiswaTableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-edit-siswa')) {
            editSiswa(event.target.dataset.id);
        } else if (event.target.classList.contains('btn-hapus-siswa')) {
            hapusSiswa(event.target.dataset.id, event.target.dataset.nama, event.target.dataset.kelas);
        } else if (event.target.classList.contains('clickable-name')) { // NEW: Handle name click
            showSiswaDetailModal(event.target.dataset.nama);
        }
    });
     // Search input listener now calls renderDataSiswaTable directly
     searchDataSiswaTableInput.addEventListener('input', () => renderDataSiswaTable());


    /********************************************************
     *      REKALKULASI DATA KETERLAMBATAN
     ********************************************************/
     // MODIFIED: Add 'kelas' to dataKeterlambatan
    function recalcDataKeterlambatan() {
        const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
        const latenessCounts = {}; // { studentNameLower: count }

        combinedHistory.forEach(record => {
             // Consider latenessResetDate if implemented
             const siswaInfo = databaseSiswa.find(s => s.nama.toLowerCase() === record.nama.toLowerCase());
             if (siswaInfo?.latenessResetDate && record.tanggal <= siswaInfo.latenessResetDate.toDate().toISOString().split('T')[0]) {
                 return; // Skip record if it's before or on the reset date
             }

            if (record.status === "late") {
                const nameLower = record.nama.toLowerCase();
                latenessCounts[nameLower] = (latenessCounts[nameLower] || 0) + 1;
            }
        });

        dataKeterlambatan = databaseSiswa.map(siswa => ({
            nama: siswa.nama,
            kelas: siswa.kelas, // Add kelas here
            terlambat_total: latenessCounts[siswa.nama.toLowerCase()] || 0
        }));

         console.log("Data Keterlambatan recalculated.");

        if (currentScreen === 'terlambatScreen') applyKeterlambatanFiltersAndRender(); // Render with filters
        if (currentScreen === 'homeScreen') renderTop5LateStudents();
    }

    /********************************************************
     *            INPUT ABSENSI (Single & Bulk)
     ********************************************************/
    // MODIFIED: catatKehadiran to include waktu, kelas, statusDetail, date validation
    async function catatKehadiran(event) {
      event.preventDefault();
      const rawNama = namaSiswaInput.value.trim();
      const tanggal = tanggalAbsenInput.value;
      const statusKedatangan = statusKedatanganSelect.value;
      const waktuTerlambat = waktuTerlambatInput.value; // New
      const alasanUmum = dropdownAlasanSelect.value;
      const alasanCustom = alasanCustomInput.value.trim();
       const sakitDetailRadio = document.querySelector('input[name="sakitDetail"]:checked'); // New
       const statusDetail = statusKedatangan === 'sakit' ? sakitDetailRadio?.value : null; // New

      // --- Validation ---
      if (!rawNama || !tanggal || !statusKedatangan) {
        showNotification("Mohon lengkapi Nama Siswa, Tanggal, dan Status Kedatangan.", "warning"); return;
      }
       // NEW: Validate date not in future & not holiday
       if (!isValidInputDate(tanggal)) return;

       const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === rawNama.toLowerCase());
      if (!siswa) {
        showNotification(`Siswa "${rawNama}" tidak ditemukan di database.`, "error"); return;
      }
      const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
      const existingRecord = combinedHistory.find(rec => rec.nama.toLowerCase() === rawNama.toLowerCase() && rec.tanggal === tanggal);
      if (existingRecord) {
        showNotification(`Siswa "${rawNama}" sudah tercatat absensinya pada tanggal ${tanggal} (${existingRecord.status}).`, "warning"); return;
      }
       if (statusKedatangan === 'late' && !waktuTerlambat) {
           // Optional: Make time mandatory for late?
           // showNotification("Mohon isi waktu kedatangan untuk status Terlambat.", "warning"); return;
       }
      // --- End Validation ---


      // Determine final reason
      let finalAlasan = "-";
      const needsReason = ["late", "izin", "sakit"]; // Alpha doesn't need reason
      if (needsReason.includes(statusKedatangan)) {
          if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
          else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
          else if (alasanCustom) finalAlasan = alasanCustom;
          else if (statusKedatangan === 'late' || statusKedatangan === 'sakit') { // Late/Sakit require a reason
               showNotification(`Mohon pilih/isi alasan untuk status ${capitalizeFirstLetter(statusKedatangan)}.`, "warning"); return;
          }
      } else if (statusKedatangan === 'dipulangkan') { // Alasan opsional for dipulangkan
            if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
             else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
             else if (alasanCustom) finalAlasan = alasanCustom;
             // else finalAlasan remains "-"
      }

      const record = {
        nama: siswa.nama, // Use canonical name
        kelas: siswa.kelas, // Store kelas at time of record
        tanggal,
        status: statusKedatangan,
        alasan: finalAlasan,
        pengisi: currentPengisi || "Sistem"
      };
       // Add optional fields
       if (statusKedatangan === 'late' && waktuTerlambat) record.waktu = waktuTerlambat;
       if (statusKedatangan === 'sakit' && statusDetail) record.statusDetail = statusDetail;


      try {
        await addData('historyAbsensi', record, `Absensi "${siswa.nama}" (${statusKedatangan}) berhasil dicatat.`, btnCatatAbsensi);
        absensiForm.reset();
        tanggalAbsenInput.valueAsDate = new Date(); // Reset date to today
        toggleAbsensiFieldsVisibility(); // Reset field visibility
        if (statusKedatangan === "late") await checkLateThreshold(siswa.nama);
      } catch (error) { /* Handled by addData */ }
    }

     // Function to check and handle late threshold (remains the same)
     async function checkLateThreshold(studentName) {
        const nameLower = studentName.toLowerCase();
        const currentLateCount = (dataKeterlambatan.find(s => s.nama.toLowerCase() === nameLower)?.terlambat_total || 0);

        console.log(`Checking late threshold for ${studentName}, current count: ${currentLateCount}`);

        if (currentLateCount >= lateThreshold) {
            const todayStr = new Date().toISOString().slice(0, 10);
             const existingDipulangkan = await findDocuments('siswaDipulangkan', 'nama', studentName);
             const alreadyDipulangkanToday = existingDipulangkan.some(doc => doc.datePulang === todayStr);

             if (alreadyDipulangkanToday) {
                 console.log(`${studentName} already marked as 'dipulangkan' today.`);
                 return;
             }

             showNotification(`Siswa ${studentName} telah mencapai ${currentLateCount} keterlambatan. Disarankan untuk menghubungi orang tua.`, "warning", 8000);

            try {
                await addData('siswaDipulangkan', {
                    nama: studentName,
                    datePulang: todayStr,
                    totalLateSaatItu: currentLateCount
                }, `Siswa ${studentName} ditandai untuk penanganan lebih lanjut (keterlambatan >= ${lateThreshold}).`);
            } catch (error) {
                 console.error(`Failed to add ${studentName} to siswaDipulangkan:`, error);
            }
        }
     }


    // --- NEW: Bulk Absensi ---
    function populateBulkSiswaList(searchTerm = '') {
        bulkAbsensiSiswaListDiv.innerHTML = ''; // Clear
        const lowerSearchTerm = searchTerm.toLowerCase();
        const filteredSiswa = databaseSiswa
            .filter(s => s.nama.toLowerCase().includes(lowerSearchTerm) || s.kelas.toLowerCase().includes(lowerSearchTerm))
            .sort((a, b) => a.nama.localeCompare(b.nama));

        if (filteredSiswa.length === 0) {
            bulkAbsensiSiswaListDiv.innerHTML = '<p style="text-align: center; color: #888;">Tidak ada siswa cocok.</p>';
            return;
        }

        filteredSiswa.forEach(siswa => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label>
                    <input type="checkbox" name="bulkSiswa" value="${siswa.nama}" data-kelas="${siswa.kelas}">
                    ${siswa.nama} (${siswa.kelas})
                </label>
            `;
            bulkAbsensiSiswaListDiv.appendChild(div);
        });
    }
    bulkSearchSiswaInput.addEventListener('input', () => populateBulkSiswaList(bulkSearchSiswaInput.value));

    async function catatBulkAbsensiHandler(event) {
        event.preventDefault();
        const tanggal = bulkTanggalAbsenInput.value;
        const status = bulkStatusKedatanganSelect.value;
        const waktu = bulkWaktuTerlambatInput.value;
        const alasanUmum = bulkDropdownAlasanSelect.value;
        const alasanCustom = bulkAlasanCustomInput.value.trim();
        const sakitDetailRadio = document.querySelector('#bulkAbsensiForm input[name="bulkSakitDetail"]:checked'); // Scope selector
        const statusDetail = status === 'sakit' ? sakitDetailRadio?.value : null;
        const selectedSiswaCheckboxes = bulkAbsensiSiswaListDiv.querySelectorAll('input[name="bulkSiswa"]:checked');

        // --- Validation ---
        if (!tanggal || !status) {
            showNotification("Mohon pilih Tanggal dan Status Kedatangan.", "warning"); return;
        }
        if (!isValidInputDate(tanggal)) return; // Validate date
        if (selectedSiswaCheckboxes.length === 0) {
            showNotification("Mohon pilih minimal satu siswa.", "warning"); return;
        }
        if (status === 'late' && !waktu) { /* Optional: Make time mandatory? */ }
        // --- End Validation ---

        // Determine final reason (same logic as single input)
        let finalAlasan = "-";
        const needsReason = ["late", "izin", "sakit"];
        if (needsReason.includes(status)) {
            if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
            else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
            else if (alasanCustom) finalAlasan = alasanCustom;
            else if (status === 'late' || status === 'sakit') {
                 showNotification(`Mohon pilih/isi alasan untuk status ${capitalizeFirstLetter(status)}.`, "warning"); return;
            }
        } else if (status === 'dipulangkan') { /* Alasan opsional */
             if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
             else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
             else if (alasanCustom) finalAlasan = alasanCustom;
        }

        const batch = db.batch();
        const recordsToAdd = [];
        const skippedStudents = [];
        const combinedHistory = [...historyAbsensi, ...archiveAbsensi];

        selectedSiswaCheckboxes.forEach(cb => {
            const nama = cb.value;
            const kelas = cb.dataset.kelas;
            // Check for existing record
            const existing = combinedHistory.find(rec => rec.nama.toLowerCase() === nama.toLowerCase() && rec.tanggal === tanggal);
            if (existing) {
                skippedStudents.push(`${nama} (sudah ada: ${existing.status})`);
            } else {
                const record = {
                    nama: nama,
                    kelas: kelas,
                    tanggal: tanggal,
                    status: status,
                    alasan: finalAlasan,
                    pengisi: currentPengisi || "Sistem (Bulk)"
                };
                 if (status === 'late' && waktu) record.waktu = waktu;
                 if (status === 'sakit' && statusDetail) record.statusDetail = statusDetail;

                 const docRef = db.collection('historyAbsensi').doc(); // Auto-generate ID
                 batch.set(docRef, record);
                 recordsToAdd.push(nama);
            }
        });

        if (recordsToAdd.length === 0) {
            showNotification(`Tidak ada data baru untuk ditambahkan. ${skippedStudents.length > 0 ? 'Siswa berikut dilewati: ' + skippedStudents.join(', ') : ''}`, "warning");
            return;
        }

        btnCatatBulkAbsensi.disabled = true;
        btnCatatBulkAbsensi.innerHTML = 'Menyimpan... <span class="spinner"></span>';

        try {
            await batch.commit();
            let successMsg = `${recordsToAdd.length} absensi (${status}) berhasil dicatat.`;
            if (skippedStudents.length > 0) {
                successMsg += ` ${skippedStudents.length} siswa dilewati (sudah ada data di tanggal tersebut).`;
            }
            showNotification(successMsg, "success", 6000);
            bulkAbsensiForm.reset();
            bulkTanggalAbsenInput.valueAsDate = new Date(); // Reset date
            populateBulkSiswaList(); // Clear selections visually
            toggleBulkAbsensiFieldsVisibility(); // Reset field visibility

            // Check threshold for all added late students
            if (status === "late") {
                for (const nama of recordsToAdd) {
                    await checkLateThreshold(nama); // Check one by one after batch commit
                }
            }
        } catch (error) {
            console.error("Error saving bulk absensi:", error);
            showNotification("Gagal menyimpan absensi bulk. Cek konsol.", "error");
        } finally {
            btnCatatBulkAbsensi.disabled = false;
            btnCatatBulkAbsensi.innerHTML = 'Catat Absensi Bulk';
        }
    }


    // --- Toggle field visibility ---
    function toggleAbsensiFieldsVisibility() {
        const status = statusKedatanganSelect.value;
        const alasan = dropdownAlasanSelect.value;

        waktuTerlambatContainer.style.display = (status === 'late') ? 'block' : 'none';
        sakitDetailContainer.style.display = (status === 'sakit') ? 'block' : 'none';

        const needsReason = ['late', 'izin', 'sakit', 'dipulangkan']; // Dipulangkan has optional reason
        dropdownAlasanSelect.disabled = !needsReason.includes(status);
        alasanCustomContainer.style.display = (needsReason.includes(status) && alasan === 'Lainnya') ? 'block' : 'none';

        // Clear irrelevant fields
        if (status !== 'late') waktuTerlambatInput.value = '';
        if (status !== 'sakit') {
            // Clear radio selection if needed, but might be annoying if user toggles back
            // const radio = document.querySelector('#absensiForm input[name="sakitDetail"]:checked');
            // if (radio) radio.checked = false;
        }
        if (!needsReason.includes(status)) {
            dropdownAlasanSelect.value = '';
            alasanCustomInput.value = '';
            alasanCustomContainer.style.display = 'none';
        }
         if (alasan !== 'Lainnya') {
             alasanCustomInput.value = '';
         }
    }
     statusKedatanganSelect.addEventListener('change', toggleAbsensiFieldsVisibility);
     dropdownAlasanSelect.addEventListener('change', toggleAbsensiFieldsVisibility);

     function toggleBulkAbsensiFieldsVisibility() {
         const status = bulkStatusKedatanganSelect.value;
         const alasan = bulkDropdownAlasanSelect.value;
         bulkWaktuTerlambatContainer.style.display = (status === 'late') ? 'block' : 'none';
         // Make sure the selector is specific to the bulk form if you reuse radio names
         const bulkSakitContainer = document.getElementById('bulkSakitDetailContainer'); // Add ID if needed
         if(bulkSakitContainer) bulkSakitContainer.style.display = (status === 'sakit') ? 'block' : 'none';

         const needsReason = ['late', 'izin', 'sakit', 'dipulangkan'];
         bulkDropdownAlasanSelect.disabled = !needsReason.includes(status);
         bulkAlasanCustomContainer.style.display = (needsReason.includes(status) && alasan === 'Lainnya') ? 'block' : 'none';

         // Clear fields if status changes?
         if (status !== 'late') bulkWaktuTerlambatInput.value = '';
         if (!needsReason.includes(status)) {
            bulkDropdownAlasanSelect.value = '';
            bulkAlasanCustomInput.value = '';
            bulkAlasanCustomContainer.style.display = 'none';
         }
         if (alasan !== 'Lainnya') {
             bulkAlasanCustomInput.value = '';
         }
     }
      bulkStatusKedatanganSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility);
      bulkDropdownAlasanSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility);


    // --- NEW: Date Validation ---
    function isHoliday(dateString) {
        return hariLibur.some(libur => libur.tanggal === dateString);
    }
    function isValidInputDate(dateString) {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Set time to midnight for comparison

         if (!dateString || !isValidDate(dateString)) { // Check basic format validity
             showNotification("Format tanggal tidak valid (YYYY-MM-DD).", "warning");
             return false;
         }
         const inputDate = new Date(dateString);
         // Correct for potential timezone issues when comparing dates only
         inputDate.setMinutes(inputDate.getMinutes() + inputDate.getTimezoneOffset());
         inputDate.setHours(0, 0, 0, 0);


        if (inputDate > today) {
            showNotification("Tidak dapat mencatat absensi untuk tanggal di masa depan.", "warning");
            return false;
        }
        if (isHoliday(dateString)) {
            showNotification(`Tanggal ${dateString} adalah hari libur.`, "warning");
            return false; // Or ask for confirmation? For now, block.
        }
        return true;
    }
     // Check holiday status on date change
     function checkDateInputHoliday(inputElement, warningElement) {
         if (!inputElement || !warningElement) return;
         const date = inputElement.value;
         if (date && isHoliday(date)) {
             warningElement.style.display = 'block';
         } else {
             warningElement.style.display = 'none';
         }
     }
     tanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(tanggalAbsenInput, holidayWarning));
     bulkTanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(bulkTanggalAbsenInput, bulkHolidayWarning));


    /********************************************************
     *      RENDER TABEL HISTORY (History Screen)
     ********************************************************/
     // MODIFIED: renderHistoryTable to include kelas, waktu, filter logic
     function renderHistoryTable(dataToRender = null) {
        historyTableBody.innerHTML = "";
        updateSortIcons(historyTableBody.closest('table').querySelector('thead'), historySort);

        if (dataToRender === null) { // If no data passed, means it needs filtering first
            applyHistoryFiltersAndRender(); // This will recall renderHistoryTable with filtered data
            return;
        }


        if (dataToRender.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Tidak ada data riwayat yang cocok dengan filter.</td></tr>`; // Updated colspan
            return;
        }

        // Sort the data already filtered before passing here
        const sortedData = dataToRender.sort((a, b) => sortData(a,b, historySort));

        sortedData.forEach((item) => {
            const tr = document.createElement('tr');
            const recordId = item.id; // ID should be present now
             // Determine collection source more reliably
             const isInHistory = historyAbsensi.some(r => r.id === recordId);
             const isInArchive = archiveAbsensi.some(r => r.id === recordId);
             const collectionType = isInHistory ? 'historyAbsensi' : (isInArchive ? 'archiveAbsensi' : null);


            tr.innerHTML = `
            <td>${item.tanggal}</td>
            <td><span class="clickable-name" data-nama="${item.nama}" title="Lihat Detail ${item.nama}">${item.nama}</span></td> <!-- Modified -->
            <td>${item.kelas || "-"}</td> <!-- Added -->
            <td>
                <select class="status-edit-history" data-id="${recordId}" data-collection="${collectionType || ''}" ${!recordId || !collectionType ? 'disabled' : ''}>
                    <option value="late" ${item.status === "late" ? "selected" : ""}>Terlambat</option>
                    <option value="izin" ${item.status === "izin" ? "selected" : ""}>Izin</option>
                    <option value="sakit" ${item.status === "sakit" ? "selected" : ""}>Sakit</option>
                    <option value="alpha" ${item.status === "alpha" ? "selected" : ""}>Alpha</option>
                    <option value="dipulangkan" ${item.status === "dipulangkan" ? "selected" : ""}>Dipulangkan</option>
                </select>
                 ${item.statusDetail ? '<br><small>('+item.statusDetail.replace('_',' ')+')</small>' : ''} <!-- Show detail -->
            </td>
            <td>${item.status === 'late' ? (item.waktu || '-') : '-'}</td> <!-- Added -->
            <td>${item.alasan || "-"}</td>
            <td>${item.pengisi || "-"}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-tanggal-history" data-id="${recordId}" data-collection="${collectionType || ''}" data-nama="${item.nama}" data-tanggal="${item.tanggal}" ${!recordId || !collectionType ? 'disabled' : ''}>Edit Tgl</button>
                <button class="btn btn-danger btn-sm btn-delete-history" data-id="${recordId}" data-collection="${collectionType || ''}" data-nama="${item.nama}" data-tanggal="${item.tanggal}" ${!recordId || !collectionType ? 'disabled' : ''}>Hapus</button>
            </td>
            `;
            historyTableBody.appendChild(tr);
        });
    }

    // MODIFIED: updateStatusHistory might need to recalc other stats if status changes affect them
    async function updateStatusHistory(recordId, collectionType, newStatus, selectElement) {
         if (!recordId || !collectionType) {
             showNotification("Tidak dapat mengubah status, ID atau Sumber data tidak ditemukan.", "error");
             selectElement.value = selectElement.dataset.originalStatus || selectElement.querySelector('option[selected]')?.value; // Revert
             return;
         }
         const originalStatus = selectElement.dataset.originalStatus || selectElement.querySelector(`option[selected]`)?.value; // Get original status

         selectElement.disabled = true; // Disable during update
         try {
             await updateData(collectionType, recordId, { status: newStatus }, "Status absensi berhasil diperbarui.");
             selectElement.dataset.originalStatus = newStatus; // Store new status
             recalcDataKeterlambatan(); // Recalc needed if changed to/from 'late'
             // Optional: If detail view is open for this student, update it? More complex.
             applyKeterlambatanFiltersAndRender(); // Re-render potentially affected tables with filter
             renderHome(); // Update dashboard
         } catch (error) {
              if(originalStatus) selectElement.value = originalStatus; // Revert select on error
             // Notification handled by updateData
         } finally {
             selectElement.disabled = false;
         }
    }
     // editRiwayatTanggal, deleteRiwayat remain largely the same
     async function editRiwayatTanggal(recordId, collectionType, currentNama, oldDate) {
         if (!recordId || !collectionType) {
             showNotification("Tidak dapat mengubah tanggal, ID atau Sumber data tidak ditemukan.", "error");
             return;
         }
        const newDate = prompt(`Masukkan tanggal baru (YYYY-MM-DD) untuk absensi ${currentNama}:`, oldDate);

        if (newDate && isValidDate(newDate) && newDate !== oldDate) {
            // Validate new date (not future, not holiday)
             if (!isValidInputDate(newDate)) return; // isValidInputDate shows notification

            // Check if student already has a record on the NEW date
             const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
             const existingOnNewDate = combinedHistory.find(rec =>
                 rec.nama.toLowerCase() === currentNama.toLowerCase() &&
                 rec.tanggal === newDate &&
                 rec.id !== recordId // Exclude the record being edited
             );

             if (existingOnNewDate) {
                 showNotification(`Siswa "${currentNama}" sudah memiliki data absensi pada tanggal ${newDate}. Tidak dapat memindahkan.`, "warning", 6000);
                 return;
             }

            try {
                await updateData(collectionType, recordId, { tanggal: newDate }, `Tanggal absensi untuk "${currentNama}" berhasil diubah ke ${newDate}.`);
                // History table updated by listener via applyHistoryFiltersAndRender
            } catch (error) {
                // Notification handled by updateData
            }
        } else if (newDate && !isValidDate(newDate)) {
             showNotification("Format tanggal tidak valid. Harap gunakan YYYY-MM-DD.", "warning");
        }
      }
     async function deleteRiwayat(recordId, collectionType, nama, tanggal) {
        if (!recordId || !collectionType) {
             showNotification("Tidak dapat menghapus, ID atau Sumber data tidak ditemukan.", "error");
             return;
         }
         showConfirmModal(`Hapus data absensi siswa "${nama}" pada tanggal ${tanggal}?`, async () => {
             try {
                 await deleteData(collectionType, recordId, `Data absensi "${nama}" (${tanggal}) berhasil dihapus.`);
                 // Table updated by listener
                 recalcDataKeterlambatan(); // Recalculate totals
                 applyKeterlambatanFiltersAndRender(); // Update lateness table with filter
                 renderHome(); // Update dashboard
             } catch (error) {
                // Notification handled by deleteData
             }
         });
      }

     // Event delegation for History table actions (including detail view click)
     historyTableBody.addEventListener('change', (event) => {
        if (event.target.classList.contains('status-edit-history')) {
             const select = event.target;
             if (!select.dataset.originalStatus) { // Store original on first change attempt
                 select.dataset.originalStatus = select.value;
             }
             updateStatusHistory(select.dataset.id, select.dataset.collection, select.value, select);
         }
      });
     historyTableBody.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('btn-edit-tanggal-history')) {
            editRiwayatTanggal(target.dataset.id, target.dataset.collection, target.dataset.nama, target.dataset.tanggal);
        } else if (target.classList.contains('btn-delete-history')) {
            deleteRiwayat(target.dataset.id, target.dataset.collection, target.dataset.nama, target.dataset.tanggal);
        } else if (target.classList.contains('clickable-name')) { // NEW
            showSiswaDetailModal(target.dataset.nama);
        }
     });


    /********************************************************
     *      RENDER DATA KETERLAMBATAN (Keterlambatan Screen)
     ********************************************************/
     // MODIFIED: renderDataKeterlambatanTable to include kelas and clickable name
     function renderDataKeterlambatanTable(dataToRender = null) {
        dataKeterlambatanTableBody.innerHTML = "";
        updateSortIcons(dataKeterlambatanTableBody.closest('table').querySelector('thead'), keterlambatanSort);

        if (dataToRender === null) { // If no data passed, filter first
            applyKeterlambatanFiltersAndRender();
            return;
        }

        if (dataToRender.length === 0) {
            dataKeterlambatanTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Tidak ada data keterlambatan yang cocok dengan filter.</td></tr>`; // Updated colspan
            return;
        }

        // Sort the filtered data
        const sortedData = dataToRender.sort((a,b) => sortData(a,b, keterlambatanSort));

        sortedData.forEach((siswa) => {
            const tr = document.createElement('tr');
            const isDisabled = siswa.terlambat_total === 0;
            tr.innerHTML = `
            <td><span class="clickable-name" data-nama="${siswa.nama}" title="Lihat Detail ${siswa.nama}">${siswa.nama}</span></td> <!-- Modified -->
            <td>${siswa.kelas || "-"}</td> <!-- Added -->
            <td style="text-align: center; font-weight: bold;">${siswa.terlambat_total}</td>
            <td>
                <button class="btn btn-warning btn-sm btn-reset-keterlambatan" data-nama="${siswa.nama}" ${isDisabled ? 'disabled' : ''}>Reset Jadi 0</button>
                <button class="btn btn-danger btn-sm btn-kurangi-keterlambatan" data-nama="${siswa.nama}" ${isDisabled ? 'disabled' : ''}>Kurangi 1</button>
            </td>
            `;
            dataKeterlambatanTableBody.appendChild(tr);
        });
    }

     // resetKeterlambatanForStudent, kurangiKeterlambatan, resetSemuaKeterlambatanHandler remain largely the same
     // (Consider implementing the 'latenessResetDate' logic in recalcDataKeterlambatan if using that approach for reset)
      async function resetKeterlambatanForStudent(namaSiswa) {
         // Option 3: Add reset marker
         showConfirmModal(`Reset jumlah keterlambatan siswa "${namaSiswa}" menjadi 0? (Ini akan menandai siswa dan menghitung ulang dari sekarang). Riwayat lama tetap ada.`, async () => {
             try {
                 const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === namaSiswa.toLowerCase());
                 if (siswa && siswa.id) {
                     await updateData('databaseSiswa', siswa.id, {
                         latenessResetDate: firebase.firestore.FieldValue.serverTimestamp()
                     }, `Keterlambatan untuk "${namaSiswa}" ditandai reset.`);
                     // Recalc will handle the actual counting change
                     // Force recalc and re-render immediately for visual feedback
                     recalcDataKeterlambatan();
                     applyKeterlambatanFiltersAndRender(); // Ensure table updates with filter
                     renderHome(); // Update dashboard
                 } else {
                     showNotification(`Siswa "${namaSiswa}" tidak ditemukan di database untuk direset.`, "error");
                 }
             } catch (error) {
                 showNotification(`Gagal mereset keterlambatan untuk "${namaSiswa}".`, "error");
             }
         });
       }
      async function kurangiKeterlambatan(namaSiswa) {
         showConfirmModal(`Kurangi jumlah keterlambatan siswa "${namaSiswa}" sebanyak 1? (Akan menghapus 1 record 'Terlambat' terbaru dari riwayat).`, async () => {
            try {
                 const combined = [...historyAbsensi, ...archiveAbsensi]
                                 .filter(rec => rec.nama.toLowerCase() === namaSiswa.toLowerCase() && rec.status === 'late')
                                 .sort((a, b) => b.tanggal.localeCompare(a.tanggal));

                 if (combined.length > 0) {
                     const latestLateRecord = combined[0];
                     const recordId = latestLateRecord.id;
                     const collectionType = historyAbsensi.some(r => r.id === recordId) ? 'historyAbsensi' : (archiveAbsensi.some(r => r.id === recordId) ? 'archiveAbsensi' : null);


                     if (recordId && collectionType) {
                         await deleteData(collectionType, recordId, `Satu record keterlambatan terbaru untuk "${namaSiswa}" (${latestLateRecord.tanggal}) dihapus.`);
                         // Recalc and re-render triggered by listener
                         recalcDataKeterlambatan();
                         applyKeterlambatanFiltersAndRender(); // Apply filters after recalc
                         renderHome();
                     } else {
                         showNotification(`Record keterlambatan terbaru untuk "${namaSiswa}" tidak memiliki ID atau sumber tidak jelas, tidak dapat dihapus.`, "error");
                     }
                 } else {
                     showNotification(`Tidak ditemukan record 'Terlambat' untuk "${namaSiswa}" yang bisa dihapus.`, "info");
                 }

            } catch (error) {
                showNotification(`Gagal mengurangi keterlambatan untuk "${namaSiswa}".`, "error");
            }
        });
       }
      async function resetSemuaKeterlambatanHandler() {
         showConfirmModal("PERINGATAN: Anda yakin ingin mereset SEMUA keterlambatan? Ini akan MENGHAPUS SEMUA record dengan status 'Terlambat' dari RIWAYAT AKTIF dan ARSIP! Tindakan ini tidak dapat dibatalkan.", async () => {
             const btn = btnResetSemuaKeterlambatan;
             const originalText = btn.innerHTML;
             btn.disabled = true;
             btn.innerHTML = 'Mereset... <span class="spinner"></span>';
            try {
                let batch = db.batch();
                 let deletedCount = 0;
                 let writeCount = 0;
                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch(); // Start new batch
                     writeCount = 0;
                 };

                 const historySnapshot = await db.collection('historyAbsensi').where('status', '==', 'late').get();
                 historySnapshot.forEach(doc => {
                     batch.delete(doc.ref); deletedCount++; writeCount++;
                     if (writeCount >= 490) commitBatch(); // Commit periodically
                 });

                 const archiveSnapshot = await db.collection('archiveAbsensi').where('status', '==', 'late').get();
                 archiveSnapshot.forEach(doc => {
                     batch.delete(doc.ref); deletedCount++; writeCount++;
                     if (writeCount >= 490) commitBatch();
                 });

                 if(writeCount > 0) await commitBatch(); // Commit any remaining


                 if(deletedCount > 0) {
                    showNotification(`Semua ${deletedCount} record 'Terlambat' telah dihapus dari riwayat dan arsip.`, "success");
                 } else {
                     showNotification("Tidak ada record 'Terlambat' yang ditemukan untuk dihapus.", "info");
                 }
                 // Recalc and re-render triggered by listener
                 recalcDataKeterlambatan();
                 applyKeterlambatanFiltersAndRender();
                 renderHome();

            } catch (error) {
                console.error("Error mereset semua keterlambatan:", error);
                showNotification("Gagal mereset semua keterlambatan. Cek konsol.", "error");
            } finally {
                 btn.disabled = false;
                 btn.innerHTML = originalText;
            }
        });
       }


     // Event delegation for Keterlambatan table actions (including detail view click)
     dataKeterlambatanTableBody.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('btn-reset-keterlambatan')) {
            resetKeterlambatanForStudent(target.dataset.nama);
        } else if (target.classList.contains('btn-kurangi-keterlambatan')) {
            kurangiKeterlambatan(target.dataset.nama);
        } else if (target.classList.contains('clickable-name')) { // NEW
            showSiswaDetailModal(target.dataset.nama);
        }
     });
     btnResetSemuaKeterlambatan.addEventListener('click', resetSemuaKeterlambatanHandler);


    /********************************************************
     *      FILTERING LOGIC (History & Keterlambatan) - NEW
     ********************************************************/

     // --- History Filters ---
     function applyHistoryFiltersAndRender() {
         currentHistoryFilters = {
             searchTerm: searchHistoryInput.value.toLowerCase(),
             kelas: filterKelasHistorySelect.value,
             tanggal: filterDateInput.value,
             startDate: filterStartDateInput.value,
             endDate: filterEndDateInput.value,
             status: filterStatusSelect.value
         };

         const combined = [...historyAbsensi, ...archiveAbsensi];
         let filtered = combined;
         let filterDescription = "Menampilkan semua riwayat";
         let filtersApplied = [];

         // Apply search term
         if (currentHistoryFilters.searchTerm) {
             filtered = filtered.filter(item =>
                 item.nama.toLowerCase().includes(currentHistoryFilters.searchTerm) ||
                 (item.kelas && item.kelas.toLowerCase().includes(currentHistoryFilters.searchTerm)) ||
                 item.alasan.toLowerCase().includes(currentHistoryFilters.searchTerm) ||
                 (item.pengisi && item.pengisi.toLowerCase().includes(currentHistoryFilters.searchTerm)) ||
                 item.tanggal.includes(currentHistoryFilters.searchTerm)
             );
             filtersApplied.push(`teks "${currentHistoryFilters.searchTerm}"`);
         }
          // Apply Kelas
          if (currentHistoryFilters.kelas) {
              filtered = filtered.filter(item => item.kelas === currentHistoryFilters.kelas);
               filtersApplied.push(`kelas ${currentHistoryFilters.kelas}`);
          }
          // Apply Tanggal or Rentang Tanggal (prioritize single date if both filled)
          if (currentHistoryFilters.tanggal) {
               filtered = filtered.filter(item => item.tanggal === currentHistoryFilters.tanggal);
               filtersApplied.push(`tanggal ${currentHistoryFilters.tanggal}`);
          } else if (currentHistoryFilters.startDate && currentHistoryFilters.endDate) {
              if (currentHistoryFilters.startDate > currentHistoryFilters.endDate) {
                  showNotification("Tanggal mulai filter tidak boleh > tanggal akhir.", "warning");
              } else {
                  filtered = filtered.filter(item => item.tanggal >= currentHistoryFilters.startDate && item.tanggal <= currentHistoryFilters.endDate);
                   filtersApplied.push(`rentang ${currentHistoryFilters.startDate} - ${currentHistoryFilters.endDate}`);
              }
          }
          // Apply Status
          if (currentHistoryFilters.status) {
              filtered = filtered.filter(item => item.status === currentHistoryFilters.status);
              filtersApplied.push(`status ${capitalizeFirstLetter(currentHistoryFilters.status)}`);
          }


         if (filtersApplied.length > 0) {
             filterDescription = `Hasil filter untuk: ${filtersApplied.join(', ')}`;
         }

         displayFilterResult(filterResultDiv, filterDescription, filtered.length);
         renderHistoryTable(filtered); // Pass the filtered data
     }

     function resetHistoryFiltersHandler() {
        searchHistoryInput.value = "";
        filterKelasHistorySelect.value = "";
        filterDateInput.value = "";
        filterStartDateInput.value = "";
        filterEndDateInput.value = "";
        filterStatusSelect.value = "";
        currentHistoryFilters = {}; // Clear state
        filterResultDiv.style.display = "none";
        renderHistoryTable([...historyAbsensi, ...archiveAbsensi]); // Render full table
        showNotification("Filter riwayat dibersihkan.", "info");
    }
     btnApplyHistoryFilter.addEventListener('click', applyHistoryFiltersAndRender);
     btnResetHistoryFilters.addEventListener('click', resetHistoryFiltersHandler);
     // Optional: Add live filtering on search input?
     // searchHistoryInput.addEventListener('input', applyHistoryFiltersAndRender);


      // --- Keterlambatan Filters ---
      function applyKeterlambatanFiltersAndRender() {
         currentKeterlambatanFilters = {
             searchTerm: searchKeterlambatanInput.value.toLowerCase(),
             kelas: filterKelasKeterlambatanSelect.value,
             min: filterMinLatenessInput.value ? parseInt(filterMinLatenessInput.value) : null,
             max: filterMaxLatenessInput.value ? parseInt(filterMaxLatenessInput.value) : null,
         };

          let filtered = dataKeterlambatan; // Start with recalculated data
          let filterDescription = "Menampilkan semua data keterlambatan";
          let filtersApplied = [];

          // Apply search term
          if (currentKeterlambatanFilters.searchTerm) {
              filtered = filtered.filter(siswa => siswa.nama.toLowerCase().includes(currentKeterlambatanFilters.searchTerm));
              filtersApplied.push(`nama "${currentKeterlambatanFilters.searchTerm}"`);
          }
           // Apply Kelas
          if (currentKeterlambatanFilters.kelas) {
              filtered = filtered.filter(siswa => siswa.kelas === currentKeterlambatanFilters.kelas);
              filtersApplied.push(`kelas ${currentKeterlambatanFilters.kelas}`);
          }
          // Apply Count Range
           if (currentKeterlambatanFilters.min !== null && currentKeterlambatanFilters.min >= 0) {
               filtered = filtered.filter(siswa => siswa.terlambat_total >= currentKeterlambatanFilters.min);
                filtersApplied.push(`min ${currentKeterlambatanFilters.min}`);
           }
           if (currentKeterlambatanFilters.max !== null && currentKeterlambatanFilters.max >=0) {
                if (currentKeterlambatanFilters.min !== null && currentKeterlambatanFilters.max < currentKeterlambatanFilters.min) {
                    showNotification("Filter Max tidak boleh kurang dari Min.", "warning");
                } else {
                    filtered = filtered.filter(siswa => siswa.terlambat_total <= currentKeterlambatanFilters.max);
                    filtersApplied.push(`max ${currentKeterlambatanFilters.max}`);
                }
           }

          if (filtersApplied.length > 0) {
             filterDescription = `Hasil filter untuk: ${filtersApplied.join(', ')}`;
          }

          displayFilterResult(keterlambatanFilterResultDiv, filterDescription, filtered.length);
          renderDataKeterlambatanTable(filtered); // Pass filtered data
      }

     function resetKeterlambatanFiltersHandler() {
         searchKeterlambatanInput.value = "";
         filterKelasKeterlambatanSelect.value = "";
         filterMinLatenessInput.value = "";
         filterMaxLatenessInput.value = "";
         currentKeterlambatanFilters = {};
         keterlambatanFilterResultDiv.style.display = "none";
         renderDataKeterlambatanTable(dataKeterlambatan); // Render full table
         showNotification("Filter keterlambatan dibersihkan.", "info");
     }
     btnApplyKeterlambatanFilter.addEventListener('click', applyKeterlambatanFiltersAndRender);
     btnResetKeterlambatanFilter.addEventListener('click', resetKeterlambatanFiltersHandler);
     // Optional: Live search
     // searchKeterlambatanInput.addEventListener('input', applyKeterlambatanFiltersAndRender);


     // Helper to display filter results
     function displayFilterResult(element, description, count) {
        if (!element) return;
        element.textContent = `${description}: ${count} data ditemukan.`;
        element.style.display = count >= 0 ? "block" : "none"; // Show if count is 0 or more
     }


    /********************************************************
     *      STATISTIK (Statistik Screen) - MODIFIED
     ********************************************************/
     // Show/hide relevant filters based on chart type
     function handleChartOptionChange() {
        const option = chartOptionSelect.value;
        const bulanRequired = ['tren_harian_telat', 'tren_kelas_telat', 'tren_hari_telat', 'status_bulanan', 'siswa_telat', 'alasan_telat']; // Needs single month
        const compareAvailable = ['banding_bulan'];
        const kelasFilterAvailable = ['tren_harian_telat', 'tren_kelas_telat', 'tren_hari_telat', 'status_bulanan', 'siswa_telat', 'alasan_telat']; // Expanded class filter availability


        statistikBulanInput.disabled = !(bulanRequired.includes(option) || compareAvailable.includes(option));
        compareMonthContainer.style.display = compareAvailable.includes(option) ? 'block' : 'none';
        chartKelasFilterContainer.style.display = kelasFilterAvailable.includes(option) ? 'block' : 'none';

         // Reset comparison input if not needed
         if (!compareAvailable.includes(option)) {
             statistikBulanCompareInput.value = '';
         }
          // Reset class filter if not needed
          if (!kelasFilterAvailable.includes(option)) {
             chartFilterKelasSelect.value = '';
         }
     }
     chartOptionSelect.addEventListener('change', handleChartOptionChange);


     // MODIFIED: renderStatisticChartHandler for new chart types & analysis
    async function renderStatisticChartHandler() {
      const option = chartOptionSelect.value;
      let statistikBulan = statistikBulanInput.value; // YYYY-MM - Use let
      const compareBulan = statistikBulanCompareInput.value; // YYYY-MM
      const filterKelas = chartFilterKelasSelect.value; // Selected class
      const combinedData = [...historyAbsensi, ...archiveAbsensi];

      let chartTitle = "";
      let labels = [];
      let datasets = []; // Use datasets array for comparison charts
      let typeChart = 'bar';
      let showTextAnalysis = false;
       analysisContentP.innerHTML = ""; // Clear previous analysis

       const canvasContainer = chartStatisticContainer;
       const loader = canvasContainer.querySelector('.loader-container');
       const canvas = chartStatisticCanvas;

       // Reset view
       if (chartObj) { chartObj.destroy(); chartObj = null; }
       // Note: Don't destroy latenessLineChart here, it's for the dashboard
       // if (latenessLineChart) { latenessLineChart.destroy(); latenessLineChart = null; }
       canvas.style.display = 'none';
       textAnalysisContainer.style.display = 'none'; // Hide analysis
       loader.style.display = 'block';
       downloadSectionDiv.style.display = 'none';

        // --- Validation & Auto-Month Selection ---
        if (option === 'banding_bulan' && (!statistikBulan || !compareBulan)) {
             showNotification("Pilih kedua bulan untuk perbandingan.", "warning");
             loader.style.display = 'none'; return;
        }
        // Check if month is required but not selected
        const needsMonthNow = ['tren_harian_telat', 'tren_kelas_telat', 'tren_hari_telat', 'status_bulanan'].includes(option);
        if (needsMonthNow && !statistikBulan) {
             if (combinedData.length > 0) {
                const latestDate = combinedData.reduce((max, item) => item.tanggal > max ? item.tanggal : max, combinedData[0].tanggal);
                statistikBulan = latestDate.slice(0,7); // Assign to the let variable
                statistikBulanInput.value = statistikBulan; // Update input field
                showNotification(`Bulan tidak dipilih, menampilkan data bulan terbaru: ${statistikBulan}`, 'info');
             } else {
                showNotification("Tidak ada data untuk ditampilkan.", "info");
                loader.style.display = 'none'; return;
             }
        }
        // Allow total view for top siswa/alasan if month is not selected
        const isTotalView = (option === 'siswa_telat' || option === 'alasan_telat') && !statistikBulan;


        // --- Data Filtering ---
        setTimeout(() => { // Allow loader to render
            try {
                 let filteredData = combinedData; // Default to all data
                 let currentMonthData = [];
                 let compareMonthData = [];
                 let bulanInfo = isTotalView ? '(Total)' : (statistikBulan ? `(${statistikBulan})` : '');


                 if (statistikBulan && option !== 'banding_bulan') {
                     currentMonthData = combinedData.filter(item => item.tanggal.startsWith(statistikBulan));
                     filteredData = currentMonthData; // Use only current month data
                     bulanInfo = `(${statistikBulan})`;
                 } else if (option === 'banding_bulan') {
                     currentMonthData = combinedData.filter(item => item.tanggal.startsWith(statistikBulan));
                     compareMonthData = combinedData.filter(item => item.tanggal.startsWith(compareBulan));
                     filteredData = [...currentMonthData, ...compareMonthData]; // Needed if labels depend on both
                     bulanInfo = `(${statistikBulan} vs ${compareBulan})`;
                 }
                 // else: isTotalView = true, filteredData remains combinedData


                 // Apply class filter if applicable and selected
                 if (filterKelas && chartKelasFilterContainer.style.display !== 'none') {
                     filteredData = filteredData.filter(item => item.kelas === filterKelas);
                     currentMonthData = currentMonthData.filter(item => item.kelas === filterKelas);
                     compareMonthData = compareMonthData.filter(item => item.kelas === filterKelas);
                     bulanInfo += (bulanInfo ? ` - ` : '') + `Kelas: ${filterKelas}`; // Append class info
                 }

                // Show download button only if a single month is selected (and not total view)
                if (statistikBulan && option !== 'banding_bulan') {
                     downloadSectionDiv.style.display = "block";
                 }


                // --- Chart Logic (using filteredData, currentMonthData, compareMonthData) ---
                switch(option) {
                    case "siswa_telat":
                        chartTitle = `Top 15 Siswa Sering Telat ${bulanInfo}`;
                        const siswaMap = {};
                        filteredData.forEach(item => {
                            if (item.status === "late") siswaMap[item.nama] = (siswaMap[item.nama] || 0) + 1;
                        });
                        const arrSiswa = Object.entries(siswaMap).map(([l, v]) => ({ label:l, value:v })).sort((a, b) => b.value - a.value).slice(0, 15);
                        labels = arrSiswa.map(x => x.label);
                        datasets = [{ label: 'Jumlah Keterlambatan', data: arrSiswa.map(x => x.value), backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }];
                        typeChart = 'bar';
                        break;

                    case "alasan_telat":
                        chartTitle = `Top 15 Alasan Keterlambatan ${bulanInfo}`;
                        const alasanMap = {};
                        filteredData.forEach(item => {
                            if (item.status === "late") {
                                const alasan = item.alasan || "Tidak Diketahui";
                                alasanMap[alasan] = (alasanMap[alasan] || 0) + 1;
                            }
                        });
                        const arrAlasan = Object.entries(alasanMap).map(([l, v]) => ({ label:l, value:v })).sort((a, b) => b.value - a.value).slice(0, 15);
                        labels = arrAlasan.map(x => x.label);
                        datasets = [{ label: 'Jumlah Kejadian', data: arrAlasan.map(x => x.value), backgroundColor: 'rgba(255, 159, 64, 0.7)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }];
                        typeChart = 'bar';
                         showTextAnalysis = true;
                         const totalLate = filteredData.filter(i => i.status === 'late').length;
                         let analysisHtml = `Total Keterlambatan ${bulanInfo}: ${totalLate} kali.<br>`;
                         if (arrAlasan.length > 0 && totalLate > 0) {
                            analysisHtml += `Alasan paling umum: "${arrAlasan[0].label}" (${arrAlasan[0].value} kali, ${((arrAlasan[0].value / totalLate) * 100).toFixed(1)}%).<br>`;
                         }
                          const lateWithTime = filteredData.filter(i => i.status === 'late' && i.waktu);
                          if (lateWithTime.length > 0) {
                               let totalMinutesLate = 0;
                               const schoolStartTime = "07:00";
                               lateWithTime.forEach(item => {
                                   try {
                                       const start = new Date(`1970-01-01T${schoolStartTime}:00`);
                                       const arrival = new Date(`1970-01-01T${item.waktu}:00`);
                                       if (arrival > start) {
                                           totalMinutesLate += (arrival - start) / (1000 * 60);
                                       }
                                   } catch(e) { console.warn("Error parsing time:", item.waktu); }
                               });
                               const avgMinutes = totalLate > 0 ? totalMinutesLate / lateWithTime.length : 0; // Avoid division by zero
                               analysisHtml += `Rata-rata menit keterlambatan (dari ${lateWithTime.length} data dgn waktu): ${avgMinutes.toFixed(1)} menit.<br>`;
                          } else if (totalLate > 0) {
                               analysisHtml += `(Data waktu kedatangan tidak tersedia untuk menghitung rata-rata menit).<br>`;
                          }
                         analysisContentP.innerHTML = analysisHtml;
                        break;

                    case "tren_harian_telat": {
                        if (!statistikBulan) { throw new Error("Bulan harus dipilih untuk tren harian."); } // Should be handled by validation, but good practice
                        chartTitle = `Tren Keterlambatan Harian ${bulanInfo}`;
                        typeChart = 'line';
                        const latenessByDate = {};
                        const year = parseInt(statistikBulan.slice(0, 4));
                        const month = parseInt(statistikBulan.slice(5, 7));
                        const daysInMonth = new Date(year, month, 0).getDate();
                        labels = [];
                        for (let day = 1; day <= daysInMonth; day++) {
                             const dateStr = `${statistikBulan}-${day.toString().padStart(2, '0')}`;
                             if (!isHoliday(dateStr)) {
                                 labels.push(dateStr);
                                 latenessByDate[dateStr] = 0;
                             }
                         }
                        filteredData.forEach(item => {
                            if (item.status === "late" && latenessByDate[item.tanggal] !== undefined) {
                                latenessByDate[item.tanggal]++;
                            }
                        });
                         const values = labels.map(date => latenessByDate[date]);
                        datasets = [{ label: 'Jumlah Keterlambatan', data: values, backgroundColor: 'rgba(231, 76, 60, 0.2)', borderColor: 'rgba(231, 76, 60, 1)', borderWidth: 2, fill: true, tension: 0.1 }];
                        break;
                      }

                     case "tren_kelas_telat": {
                         if (!statistikBulan && !isTotalView) { throw new Error("Bulan harus dipilih atau mode total."); }
                         chartTitle = `Distribusi Keterlambatan per Kelas ${bulanInfo}`;
                         typeChart = 'bar';
                         const lateByClass = {};
                         filteredData.forEach(item => {
                             if (item.status === 'late') {
                                 const kelas = item.kelas || 'Tanpa Kelas';
                                 lateByClass[kelas] = (lateByClass[kelas] || 0) + 1;
                             }
                         });
                         const sortedClasses = Object.entries(lateByClass).sort(([,a],[,b]) => b-a);
                         labels = sortedClasses.map(([kelas]) => kelas);
                         datasets = [{ label: 'Jumlah Keterlambatan', data: sortedClasses.map(([,count]) => count), backgroundColor: 'rgba(153, 102, 255, 0.7)', borderColor: 'rgba(153, 102, 255, 1)', borderWidth: 1 }];
                         break;
                      }

                     case "tren_hari_telat": {
                         if (!statistikBulan && !isTotalView) { throw new Error("Bulan harus dipilih atau mode total."); }
                         chartTitle = `Distribusi Keterlambatan per Hari ${bulanInfo}`;
                         typeChart = 'bar';
                         const lateByDay = { "Senin": 0, "Selasa": 0, "Rabu": 0, "Kamis": 0, "Jumat": 0, "Sabtu": 0 };
                         filteredData.forEach(item => {
                             if (item.status === 'late') {
                                 const dayName = getDayNameFromDate(item.tanggal);
                                 if (lateByDay.hasOwnProperty(dayName)) {
                                     lateByDay[dayName]++;
                                 }
                             }
                         });
                         labels = dayOrder;
                         datasets = [{ label: 'Jumlah Keterlambatan', data: labels.map(day => lateByDay[day]), backgroundColor: 'rgba(75, 192, 192, 0.7)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }];
                         break;
                      }

                     case "status_bulanan": {
                         if (!statistikBulan) { throw new Error("Bulan harus dipilih untuk distribusi status."); }
                         chartTitle = `Distribusi Status Absensi ${bulanInfo}`;
                         typeChart = 'doughnut';
                         const statusCounts = {};
                         filteredData.forEach(item => {
                             statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
                         });
                         labels = Object.keys(statusCounts).map(s => capitalizeFirstLetter(s));
                         const statusColors = { late: '#e74c3c', izin: '#f39c12', sakit: '#3498db', alpha: '#95a5a6', dipulangkan: '#8e44ad' };
                         datasets = [{
                             label: 'Jumlah',
                             data: Object.values(statusCounts),
                             backgroundColor: Object.keys(statusCounts).map(s => statusColors[s] || '#bdc3c7')
                         }];
                         break;
                      }

                     case "banding_bulan": {
                         chartTitle = `Perbandingan Keterlambatan ${bulanInfo}`;
                         typeChart = 'bar';
                         const countCurrent = currentMonthData.filter(i => i.status === 'late').length;
                         const countCompare = compareMonthData.filter(i => i.status === 'late').length;
                         labels = [statistikBulan, compareBulan];
                         datasets = [{ label: 'Jumlah Keterlambatan', data: [countCurrent, countCompare], backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'], borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)'], borderWidth: 1 }];
                         break;
                      }

                    default:
                        showNotification("Pilihan grafik tidak valid.", "warning");
                        loader.style.display = 'none'; return;
                }


                 // --- Render Chart ---
                 if (labels.length === 0 && (!datasets[0] || datasets[0].data.length === 0) ) { // Check if data actually exists
                     showNotification(`Tidak ada data untuk ditampilkan pada grafik ${option} ${bulanInfo}.`, 'info');
                      loader.style.display = 'none';
                     return;
                 }

                 const ctx = canvas.getContext('2d');
                 const chartConfig = {
                    type: typeChart,
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            ...( (typeChart === 'bar' || typeChart === 'line') && {
                                y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, suggestedMax: Math.max(...(datasets[0]?.data || [0]).flat(), 5) + 2 }, // Use flat() for potential multi-dataset charts
                                x: { ticks: { autoSkip: true, maxTicksLimit: typeChart === 'line' ? (window.innerWidth < 768 ? 10 : 15) : 20 } }
                            })
                        },
                        plugins: {
                             title: { display: true, text: chartTitle, font: { size: 16 } },
                             tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label || ''}: ${ctx.parsed?.y ?? ctx.parsed}` } }, // Handle pie/doughnut where value is in ctx.parsed
                             legend: { display: datasets.length > 1 || typeChart === 'doughnut' || typeChart === 'pie' }
                        }
                    }
                };

                 // Create the chart object
                 chartObj = new Chart(ctx, chartConfig); // Always use chartObj for statistics screen

                 if (showTextAnalysis) textAnalysisContainer.style.display = 'block';

            } catch (err) {
                 console.error("Error rendering statistic chart:", err);
                 showNotification("Gagal membuat grafik statistik.", "error");
                 loader.innerHTML = "<p>Gagal memuat grafik.</p>";
                 loader.style.display = 'block';
                 canvas.style.display = 'none';
            } finally {
                 if (loader.innerHTML.includes('Gagal')) { /* Keep loader showing error */ }
                 else { loader.style.display = 'none'; }
                 if (chartObj) canvas.style.display = 'block';
            }
        }, 10); // End setTimeout

    }

    // Download Monthly Data (remains similar, might adjust headers/columns based on new data)
    async function downloadMonthlyDataHandler() {
        const month = statistikBulanInput.value;
        if (!month) {
            showNotification("Silakan pilih bulan di atas terlebih dahulu!", "warning");
            return;
        }

        const btn = btnDownloadMonthly;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Mempersiapkan...';

        try {
            const startDate = `${month}-01`;
            const year = parseInt(month.slice(0, 4));
            const monthNum = parseInt(month.slice(5, 7));
            const lastDay = new Date(year, monthNum, 0).getDate();
            const endDate = `${month}-${lastDay.toString().padStart(2, '0')}`;

            const historySnapshot = await db.collection('historyAbsensi')
                .where('tanggal', '>=', startDate)
                .where('tanggal', '<=', endDate).get();
            const archiveSnapshot = await db.collection('archiveAbsensi')
                .where('tanggal', '>=', startDate)
                .where('tanggal', '<=', endDate).get();

            let filtered = [];
            historySnapshot.forEach(doc => filtered.push({ id: doc.id, ...doc.data() }));
            archiveSnapshot.forEach(doc => filtered.push({ id: doc.id, ...doc.data() }));

            if (filtered.length === 0) {
                showNotification(`Tidak ada data absensi untuk bulan ${month} yang bisa diunduh.`, "info");
                return; // Exit after finally
            }

            filtered.sort((a, b) => {
                const dateDiff = a.tanggal.localeCompare(b.tanggal);
                if (dateDiff !== 0) return dateDiff;
                return a.nama.localeCompare(b.nama);
            });

            // ADDED: Waktu column
            const ws_data = [
                ["Tanggal", "Nama Siswa", "Kelas", "NIS", "Wali Kelas", "Status", "Waktu", "Alasan", "Pengisi"]
            ];

            for (const item of filtered) {
                const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === item.nama.toLowerCase());
                ws_data.push([
                    item.tanggal,
                    item.nama,
                    item.kelas || siswa?.kelas || "-", // Use record's class first
                    siswa?.nis || "-",
                    siswa?.waliKelas || "-",
                    capitalizeFirstLetter(item.status) + (item.statusDetail ? ` (${item.statusDetail.replace('_',' ')})` : ''),
                    item.status === 'late' ? (item.waktu || '-') : '-', // Waktu column
                    item.alasan || "-",
                    item.pengisi || "-"
                ]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:12}, {wch:25}, {wch:15}, {wch:15}, {wch:20}, {wch:15}, {wch:10}, {wch:35}, {wch:20} ]; // Adjusted widths

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Absensi ${month}`);

            XLSX.writeFile(wb, `Laporan_Absensi_${month}.xlsx`);
            showNotification(`File Laporan_Absensi_${month}.xlsx berhasil dibuat.`, "success");

        } catch (error) {
            console.error("Error mendownload data bulanan:", error);
            showNotification("Gagal membuat file Excel. Cek konsol.", "error");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
     }

     // NEW: Download Chart Image
     function downloadChartImage() {
         const canvasToDownload = chartObj?.canvas; // Only statistic chart, not dashboard one
         if (canvasToDownload) {
             const url = canvasToDownload.toDataURL('image/png');
             const link = document.createElement('a');
             const bulan = statistikBulanInput.value || 'total';
             const kelas = chartFilterKelasSelect.value || 'semua-kelas';
             link.download = `grafik_${chartOptionSelect.value}_${bulan}_${kelas}.png`;
             link.href = url;
             link.click();
             showNotification("Grafik sedang diunduh...", "success");
         } else {
             showNotification("Tidak ada grafik statistik untuk diunduh.", "warning");
         }
     }
     btnDownloadChart.addEventListener('click', downloadChartImage);


    /********************************************************
     *      PROFILE SCREEN FUNCTIONS
     ********************************************************/
    // updateProfileInfo, renderProfileGuru, renderProfileSiswa, renderProfilePengisiToday, setPengisiHandler, getTodayDayName
    // remain largely the same
    async function updateProfileInfo() {
        profileAbsensiCountSpan.textContent = "Menghitung...";
        try {
            // Use local arrays for count simplicity
            const totalCount = historyAbsensi.length + archiveAbsensi.length;
            profileAbsensiCountSpan.textContent = totalCount.toLocaleString('id-ID');
        } catch (error) {
            console.error("Error menghitung total absensi:", error);
            profileAbsensiCountSpan.textContent = "Error";
        }
     }
    function renderProfileGuru() {
        profileGuruTbody.innerHTML = ""; // Clear table
        if (petugasGuru.length === 0) {
            profileGuruTbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data guru piket.</td></tr>';
            return;
        }

        const sorted = [...petugasGuru].sort((a, b) => {
            const dayDiff = dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari);
            if (dayDiff !== 0) return dayDiff;
            return a.nama.localeCompare(b.nama);
        });

        sorted.forEach((item) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${item.hari}</td>
            <td>${item.nama}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-guru" data-id="${item.id}">Edit</button>
                <button class="btn btn-danger btn-sm btn-hapus-guru" data-id="${item.id}" data-nama="${item.nama}">Hapus</button>
            </td>
            `;
            profileGuruTbody.appendChild(tr);
        });
     }
    function renderProfileSiswa() {
        profileSiswaList.innerHTML = ""; // Clear list
        if (petugasSiswa.length === 0) {
            profileSiswaList.innerHTML = "<li>Belum ada petugas siswa yang diatur.</li>";
        } else {
            petugasSiswa.forEach(nama => {
                const li = document.createElement('li');
                li.textContent = nama;
                profileSiswaList.appendChild(li);
            });
        }
     }
    function renderProfilePengisiToday() {
      const dayName = getTodayDayName();
      hariAktualSpan.textContent = dayName || "(Libur/Minggu)";
      dropdownPengisiSelect.innerHTML = ""; // Clear options

      if (!dayName) {
        // Weekend or error getting day name
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "(Hari ini libur)";
        opt.disabled = true;
        dropdownPengisiSelect.appendChild(opt);
        dropdownPengisiSelect.disabled = true;
         btnSetPengisi.disabled = true;
      } else {
        // Filter teachers for today
        const todayGuru = petugasGuru.filter(g => g.hari === dayName)
                                    .sort((a,b) => a.nama.localeCompare(b.nama)); // Sort names

        if (todayGuru.length === 0) {
          const opt = document.createElement('option');
          opt.value = "";
          opt.textContent = `(Tidak ada guru piket ${dayName})`;
          opt.disabled = true;
          dropdownPengisiSelect.appendChild(opt);
          dropdownPengisiSelect.disabled = true;
           btnSetPengisi.disabled = true;
        } else {
          // Add a default "Pilih..." option
           const defaultOpt = document.createElement('option');
           defaultOpt.value = "";
           defaultOpt.textContent = "-- Pilih Guru Pengisi --";
           dropdownPengisiSelect.appendChild(defaultOpt);

          // Add teachers for today
          todayGuru.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.nama;
            opt.textContent = g.nama;
            dropdownPengisiSelect.appendChild(opt);
          });
          dropdownPengisiSelect.disabled = false;
           btnSetPengisi.disabled = false;

            // Try to auto-select based on currentPengisi state
            if (currentPengisi && todayGuru.some(g => g.nama === currentPengisi)) {
                dropdownPengisiSelect.value = currentPengisi;
            } else if (todayGuru.length === 1) {
                 // If only one teacher today, auto-select them? Maybe not, let user confirm.
                 // dropdownPengisiSelect.value = todayGuru[0].nama;
            }

        }
      }

      // Update the display of the currently set pengisi
      currentPengisiSpan.textContent = currentPengisi || "(Belum diatur)";
      currentPengisiSpan.style.color = currentPengisi ? 'var(--success-color)' : 'var(--danger-color)'; // Use theme variable
    }
    async function setPengisiHandler() {
      const selectedGuru = dropdownPengisiSelect.value;

      // Don't allow setting empty string if there are options
      if (!selectedGuru && dropdownPengisiSelect.options.length > 1 && dropdownPengisiSelect.options[0].value === "") {
          showNotification("Harap pilih guru pengisi.", "warning");
          return;
      }

       const btn = btnSetPengisi;
       const originalText = btn.innerHTML;
       btn.disabled = true;
       dropdownPengisiSelect.disabled = true;
       btn.innerHTML = 'Menyimpan...';


      try {
        // Update the 'pengisi' document in Firestore
        await db.collection('currentPengisi').doc('pengisi').set({ nama: selectedGuru });
        // The onSnapshot listener will update the 'currentPengisi' variable and re-render
        showNotification(`Pengisi absensi saat ini diatur ke: ${selectedGuru || '(Tidak ada)'}`, "success");
      } catch (error) {
        console.error("Error menyimpan pengisi:", error);
        showNotification("Gagal menyimpan pengisi. Cek konsol.", "error");
      } finally {
           btn.disabled = false;
           dropdownPengisiSelect.disabled = (dropdownPengisiSelect.options.length <= 1 && !dropdownPengisiSelect.options[0]?.value); // Re-enable if options exist
           btn.innerHTML = originalText;
      }
    }
    function getTodayDayName() {
      const d = new Date();
      const dayNum = d.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
      if (dayNum === 0) return ""; // Sunday
      return dayOrder[dayNum - 1] || ""; // Get from dayOrder array
    }


    /********************************************************
     *                 HOME SCREEN FUNCTIONS
     ********************************************************/
    // renderHome, renderLatenessLineChart, renderTop5LateStudents
    // Need modification in renderLatenessLineChart to exclude holidays
    // Need modification in renderTop5LateStudents if using reset marker logic

    async function renderHome() {
      await renderLatenessLineChart();
      renderTop5LateStudents();
    }

    async function renderLatenessLineChart() {
        const canvas = chartLatenessLineCanvas;
        const container = chartLatenessLineContainer;
        const loader = container.querySelector('.loader-container');
        const combinedData = [...historyAbsensi, ...archiveAbsensi];


        // Clear previous chart & show loader
        if (latenessLineChart) {
            latenessLineChart.destroy();
            latenessLineChart = null;
        }
        canvas.style.display = 'none';
        loader.style.display = 'block';
         loader.innerHTML = '<div class="loader"></div>'; // Ensure loader is visible

        // Use setTimeout to allow loader to show
        setTimeout(() => {
             try {
                 if (combinedData.length === 0) {
                     console.log("No attendance data for dashboard chart.");
                     loader.innerHTML = "<p>Belum ada data keterlambatan.</p>";
                     return;
                 }

                // Find latest month with data
                 const latestDate = combinedData.reduce((max, item) => item.tanggal > max ? item.tanggal : max, combinedData[0].tanggal);
                 const latestMonth = latestDate.slice(0,7);

                const monthlyData = combinedData.filter(item => item.tanggal.startsWith(latestMonth) && item.status === "late");
                 const latenessByDate = {};
                 const year = parseInt(latestMonth.slice(0, 4));
                 const month = parseInt(latestMonth.slice(5, 7));
                 const daysInMonth = new Date(year, month, 0).getDate();
                 const dates = []; // Labels for the chart

                 for (let day = 1; day <= daysInMonth; day++) {
                     const dateStr = `${latestMonth}-${day.toString().padStart(2, '0')}`;
                      if (!isHoliday(dateStr)) {
                         dates.push(dateStr);
                         latenessByDate[dateStr] = 0;
                     }
                 }
                monthlyData.forEach(item => {
                     if(latenessByDate[item.tanggal] !== undefined) {
                        latenessByDate[item.tanggal]++;
                     }
                });
                 const counts = dates.map(date => latenessByDate[date]);

                  // Check if there's actually data to plot
                  if (dates.length === 0 || counts.every(c => c === 0)) {
                       console.log("No lateness data in the latest month to plot.");
                       loader.innerHTML = `<p>Tidak ada data keterlambatan untuk bulan ${latestMonth}.</p>`;
                       return;
                  }

                 const ctx = canvas.getContext('2d');
                 latenessLineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                        label: `Jumlah Keterlambatan Harian (${latestMonth})`,
                        data: counts,
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                        }]
                    },
                     options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, suggestedMax: Math.max(...counts, 5) + 2 },
                            x: { ticks: { autoSkip: true, maxTicksLimit: (window.innerWidth < 768 ? 10 : 15) } }
                        },
                        plugins: {
                             title: { display: true, text: `Tren Keterlambatan Harian (Bulan: ${latestMonth})`, font: {size: 14} },
                             legend: { display: false },
                             tooltip: { callbacks: { label: ctx => ` Keterlambatan: ${ctx.parsed.y}` } }
                        }
                    }
                });

                loader.style.display = 'none';
                canvas.style.display = 'block';

             } catch (error) {
                 console.error("Error merender grafik keterlambatan dashboard:", error);
                 showNotification("Gagal membuat grafik tren keterlambatan.", "error");
                 loader.innerHTML = "<p>Gagal memuat grafik.</p>";
             }
        }, 10);
    }

    function renderTop5LateStudents() {
      dashboardTop5TableBody.innerHTML = "";
       if (dataKeterlambatan.length === 0) {
          dashboardTop5TableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data keterlambatan.</td></tr>';
          return;
       }

      const top5 = [...dataKeterlambatan]
                    .filter(siswa => siswa.terlambat_total > 0)
                    .sort((a, b) => b.terlambat_total - a.terlambat_total)
                    .slice(0, 5);

       if (top5.length === 0) {
          dashboardTop5TableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Tidak ada siswa yang terlambat.</td></tr>';
          return;
      }

      top5.forEach((siswa, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align: center; font-weight: bold;">${index + 1}</td>
          <td><span class="clickable-name" data-nama="${siswa.nama}" title="Lihat Detail ${siswa.nama}">${siswa.nama} (${siswa.kelas || '?'})</span></td> <!-- Added kelas, clickable -->
          <td style="text-align: center; font-weight: bold;">${siswa.terlambat_total}</td>
        `;
        dashboardTop5TableBody.appendChild(tr);
      });
    }
     // Event delegation for Home table clicks (NEW)
     dashboardTop5TableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('clickable-name')) {
            showSiswaDetailModal(event.target.dataset.nama);
        }
     });


     /********************************************************
      *     KELOLA HARI LIBUR (Settings Screen) - NEW
      ********************************************************/
     async function tambahHariLiburHandler(event) {
         event.preventDefault();
         const tanggal = liburTanggalInput.value;
         const keterangan = liburKeteranganInput.value.trim();

         if (!tanggal || !keterangan) {
             showNotification("Tanggal dan Keterangan libur wajib diisi.", "warning"); return;
         }
          if (hariLibur.some(libur => libur.tanggal === tanggal)) {
              showNotification(`Tanggal ${tanggal} sudah ditandai sebagai hari libur.`, "warning"); return;
          }
          if (!isValidDate(tanggal)) { // Basic format check
                showNotification("Format tanggal tidak valid (YYYY-MM-DD).", "warning"); return;
          }


         const liburData = { tanggal, keterangan };
         try {
             await addData('hariLibur', liburData, `Hari libur ${tanggal} (${keterangan}) berhasil ditambahkan.`, btnTambahHariLibur);
             formTambahHariLibur.reset();
             // Table updated by listener
         } catch (error) { /* Handled by addData */ }
     }

     function renderHariLiburTable() {
         hariLiburTableBody.innerHTML = "";
         if (hariLibur.length === 0) {
             hariLiburTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data hari libur.</td></tr>';
             return;
         }
         const sortedLibur = [...hariLibur].sort((a, b) => b.tanggal.localeCompare(a.tanggal));
         sortedLibur.forEach(libur => {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                 <td>${libur.tanggal}</td>
                 <td>${libur.keterangan}</td>
                 <td>
                     <button class="btn btn-danger btn-sm btn-hapus-libur" data-id="${libur.id}" data-tanggal="${libur.tanggal}">Hapus</button>
                 </td>
             `;
             hariLiburTableBody.appendChild(tr);
         });
     }

     async function hapusHariLibur(liburId, tanggal) {
         showConfirmModal(`Yakin ingin menghapus hari libur pada tanggal ${tanggal}?`, async () => {
             try {
                 await deleteData('hariLibur', liburId, `Hari libur ${tanggal} berhasil dihapus.`);
                 // Table updated by listener
             } catch (error) { /* Handled by deleteData */ }
         });
     }
     // Event listeners for holiday management
     formTambahHariLibur.addEventListener('submit', tambahHariLiburHandler);
     hariLiburTableBody.addEventListener('click', (event) => {
         if (event.target.classList.contains('btn-hapus-libur')) {
             hapusHariLibur(event.target.dataset.id, event.target.dataset.tanggal);
         }
     });


    /********************************************************
     *               UTILITY & THEME FUNCTIONS
     ********************************************************/
    function capitalizeFirstLetter(string) {
        if (!string) return "";
        return string.charAt(0).toUpperCase() + string.slice(1);
     }
    function sortData(a, b, sortState) {
        const valA = a[sortState.column];
        const valB = b[sortState.column];
        let comparison = 0;

        if (typeof valA === 'string' && typeof valB === 'string') {
            comparison = valA.localeCompare(valB, 'id-ID'); // Indonesian locale compare
        } else if (typeof valA === 'number' && typeof valB === 'number') {
            comparison = valA - valB;
        } else {
             const strA = String(valA ?? '');
             const strB = String(valB ?? '');
             comparison = strA.localeCompare(strB, 'id-ID');
        }
        return sortState.direction === 'asc' ? comparison : (comparison * -1);
     }
    function addTableSorting(tableElement, sortState, renderFunction) {
        const headers = tableElement.querySelectorAll('th.sortable');
         headers.forEach(th => {
             th.addEventListener('click', () => {
                 const column = th.dataset.sortColumn;
                 if (sortState.column === column) {
                     sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                 } else {
                     sortState.column = column;
                     sortState.direction = 'asc'; // Default to ascending on new column
                 }
                 renderFunction(); // Re-render the table with new sort order
             });
         });
     }
    function updateSortIcons(theadElement, sortState) {
        theadElement.querySelectorAll('th.sortable .sort-icon').forEach(icon => {
            icon.textContent = ''; // Clear existing icons
        });
        const activeHeader = theadElement.querySelector(`th[data-sort-column="${sortState.column}"]`);
        if (activeHeader) {
            const iconSpan = activeHeader.querySelector('.sort-icon');
            if(iconSpan) iconSpan.textContent = sortState.direction === 'asc' ? ' ▲' : ' ▼';
        }
     }
    function addTableSearch(searchInput, tableBodyId, dataArray, renderFunction) { /* ... (Not directly used now, filtering handled centrally) ... */ }

     // Helper to check valid YYYY-MM-DD format
     function isValidDate(dateString) {
        const regEx = /^\d{4}-\d{2}-\d{2}$/;
        if(!dateString.match(regEx)) return false;
        const d = new Date(dateString);
        // Check if the date object is valid and the components match the input string
        // This handles cases like '2023-02-30' which create an invalid date object
        // or are adjusted by the Date constructor (e.g., to March 2nd).
         const dNum = d.getTime();
         if (!dNum && dNum !== 0) return false; // NaN value, Invalid date
         // Check if the string date matches the ISO string date to catch invalid dates
         try {
             return d.toISOString().slice(0,10) === dateString;
         } catch (e) {
             return false; // Handle potential errors with toISOString on invalid dates
         }
    }


     // NEW: Get Day Name (Indonesian)
     function getDayNameFromDate(dateString) {
        try {
            // Use UTC methods to avoid timezone offset issues when determining the day
             const dateParts = dateString.split('-');
             const date = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])));
             const dayNum = date.getUTCDay(); // 0 = Sunday, 6 = Saturday
             return dayOrder[dayNum - 1] || ""; // Sunday (0) maps to undefined, returns ""
        } catch (e) {
            console.error("Error getting day name from date:", dateString, e);
            return "";
        }
    }

     // --- NEW: Theme Toggle Logic ---
     function setInitialTheme() {
         const savedTheme = localStorage.getItem('theme') || 'light';
         document.body.setAttribute('data-theme', savedTheme);
         updateThemeIcon(savedTheme);
     }
     function updateThemeIcon(theme) {
          const icon = themeToggleButton.querySelector('i');
          if (icon) {
              icon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`;
          }
          themeToggleButton.title = `Ganti ke Tema ${theme === 'dark' ? 'Terang' : 'Gelap'}`;
     }
     themeToggleButton.addEventListener('click', () => {
        let currentTheme = document.body.getAttribute('data-theme');
        let newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
         // Re-render charts on theme change if needed for color updates
         if (currentScreen === 'statistikScreen' && (chartObj || latenessLineChart)) {
              // Slight delay to allow CSS vars to apply? Might not be necessary.
              // setTimeout(renderStatisticChartHandler, 50);
              renderStatisticChartHandler(); // Re-render the current statistic chart
         }
         if (currentScreen === 'homeScreen' && latenessLineChart) {
              // Dashboard chart might also need update
              renderLatenessLineChart();
         }

     });


    /********************************************************
     *                INITIALIZATION
     ********************************************************/
    function init() {
        // FIX: Assign notificationArea HERE, after DOM is loaded
        notificationArea = document.getElementById('notification-area');
        if (!notificationArea) {
            console.error("CRITICAL: Notification area element not found in the DOM during init!");
            // Optionally display an alert or disable notifications
            alert("Area notifikasi tidak ditemukan! Notifikasi tidak akan muncul.");
        }


        // **PENTING**: Panggil initializeFirebase SEBELUM listener lain yg butuh 'db'
        initializeFirebase(); // Now this just gets the db reference

        setupNavListeners();
        // Form submit listeners
        absensiForm.addEventListener('submit', catatKehadiran);
        bulkAbsensiForm.addEventListener('submit', catatBulkAbsensiHandler); // New
        formTambahGuru.addEventListener('submit', tambahPetugasGuruHandler);
        formSimpanSiswaPiket.addEventListener('submit', simpanPetugasSiswaHandler);
        formTambahSiswa.addEventListener('submit', tambahSiswaHandler);
        formTambahHariLibur.addEventListener('submit', tambahHariLiburHandler); // New
        editGuruForm.addEventListener('submit', handleEditGuruSubmit);

        // Button click listeners
        btnSetPengisi.addEventListener('click', setPengisiHandler);
        btnResetSemuaKeterlambatan.addEventListener('click', resetSemuaKeterlambatanHandler);
        btnHapusSemuaSiswa.addEventListener('click', hapusSemuaSiswaHandler);
        btnHapusPilihSiswa.addEventListener('click', hapusPilihSiswaHandler);
        btnImportDataSiswa.addEventListener('click', importDataSiswaHandler);
        btnRenderChart.addEventListener('click', renderStatisticChartHandler);
        btnDownloadMonthly.addEventListener('click', downloadMonthlyDataHandler);
        btnDownloadChart.addEventListener('click', downloadChartImage); // New
        // Filter buttons
        btnApplyHistoryFilter.addEventListener('click', applyHistoryFiltersAndRender);
        btnResetHistoryFilters.addEventListener('click', resetHistoryFiltersHandler);
        btnApplyKeterlambatanFilter.addEventListener('click', applyKeterlambatanFiltersAndRender);
        btnResetKeterlambatanFilter.addEventListener('click', resetKeterlambatanFiltersHandler);

         // Other event listeners
         selectAllSiswaCheckbox.addEventListener('change', (e) => toggleSelectAllSiswa(e.target));
         statusKedatanganSelect.addEventListener('change', toggleAbsensiFieldsVisibility);
         dropdownAlasanSelect.addEventListener('change', toggleAbsensiFieldsVisibility);
         bulkStatusKedatanganSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility); // New
         bulkDropdownAlasanSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility); // New
         tanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(tanggalAbsenInput, holidayWarning)); // New
         bulkTanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(bulkTanggalAbsenInput, bulkHolidayWarning)); // New
         chartOptionSelect.addEventListener('change', handleChartOptionChange); // New

         // Setup Table Sorting
         addTableSorting(dataSiswaTableBody.closest('table'), siswaSort, () => renderDataSiswaTable()); // renderDataSiswaTable handles search internally
         addTableSorting(dataKeterlambatanTableBody.closest('table'), keterlambatanSort, applyKeterlambatanFiltersAndRender); // Re-filter/render on sort
         addTableSorting(historyTableBody.closest('table'), historySort, applyHistoryFiltersAndRender); // Re-filter/render on sort

         // Setup Table Searching (Live Filtering - connect to filter functions)
         searchDataSiswaTableInput.addEventListener('input', () => renderDataSiswaTable()); // Render handles search internally now
         searchKeterlambatanInput.addEventListener('input', applyKeterlambatanFiltersAndRender); // Trigger filter on search input
         searchHistoryInput.addEventListener('input', applyHistoryFiltersAndRender); // Trigger filter on search input


         // Initial state setup
         tanggalAbsenInput.valueAsDate = new Date();
         bulkTanggalAbsenInput.valueAsDate = new Date();
         toggleAbsensiFieldsVisibility();
         toggleBulkAbsensiFieldsVisibility();
         setInitialTheme(); // Apply theme on load
         handleChartOptionChange(); // Set initial chart filter visibility

        // showScreen(currentScreen); // Called inside initialRender now after data load attempt
    }

     // Helper filter function for Data Siswa search (used by renderDataSiswaTable)
     function filterDataSiswa(data, term) {
         const lowerTerm = term.toLowerCase();
         if (!lowerTerm) return data;
         return data.filter(siswa =>
             siswa.nama.toLowerCase().includes(lowerTerm) ||
             siswa.kelas.toLowerCase().includes(lowerTerm) ||
             siswa.nis.toLowerCase().includes(lowerTerm) ||
             siswa.waliKelas.toLowerCase().includes(lowerTerm)
         );
     }


    // Run initialization when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
