<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi & Keterlambatan - Guru Piket + Pengisi</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- SheetJS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    /* ========== RESET & GLOBAL STYLES ========== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background-color: #f0f2f5;
      color: #333;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    button {
      cursor: pointer;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      transform: translateY(-2px);
    }
    /* ========== HEADER STYLES ========== */
    header {
      background-color: #4a90e2;
      color: #fff;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 {
      font-size: 2rem;
      margin: 0;
    }

    /* ========== NAVBAR STYLES ========== */
    nav {
      background-color: #fff;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 80px;
      z-index: 100;
    }
    nav .nav-item {
      margin: 5px 10px;
      padding: 10px 15px;
      background-color: #4a90e2;
      color: #fff;
      border-radius: 20px;
      transition: background-color 0.3s ease;
    }
    nav .nav-item:hover {
      background-color: #357ABD;
    }

    /* ========== CONTAINER & SCREEN STYLES ========== */
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .screen {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    .active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== FORM & INPUT STYLES ========== */
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="date"],
    input[type="month"],
    select,
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="month"]:focus,
    select:focus,
    input[type="file"]:focus {
      border-color: #4a90e2;
      outline: none;
    }
    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* ========== BUTTON STYLES ========== */
    .btn-primary {
      background-color: #4a90e2;
      color: #fff;
    }
    .btn-primary:hover {
      background-color: #357ABD;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: #fff;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-secondary {
      background-color: #95a5a6;
      color: #fff;
    }
    .btn-secondary:hover {
      background-color: #7f8c8d;
    }

    /* ========== TABLE STYLES ========== */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #4a90e2;
      color: #fff;
    }
    tr:hover {
      background-color: #f1f1f1;
    }

    /* ========== STATUS BOX STYLES ========== */
    .status-box {
      margin-top: 15px;
      padding: 15px;
      background-color: #dff0d8;
      border: 1px solid #d0e9c6;
      border-radius: 5px;
      color: #3c763d;
      font-weight: bold;
    }

    /* ========== DASHBOARD STYLES ========== */
    .dashboard-section {
      margin-bottom: 40px;
    }
    .dashboard-card {
      padding: 20px;
      background-color: #ecf0f1;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dashboard-card h3 {
      margin-bottom: 20px;
      color: #34495e;
    }

    /* ========== MODAL STYLES ========== */
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.5s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .close:hover {
      color: #333;
    }

    /* ========== FOOTER STYLES ========== */
    footer {
      background-color: #fff;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      margin-top: 40px;
    }
    .footer-line {
      width: 50px;
      height: 4px;
      background-color: #4a90e2;
      margin: 0 auto 10px auto;
      border-radius: 2px;
    }
    footer p {
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    /* ========== RESPONSIVE STYLES ========== */
    @media (max-width: 768px) {
      nav {
        flex-direction: column;
      }
      .nav-item {
        margin: 5px 0;
        width: 90%;
        text-align: center;
      }
      .modal-content {
        width: 95%;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <h1>Absensi & Keterlambatan</h1>
  </header>

  <!-- NAVBAR -->
  <nav>
    <a href="#" class="nav-item" onclick="showScreen('homeScreen')">Home</a>
    <a href="#" class="nav-item" onclick="showScreen('absensiScreen')">Input Absensi</a>
    <a href="#" class="nav-item" onclick="showScreen('terlambatScreen')">Data Keterlambatan</a>
    <a href="#" class="nav-item" onclick="showScreen('historyScreen')">History</a>
    <a href="#" class="nav-item" onclick="showScreen('statistikScreen')">Statistik</a>
    <a href="#" class="nav-item" onclick="showScreen('settingsScreen')">Settings</a>
    <a href="#" class="nav-item" onclick="showScreen('profileScreen')">Profile</a>
    <a href="#" class="nav-item" onclick="showScreen('dataSiswaScreen')">Data Siswa</a>
  </nav>

  <!-- MAIN CONTAINER -->
  <div class="container">

    <!-- ========== SCREEN: HOME (DASHBOARD) ========== -->
    <div id="homeScreen" class="screen active">
      <h2>Dashboard Home</h2>

      <!-- Grafik Kehadiran Bulanan -->
      <div class="dashboard-section">
        <div class="dashboard-card">
          <h3>Grafik Kehadiran Siswa Selama Sebulan Terakhir</h3>
          <canvas id="chartAttendanceLine" style="max-width:800px;"></canvas>
        </div>
      </div>

      <!-- Top 5 Siswa dengan Keterlambatan Terbanyak -->
      <div class="dashboard-section">
        <div class="dashboard-card">
          <h3>Top 5 Siswa dengan Keterlambatan Terbanyak</h3>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Nama Siswa</th>
                <th>Total Keterlambatan</th>
              </tr>
            </thead>
            <tbody id="dashboardTop5TableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: INPUT ABSENSI ========== -->
    <div id="absensiScreen" class="screen">
      <h2>Form Absensi</h2>
      <div id="absensiStatus" class="status-box" style="display:none;"></div>
      <form onsubmit="catatKehadiran(event)">
        <label for="namaSiswa">Nama Siswa:</label>
        <input type="text" id="namaSiswa" list="siswaList" required>
        <datalist id="siswaList">
          <!-- Options akan diisi oleh JavaScript -->
        </datalist>

        <label for="tanggalAbsen">Tanggal:</label>
        <input type="date" id="tanggalAbsen" required>

        <label for="statusKedatangan">Status Kedatangan:</label>
        <select id="statusKedatangan" required onchange="toggleAlasanCustom()">
          <option value="">-- Pilih Status --</option>
          <option value="late">Terlambat</option>
          <option value="izin">Izin</option>
          <option value="dipulangkan">Dipulangkan</option>
        </select>

        <label for="dropdownAlasan">Alasan (Jika diperlukan):</label>
        <select id="dropdownAlasan">
          <option value="">-- Pilih Alasan --</option>
          <option value="Bangun kesiangan">Bangun kesiangan</option>
          <option value="Macet/Transportasi bermasalah">Macet/Transportasi bermasalah</option>
          <option value="Alasan kesehatan (sakit ringan)">Alasan kesehatan (sakit ringan)</option>
          <option value="Menemani keluarga yang membutuhkan">Menemani keluarga yang membutuhkan</option>
          <option value="Lupa membawa peralatan sekolah">Lupa membawa peralatan sekolah</option>
          <option value="Cuaca ekstrem (hujan/banjir)">Cuaca ekstrem (hujan/banjir)</option>
          <option value="Urusan keluarga mendadak">Urusan keluarga mendadak</option>
        </select>

        <div id="alasanCustomContainer" style="display:none;">
          <label for="alasanCustom">Alasan Custom:</label>
          <input type="text" id="alasanCustom" placeholder="Tulis alasan kustom...">
        </div>

        <button type="submit" class="btn-primary">Catat Absensi</button>
      </form>
    </div>

    <!-- ========== SCREEN: DATA KETERLAMBATAN ========== -->
    <div id="terlambatScreen" class="screen">
      <h2>Data Keterlambatan</h2>
      <button class="btn-danger" onclick="resetSemuaKeterlambatan()">Reset Semua Keterlambatan</button>
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Terlambat Total</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="dataKeterlambatanTable"></tbody>
      </table>
    </div>

    <!-- ========== SCREEN: HISTORY ========== -->
    <div id="historyScreen" class="screen">
      <h2>Riwayat Absensi</h2>
      <div class="filter-section">
        <h3>Filter / Analisis</h3>
        <label for="filterDate">Filter Harian:</label>
        <input type="date" id="filterDate">
        <button class="btn-secondary" onclick="filterHistoryByDate()">Filter</button>

        <label for="filterStartDate" style="margin-top:15px;">Filter Rentang Tanggal:</label>
        <input type="date" id="filterStartDate">
        <input type="date" id="filterEndDate">
        <button class="btn-secondary" onclick="filterHistoryByDateRange()">Filter</button>

        <button class="btn-secondary" style="margin-top:15px;" onclick="resetHistoryFilters()">Reset Filter</button>
        <div id="filterResult" style="display:none; margin-top:15px;" class="status-box"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Nama Siswa</th>
            <th>Status</th>
            <th>Alasan</th>
            <th>Pengisi (Guru)</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>

    <!-- ========== SCREEN: STATISTIK ========== -->
    <div id="statistikScreen" class="screen">
      <h2>Statistik</h2>
      <div style="display:flex; flex-wrap:wrap; gap:20px; align-items: center;">
        <div>
          <label for="chartOption">Pilih Grafik:</label>
          <select id="chartOption">
            <option value="siswa">Siswa Paling Sering Telat</option>
            <option value="alasan">Alasan Paling Sering</option>
            <option value="bulanan">Grafik Keterlambatan Bulanan</option>
          </select>
          <button class="btn-primary" onclick="renderStatisticChart()">Tampilkan Grafik</button>
        </div>

        <div>
          <label for="statistikBulan">Pilih Bulan untuk Statistik:</label>
          <input type="month" id="statistikBulan">
          <button class="btn-primary" onclick="renderStatisticChart()">Tampilkan Statistik Bulanan</button>
        </div>
      </div>

      <canvas id="chartStatistic" style="max-width:800px; margin-top:30px;"></canvas>

      <div id="downloadSection" style="margin-top:30px; display:none;">
        <button class="btn-primary" onclick="downloadMonthlyData()">Download Data Bulanan (Excel)</button>
      </div>
    </div>

    <!-- ========== SCREEN: SETTINGS ========== -->
    <div id="settingsScreen" class="screen">
      <h2>Settings</h2>

      <!-- Petugas Piket Guru -->
      <div style="margin-bottom:30px;">
        <h3>Input Petugas Piket Guru (Harian, Max 10)</h3>
        <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: center; margin-bottom:15px;">
          <div style="flex:1;">
            <label for="guruNama">Nama Guru:</label>
            <input type="text" id="guruNama" placeholder="Contoh: Pak Andi">
          </div>
          <div style="flex:1;">
            <label for="guruHari">Hari Piket:</label>
            <select id="guruHari">
              <option value="">-- Pilih Hari --</option>
              <option value="Senin">Senin</option>
              <option value="Selasa">Selasa</option>
              <option value="Rabu">Rabu</option>
              <option value="Kamis">Kamis</option>
              <option value="Jumat">Jumat</option>
              <option value="Sabtu">Sabtu</option>
            </select>
          </div>
          <div style="align-self: flex-end;">
            <button class="btn-primary" onclick="tambahPetugasGuru()">Tambah Guru</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nama Guru</th>
              <th>Hari</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="petugasGuruTable"></tbody>
        </table>
      </div>

      <hr>

      <!-- Petugas Piket Siswa -->
      <div style="margin-bottom:30px;">
        <h3>Input Petugas Piket Siswa (2 Orang)</h3>
        <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: center; margin-bottom:15px;">
          <div style="flex:1;">
            <label for="siswa1">Siswa 1:</label>
            <input type="text" id="siswa1" placeholder="Contoh: Budi">
          </div>
          <div style="flex:1;">
            <label for="siswa2">Siswa 2:</label>
            <input type="text" id="siswa2" placeholder="Contoh: Susi">
          </div>
          <div style="align-self: flex-end;">
            <button class="btn-primary" onclick="simpanPetugasSiswa()">Simpan Siswa</button>
          </div>
        </div>
      </div>

      <hr>

      <!-- Pengaturan Lainnya -->
      <div>
        <h3>Pengaturan Lainnya</h3>
        <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: center; margin-bottom:15px;">
          <div style="flex:1;">
            <label for="languageSelect">Pilih Bahasa:</label>
            <select id="languageSelect">
              <option value="id">Bahasa Indonesia</option>
              <option value="en">English</option>
            </select>
          </div>
          <div style="align-self: flex-end;">
            <button class="btn-primary" onclick="alert('Pengaturan belum diimplementasikan.')">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: PROFILE ========== -->
    <div id="profileScreen" class="screen">
      <h2>Profil Petugas & Pengisi</h2>
      <p>Total Data Absensi: <strong id="profileAbsensiCount">0</strong></p>

      <hr>

      <!-- Daftar Petugas Guru -->
      <div style="margin-bottom:30px;">
        <h3>Daftar Petugas Guru (Urutan Senin–Sabtu)</h3>
        <table>
          <thead>
            <tr>
              <th>Hari</th>
              <th>Nama Guru</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="profileGuruTbody"></tbody>
        </table>
      </div>

      <!-- Daftar Petugas Siswa -->
      <div style="margin-bottom:30px;">
        <h3>Daftar Petugas Siswa (2 Orang)</h3>
        <ul id="profileSiswaList" style="list-style-type: disc; padding-left: 20px;"></ul>
      </div>

      <!-- Pengisi Hari Ini -->
      <div>
        <h3>Pengisi (Guru) Sesuai Hari Aktual</h3>
        <p>Hari ini: <strong id="hariAktualSpan">-</strong></p>
        <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: center; margin-top:10px;">
          <div style="flex:1;">
            <label for="dropdownPengisi">Pilih Guru (Hari Ini):</label>
            <select id="dropdownPengisi">
              <!-- Options akan diisi oleh JavaScript -->
            </select>
          </div>
          <div style="align-self: flex-end;">
            <button class="btn-primary" onclick="setPengisi()">Set Pengisi</button>
          </div>
        </div>
        <p style="margin-top:15px;">Pengisi Saat Ini: <strong id="currentPengisiSpan">-</strong></p>
      </div>

      <!-- Modal untuk Mengedit Guru Piket -->
      <div id="editGuruModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeEditGuruModal()">&times;</span>
          <h3>Edit Guru Piket</h3>
          <form id="editGuruForm">
            <input type="hidden" id="editGuruId">
            <label for="editGuruNama">Nama Guru:</label>
            <input type="text" id="editGuruNama" required>
            <label for="editGuruHari">Hari Piket:</label>
            <select id="editGuruHari" required>
              <option value="">-- Pilih Hari --</option>
              <option value="Senin">Senin</option>
              <option value="Selasa">Selasa</option>
              <option value="Rabu">Rabu</option>
              <option value="Kamis">Kamis</option>
              <option value="Jumat">Jumat</option>
              <option value="Sabtu">Sabtu</option>
            </select>
            <button type="submit" class="btn-primary" style="margin-top:15px;">Simpan Perubahan</button>
          </form>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: DATA SISWA ========== -->
    <div id="dataSiswaScreen" class="screen">
      <h2>Data Siswa</h2>

      <!-- Form Tambah Siswa -->
      <div style="margin-bottom:30px;">
        <h3>Tambah Siswa</h3>
        <form onsubmit="tambahSiswa(event)">
          <div style="display:flex; flex-wrap:wrap; gap:15px;">
            <div style="flex:1;">
              <label for="dataSiswaNama">Nama Siswa:</label>
              <input type="text" id="dataSiswaNama" placeholder="Contoh: Ahmad" required>
            </div>
            <div style="flex:1;">
              <label for="dataSiswaKelas">Kelas:</label>
              <input type="text" id="dataSiswaKelas" placeholder="Contoh: 10 IPA 1" required>
            </div>
            <div style="flex:1;">
              <label for="dataSiswaNIS">NIS:</label>
              <input type="text" id="dataSiswaNIS" placeholder="Contoh: 123456" required>
            </div>
            <div style="flex:1;">
              <label for="dataSiswaWaliKelas">Wali Kelas:</label>
              <input type="text" id="dataSiswaWaliKelas" placeholder="Contoh: Ibu Sari" required>
            </div>
          </div>
          <button type="submit" class="btn-primary" style="margin-top:15px;">Tambah Siswa</button>
        </form>
      </div>

      <!-- Import Data Siswa -->
      <div style="margin-bottom:30px;">
        <h3>Import Data Siswa dari Excel</h3>
        <input type="file" id="importFileSiswa" accept=".xlsx, .xls">
        <button class="btn-primary" onclick="importDataSiswa()" style="margin-top:10px;">Import Data Siswa</button>
      </div>

      <!-- Tombol Hapus Semua & Hapus Pilih -->
      <div style="margin-bottom:30px;">
        <button class="btn-danger" onclick="hapusSemuaSiswa()">Hapus Semua</button>
        <button class="btn-danger" onclick="hapusPilihSiswa()" style="margin-left:10px;">Hapus Pilih</button>
      </div>

      <!-- Tabel Data Siswa -->
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
            <th>Nama Siswa</th>
            <th>Kelas</th>
            <th>NIS</th>
            <th>Wali Kelas</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="dataSiswaTable"></tbody>
      </table>
    </div>

  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-line"></div>
    <p>
      Created by <br>
      Antonius Elga Kurnia, S.Pd.
    </p>
  </footer>

  <!-- JAVASCRIPT -->
  <script>
    /********************************************************
     *                VAR & STATE
     ********************************************************/
    let currentScreen = "homeScreen";

    // Guru array: {id, nama, hari} => max 10. 
    let petugasGuru = [];
    let petugasSiswa = []; // array of 2 strings
    let currentPengisi = ""; // guru yg input data

    // Data Absensi & Rekap
    let historyAbsensi = [];
    let archiveAbsensi = [];
    let dataSiswa = {}; // {nama: {terlambat_total, terlambat_mingguan, last_date}}
    let databaseSiswa = []; // Array of siswa {nama, kelas, nis, waliKelas}

    // Data Keterlambatan
    let dataKeterlambatan = []; // Array of {nama, terlambat_total}

    let chartObj = null;
    let attendanceLineChart = null; // Untuk Grafik Kehadiran Bulanan

    // Definisikan urutan hari
    const dayOrder = ["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];

    /********************************************************
     *          FUNGSI UNTUK FIRESTORE CRUD
     ********************************************************/
    async function loadData() {
      try {
        // Load historyAbsensi
        db.collection('historyAbsensi').onSnapshot(snapshot => {
          historyAbsensi = [];
          snapshot.forEach(doc => {
            historyAbsensi.push(doc.data());
          });
          recalcDataSiswaFromHistory();
          renderHistoryTable();
          renderDataKeterlambatanTable();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        // Load archiveAbsensi
        db.collection('archiveAbsensi').onSnapshot(snapshot => {
          archiveAbsensi = [];
          snapshot.forEach(doc => {
            archiveAbsensi.push(doc.data());
          });
          recalcDataSiswaFromHistory();
          renderHistoryTable();
          renderDataKeterlambatanTable();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        // Load petugasGuru dengan menyertakan docId
        db.collection('petugasGuru').onSnapshot(snapshot => {
          petugasGuru = [];
          snapshot.forEach(doc => {
            petugasGuru.push({ id: doc.id, ...doc.data() });
          });
          renderPetugasGuruTable();
          renderProfileGuru();
          renderProfilePengisiToday();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        // Load petugasSiswa
        db.collection('petugasSiswa').onSnapshot(snapshot => {
          petugasSiswa = [];
          snapshot.forEach(doc => {
            petugasSiswa.push(doc.data().nama);
          });
          renderProfileSiswa();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        // Load databaseSiswa
        db.collection('databaseSiswa').onSnapshot(snapshot => {
          databaseSiswa = [];
          snapshot.forEach(doc => {
            databaseSiswa.push(doc.data());
          });
          renderDataSiswaTable();
          renderDataSiswaList();
          renderProfilePengisiToday();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        // Load dataKeterlambatan
        db.collection('dataKeterlambatan').onSnapshot(snapshot => {
          dataKeterlambatan = [];
          snapshot.forEach(doc => {
            dataKeterlambatan.push(doc.data());
          });
          renderDataKeterlambatanTable();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        // Load currentPengisi
        db.collection('currentPengisi').doc('pengisi').onSnapshot(doc => {
          currentPengisi = doc.exists ? doc.data().nama : "";
          renderProfilePengisiToday();
          renderHome(); // Update Home dashboard jika diperlukan
        });

        console.log("Data berhasil dimuat dari Firestore.");
      } catch (error) {
        console.error("Error memuat data dari Firestore:", error);
        alert("Terjadi kesalahan saat memuat data.");
      }
    }

    /********************************************************
     *          FUNGSI ARCHIVE DATA MINGGUAN
     ********************************************************/
    async function archiveWeeklyData() {
      try {
        // Mendapatkan tanggal terakhir arsip
        let settingsDoc = await db.collection('settings').doc('archiveDate').get();
        let lastArchiveDate = settingsDoc.exists ? settingsDoc.data().lastArchiveDate.toDate() : null;
        let today = new Date();

        if(!lastArchiveDate) {
          // Jika belum pernah diarsipkan, set ke hari ini
          await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
          return;
        }

        // Hitung perbedaan minggu
        let diffTime = today - lastArchiveDate;
        let diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));

        if(diffWeeks >=1){
          // Pindahkan historyAbsensi ke archiveAbsensi
          let batch = db.batch();
          historyAbsensi.forEach(record => {
            let docRef = db.collection('archiveAbsensi').doc();
            batch.set(docRef, record);
          });
          // Hapus semua historyAbsensi
          let historySnapshot = await db.collection('historyAbsensi').get();
          historySnapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          historyAbsensi = [];

          // Reset jumlah keterlambatan mingguan jika diperlukan
          // Anda dapat menambahkan logika reset keterlambatan mingguan di sini

          // Update lastArchiveDate
          await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });

          alert("Data absensi minggu lalu telah diarsipkan.");
        }
      } catch (error) {
        console.error("Error mengarsipkan data:", error);
        alert("Terjadi kesalahan saat mengarsipkan data.");
      }
    }

    /********************************************************
     *                NAVIGASI MENU
     ********************************************************/
    function showScreen(screenId) {
      document.getElementById(currentScreen)?.classList.remove('active');
      document.getElementById(screenId)?.classList.add('active');
      currentScreen = screenId;

      // Refresh tampilan
      if (screenId === 'terlambatScreen') {
        renderDataKeterlambatanTable();
      }
      if (screenId === 'historyScreen') {
        renderHistoryTable();
      }
      if (screenId === 'profileScreen') {
        updateProfileInfo();    
        renderProfileGuru();    
        renderProfileSiswa();   
        renderProfilePengisiToday(); 
      }
      if (screenId === 'settingsScreen') {
        renderPetugasGuruTable(); // Supaya tampilan table guru di Settings update
      }
      if (screenId === 'dataSiswaScreen') {
        renderDataSiswaTable();
        renderDataSiswaList(); // Update datalist untuk autocomplete
      }
      if (screenId === 'statistikScreen') {
        // Jika grafik sudah ada, destroy untuk update
        if(chartObj) chartObj.destroy();
        if(attendanceLineChart) attendanceLineChart.destroy();
        document.getElementById('downloadSection').style.display = "none";
      }
      if (screenId === 'homeScreen') {
        renderHome();
      }
    }

    /********************************************************
     *     PETUGAS GURU: input & list
     ********************************************************/
    async function tambahPetugasGuru() {
      let nama = document.getElementById('guruNama').value.trim();
      let hari = document.getElementById('guruHari').value.trim();
      if (!nama || !hari) {
        alert("Nama & Hari piket guru tidak boleh kosong!");
        return;
      }
      if (petugasGuru.length >= 10) {
        alert("Max guru=10!");
        return;
      }
      // Cek duplikat berdasarkan nama dan hari
      let dupe = petugasGuru.some(g => g.nama.toLowerCase() === nama.toLowerCase() && g.hari === hari);
      if(dupe){
        alert("Guru dengan nama dan hari piket tersebut sudah ada!");
        return;
      }
      // Tambah
      let guru = {nama, hari};
      try {
        await db.collection('petugasGuru').add(guru);
        alert(`Ditambahkan: ${nama} (hari: ${hari})`);
        // Reset form
        document.getElementById('guruNama').value = "";
        document.getElementById('guruHari').value = "";
      } catch (error) {
        console.error("Error menambah petugas guru:", error);
        alert("Terjadi kesalahan saat menambah petugas guru.");
      }
    }

    function renderPetugasGuruTable() {
      let tbody = document.getElementById('petugasGuruTable');
      tbody.innerHTML = "";

      petugasGuru.forEach((item, index) => {
        let tr = document.createElement('tr');
        let tdNama = document.createElement('td');
        tdNama.textContent = item.nama;
        let tdHari = document.createElement('td');
        tdHari.textContent = item.hari;
        let tdAksi = document.createElement('td');
        
        // Tombol Edit
        let btnEdit = document.createElement('button');
        btnEdit.textContent = "Edit";
        btnEdit.onclick = () => openEditGuruModal(item.id);
        btnEdit.classList.add('btn-secondary');

        // Tombol Hapus
        let btnHapus = document.createElement('button');
        btnHapus.textContent = "Hapus";
        btnHapus.classList.add('btn-danger');
        btnHapus.onclick = () => hapusPetugasGuru(item.id);

        tdAksi.appendChild(btnEdit);
        tdAksi.appendChild(btnHapus);

        tr.appendChild(tdNama);
        tr.appendChild(tdHari);
        tr.appendChild(tdAksi);
        tbody.appendChild(tr);
      });
    }

    async function hapusPetugasGuru(guruId) {
      if(!confirm(`Hapus guru piket dengan ID: ${guruId}?`)) return;
      try {
        await db.collection('petugasGuru').doc(guruId).delete();
        alert("Guru piket dihapus!");
      } catch (error) {
        console.error("Error menghapus petugas guru:", error);
        alert("Terjadi kesalahan saat menghapus petugas guru.");
      }
    }

    /********************************************************
     *     MANIPULASI MODAL EDIT GURU PIKET
     ********************************************************/
    // Modal Elements
    const editGuruModal = document.getElementById('editGuruModal');

    function openEditGuruModal(guruId) {
      // Cari guru berdasarkan ID
      let guru = petugasGuru.find(g => g.id === guruId);
      if(!guru) return;

      document.getElementById('editGuruId').value = guru.id;
      document.getElementById('editGuruNama').value = guru.nama;
      document.getElementById('editGuruHari').value = guru.hari;
      editGuruModal.style.display = "flex";
    }

    function closeEditGuruModal(){
      editGuruModal.style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target == editGuruModal) {
        editGuruModal.style.display = "none";
      }
    }

    // Handle Edit Guru Form Submission
    document.getElementById('editGuruForm').addEventListener('submit', async function(e){
      e.preventDefault();
      let guruId = document.getElementById('editGuruId').value;
      let nama = document.getElementById('editGuruNama').value.trim();
      let hari = document.getElementById('editGuruHari').value.trim();
      if(!nama || !hari){
        alert("Nama & Hari piket guru tidak boleh kosong!");
        return;
      }
      // Cek duplikat
      let dupe = petugasGuru.some(g => g.nama.toLowerCase() === nama.toLowerCase() && g.hari === hari && g.id !== guruId);
      if(dupe){
        alert("Guru dengan nama dan hari piket tersebut sudah ada!");
        return;
      }
      // Update Firestore
      try {
        await db.collection('petugasGuru').doc(guruId).update({nama, hari});
        closeEditGuruModal();
        alert("Data guru piket diperbarui!");
      } catch (error) {
        console.error("Error memperbarui guru piket:", error);
        alert("Terjadi kesalahan saat memperbarui guru piket.");
      }
    });

    /********************************************************
     *     MANAGEMEN SISWA: input & list
     ********************************************************/
    async function tambahSiswa(event){
      event.preventDefault();
      let nama = document.getElementById('dataSiswaNama').value.trim();
      let kelas = document.getElementById('dataSiswaKelas').value.trim();
      let nis = document.getElementById('dataSiswaNIS').value.trim();
      let waliKelas = document.getElementById('dataSiswaWaliKelas').value.trim();
      if(!nama || !kelas || !nis || !waliKelas){
        alert("Nama, Kelas, NIS, dan Wali Kelas siswa tidak boleh kosong!");
        return;
      }
      // Cek duplikat
      let dupe = databaseSiswa.some(s => s.nama.toLowerCase() === nama.toLowerCase() || s.nis === nis);
      if(dupe){
        alert("Siswa dengan nama atau NIS tersebut sudah ada!");
        return;
      }
      // Tambah siswa
      let siswa = {nama, kelas, nis, waliKelas};
      try {
        await db.collection('databaseSiswa').add(siswa);
        alert("Siswa berhasil ditambahkan!");
        // Reset form
        document.getElementById('dataSiswaNama').value = "";
        document.getElementById('dataSiswaKelas').value = "";
        document.getElementById('dataSiswaNIS').value = "";
        document.getElementById('dataSiswaWaliKelas').value = "";
      } catch (error) {
        console.error("Error menambah siswa:", error);
        alert("Terjadi kesalahan saat menambah siswa.");
      }
    }

    /********************************************************
     *      PENCARIAN DAN PENYARINGAN DATA SISWA
     ********************************************************/
    function cariSiswa(){
      let query = document.getElementById('searchSiswa')?.value.trim().toLowerCase();
      if(!query){
        alert("Masukkan kata kunci pencarian.");
        return;
      }
      // Filter dataSiswa berdasarkan nama, kelas, NIS, atau waliKelas
      let filtered = databaseSiswa.filter(siswa => 
        siswa.nama.toLowerCase().includes(query) ||
        siswa.kelas.toLowerCase().includes(query) ||
        siswa.nis.toLowerCase().includes(query) ||
        siswa.waliKelas.toLowerCase().includes(query)
      );
      renderDataSiswaTable(filtered);
    }

    function resetCariSiswa(){
      if(document.getElementById('searchSiswa')){
        document.getElementById('searchSiswa').value = "";
      }
      renderDataSiswaTable();
    }

    /********************************************************
     *      MODIFIKASI FUNGSI RENDER DATA SISWA
     ********************************************************/
    function renderDataSiswaTable(filteredData = null){
      let tbody = document.getElementById('dataSiswaTable');
      tbody.innerHTML = "";

      let dataToRender = filteredData || databaseSiswa;

      dataToRender.forEach((siswa, index) => {
        let tr = document.createElement('tr');

        // Checkbox
        let tdCheckbox = document.createElement('td');
        let checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.classList.add('select-siswa');
        checkbox.value = index;
        tdCheckbox.appendChild(checkbox);
        tr.appendChild(tdCheckbox);

        // Nama Siswa
        let tdNama = document.createElement('td');
        tdNama.textContent = siswa.nama;
        tr.appendChild(tdNama);

        // Kelas
        let tdKelas = document.createElement('td');
        tdKelas.textContent = siswa.kelas;
        tr.appendChild(tdKelas);

        // NIS
        let tdNIS = document.createElement('td');
        tdNIS.textContent = siswa.nis;
        tr.appendChild(tdNIS);

        // Wali Kelas
        let tdWaliKelas = document.createElement('td');
        tdWaliKelas.textContent = siswa.waliKelas;
        tr.appendChild(tdWaliKelas);

        // Aksi
        let tdAksi = document.createElement('td');

        // Tombol Edit
        let btnEdit = document.createElement('button');
        btnEdit.textContent = "Ubah";
        btnEdit.onclick = () => editSiswa(siswa);
        btnEdit.classList.add('btn-secondary');

        // Tombol Hapus
        let btnHapus = document.createElement('button');
        btnHapus.textContent = "Hapus";
        btnHapus.classList.add('btn-danger');
        btnHapus.onclick = () => hapusSiswa(siswa);

        tdAksi.appendChild(btnEdit);
        tdAksi.appendChild(btnHapus);

        tr.appendChild(tdAksi);
        tbody.appendChild(tr);
      });
    }

    // Fungsi untuk memperbarui datalist untuk autocomplete
    function renderDataSiswaList() {
      let datalist = document.getElementById('siswaList');
      datalist.innerHTML = "";
      databaseSiswa.forEach(siswa => {
        let option = document.createElement('option');
        option.value = siswa.nama;
        datalist.appendChild(option);
      });
    }

    async function editSiswa(siswa){
      let newNama = prompt("Masukkan nama baru siswa:", siswa.nama);
      if(newNama === null) return; // Cancel
      newNama = newNama.trim();
      if(!newNama){
        alert("Nama tidak boleh kosong!");
        return;
      }
      let newKelas = prompt("Masukkan kelas baru siswa:", siswa.kelas);
      if(newKelas === null) return; // Cancel
      newKelas = newKelas.trim();
      if(!newKelas){
        alert("Kelas tidak boleh kosong!");
        return;
      }
      let newNIS = prompt("Masukkan NIS baru siswa:", siswa.nis);
      if(newNIS === null) return; // Cancel
      newNIS = newNIS.trim();
      if(!newNIS){
        alert("NIS tidak boleh kosong!");
        return;
      }
      let newWaliKelas = prompt("Masukkan Wali Kelas baru siswa:", siswa.waliKelas);
      if(newWaliKelas === null) return; // Cancel
      newWaliKelas = newWaliKelas.trim();
      if(!newWaliKelas){
        alert("Wali Kelas tidak boleh kosong!");
        return;
      }
      // Cek duplikat
      let dupe = databaseSiswa.some((s) => 
        (s.nama.toLowerCase() === newNama.toLowerCase() || s.nis.toLowerCase() === newNIS.toLowerCase()) &&
        !(s.nama === siswa.nama && s.nis === siswa.nis)
      );
      if(dupe){
        alert("Siswa dengan nama atau NIS tersebut sudah ada!");
        return;
      }
      // Update Firestore
      try {
        // Cari dan update di Firestore
        let snapshot = await db.collection('databaseSiswa').where('nama', '==', siswa.nama).where('nis', '==', siswa.nis).get();
        snapshot.forEach(doc => {
          db.collection('databaseSiswa').doc(doc.id).update({nama: newNama, kelas: newKelas, nis: newNIS, waliKelas: newWaliKelas});
        });
        alert("Data siswa diperbarui!");
      } catch (error) {
        console.error("Error memperbarui siswa:", error);
        alert("Terjadi kesalahan saat memperbarui siswa.");
      }
    }

    async function hapusSiswa(siswa){
      if(!confirm(`Hapus data siswa: ${siswa.nama} dari kelas ${siswa.kelas}?`)) return;
      try {
        // Hapus dari Firestore databaseSiswa
        let snapshot = await db.collection('databaseSiswa').where('nama', '==', siswa.nama).where('nis', '==', siswa.nis).get();
        snapshot.forEach(doc => {
          db.collection('databaseSiswa').doc(doc.id).delete();
        });

        // Hapus dari Firestore historyAbsensi dan archiveAbsensi
        let historySnapshot = await db.collection('historyAbsensi').where('nama', '==', siswa.nama).get();
        historySnapshot.forEach(doc => {
          db.collection('historyAbsensi').doc(doc.id).delete();
        });
        let archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', siswa.nama).get();
        archiveSnapshot.forEach(doc => {
          db.collection('archiveAbsensi').doc(doc.id).delete();
        });

        // Hapus dari Firestore dataKeterlambatan
        let ketSnapshot = await db.collection('dataKeterlambatan').where('nama', '==', siswa.nama).get();
        ketSnapshot.forEach(doc => {
          db.collection('dataKeterlambatan').doc(doc.id).delete();
        });

        // Hapus dari Firestore petugasSiswa jika ada
        let petugasSnapshot = await db.collection('petugasSiswa').where('nama', '==', siswa.nama).get();
        petugasSnapshot.forEach(doc => {
          db.collection('petugasSiswa').doc(doc.id).delete();
        });

        alert(`Data siswa "${siswa.nama}" dihapus!`);
      } catch (error) {
        console.error("Error menghapus siswa:", error);
        alert("Terjadi kesalahan saat menghapus siswa.");
      }
    }

    /********************************************************
     *     SIMPAN PETUGAS SISWA
     ********************************************************/
    async function simpanPetugasSiswa() {
      let s1 = document.getElementById('siswa1').value.trim();
      let s2 = document.getElementById('siswa2').value.trim();
      if(!s1||!s2) {
        alert("Isi kedua siswa!");
        return;
      }
      // Cek apakah siswa ada di databaseSiswa
      let siswa1Exists = databaseSiswa.some(s => s.nama.toLowerCase() === s1.toLowerCase());
      let siswa2Exists = databaseSiswa.some(s => s.nama.toLowerCase() === s2.toLowerCase());
      if(!siswa1Exists || !siswa2Exists){
        alert("Salah satu atau kedua siswa tidak ditemukan di database. Silakan tambahkan siswa di menu Data Siswa.");
        return;
      }
      petugasSiswa = [s1, s2];
      try {
        // Hapus semua petugasSiswa sebelumnya
        let existingPetugas = await db.collection('petugasSiswa').get();
        let batch = db.batch();
        existingPetugas.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();

        // Simpan petugasSiswa baru
        for(let s of petugasSiswa){
          await db.collection('petugasSiswa').add({nama: s});
        }
        alert("Petugas Siswa => "+petugasSiswa.join(" & "));
        document.getElementById('siswa1').value = "";
        document.getElementById('siswa2').value = "";
      } catch (error) {
        console.error("Error menyimpan petugas siswa:", error);
        alert("Terjadi kesalahan saat menyimpan petugas siswa.");
      }
    }

    /********************************************************
     *      REKALKULASI DATA SISWA
     ********************************************************/
    function recalcDataSiswaFromHistory() {
      dataSiswa = {};
      let combinedData = historyAbsensi.concat(archiveAbsensi);
      combinedData.forEach(record => {
        let { tanggal, nama, status } = record;
        if (!dataSiswa[nama]) {
          dataSiswa[nama] = {
            terlambat_total: 0,
            terlambat_mingguan: 0,
            last_date: ""
          };
        }
        if (status === "late") {
          dataSiswa[nama].terlambat_total++;
          dataSiswa[nama].terlambat_mingguan++;
          if (!dataSiswa[nama].last_date || tanggal > dataSiswa[nama].last_date) {
            dataSiswa[nama].last_date = tanggal;
          }
        }
      });

      // Update dataKeterlambatan
      dataKeterlambatan = [];
      for(let nama in dataSiswa){
        let info = dataSiswa[nama];
        if(info.terlambat_total > 0){
          dataKeterlambatan.push({
            nama,
            terlambat_total: info.terlambat_total
          });
        }
      }
    }

    /********************************************************
     *            INPUT ABSENSI (CEK DUPLIKAT)
     ********************************************************/
    async function catatKehadiran(event) {
      event.preventDefault();
      let rawNama = document.getElementById('namaSiswa').value.trim();
      let namaSiswa = rawNama.toLowerCase();
      let tanggal = document.getElementById('tanggalAbsen').value;

      let statusSelect = document.getElementById('statusKedatangan');
      let statusKedatangan = statusSelect.value;

      let alasan = document.getElementById('dropdownAlasan').value.trim();
      let alasanCustom = document.getElementById('alasanCustom').value.trim();
      let finalAlasan = "-";

      if(!rawNama || !tanggal || !statusKedatangan){
        alert("Mohon lengkapi data (nama, tanggal, status).");
        return;
      }

      // Cek apakah siswa ada di databaseSiswa
      let siswaExists = databaseSiswa.some(s => s.nama.toLowerCase() === namaSiswa);
      if(!siswaExists){
        alert("Siswa tidak ditemukan di database. Silakan tambahkan siswa di menu Data Siswa.");
        return;
      }

      // Cek duplikat di Firestore
      let historySnapshot = await db.collection('historyAbsensi').where('nama', '==', rawNama).where('tanggal', '==', tanggal).get();
      let archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', rawNama).where('tanggal', '==', tanggal).get();
      if(!historySnapshot.empty || !archiveSnapshot.empty){
        alert(`Siswa ${rawNama} sudah tercatat di ${tanggal}`);
        return;
      }

      // Validasi tambahan: Jika status adalah 'late', pastikan alasan atau alasanCustom diisi
      if(statusKedatangan === "late"){
        if(!alasan && !alasanCustom){
          alert("Mohon isi alasan keterlambatan atau alasan kustom.");
          return;
        }
      }

      if(statusKedatangan === "late"){
        if(alasanCustom){
          finalAlasan = alasanCustom;
        } else if(alasan){
          finalAlasan = alasan;
        }
      } else if(statusKedatangan === "izin" || statusKedatangan === "dipulangkan") {
        finalAlasan = alasan || "-";
      }

      // Catat absensi
      let record = {
        nama: rawNama, // Simpan dengan format asli
        tanggal,
        status:statusKedatangan,
        alasan:finalAlasan,
        pengisi: currentPengisi || "-"
      };

      try {
        await db.collection('historyAbsensi').add(record);
        alert("Data absensi tersimpan!");

        // Update keterlambatan jika status late
        if(statusKedatangan === "late"){
          let keterlambatan = dataKeterlambatan.find(k => k.nama.toLowerCase() === namaSiswa);
          if(keterlambatan){
            keterlambatan.terlambat_total += 1;
            // Update Firestore
            let ketSnapshot = await db.collection('dataKeterlambatan').where('nama', '==', keterlambatan.nama).get();
            ketSnapshot.forEach(doc => {
              db.collection('dataKeterlambatan').doc(doc.id).update({terlambat_total: keterlambatan.terlambat_total});
            });
          } else {
            let newKeterlambatan = {
              nama: rawNama,
              terlambat_total: 1
            };
            await db.collection('dataKeterlambatan').add(newKeterlambatan);
          }

          // Cek jika terlambat >= 3
          let currentTotal = dataKeterlambatan.find(k => k.nama.toLowerCase() === namaSiswa)?.terlambat_total || 0;
          if(currentTotal === 3){
            alert(`Siswa ${rawNama} sudah terlambat 3x dan harus dipulangkan.`);
            // Implementasikan logika pemulangan sesuai kebutuhan
          }
        }

        // Reset form
        document.getElementById('namaSiswa').value="";
        document.getElementById('tanggalAbsen').value="";
        statusSelect.value = "";
        document.getElementById('dropdownAlasan').value = "";
        document.getElementById('alasanCustom').value = "";
        document.getElementById('alasanCustomContainer').style.display = "none";

        // Update UI
        renderHome();
      } catch (error) {
        console.error("Error mencatat absensi:", error);
        alert("Terjadi kesalahan saat mencatat absensi.");
      }
    }

    /********************************************************
     *      TOGGLE ALASAN CUSTOM
     ********************************************************/
    function toggleAlasanCustom(){
      let status = document.getElementById('statusKedatangan').value;
      if(status === "late"){
        document.getElementById('alasanCustomContainer').style.display = "block";
      } else {
        document.getElementById('alasanCustomContainer').style.display = "none";
        document.getElementById('alasanCustom').value = "";
      }
    }

    /********************************************************
     *      RENDER TABEL HISTORY
     ********************************************************/
    async function renderHistoryTable(filteredData=null) {
      let tbody = document.getElementById('historyTableBody');
      tbody.innerHTML="";

      let dataToRender = filteredData || (historyAbsensi.concat(archiveAbsensi));

      dataToRender.forEach((item,index)=>{
        let tr=document.createElement('tr');

        // Tanggal
        let tdTgl=document.createElement('td');
        tdTgl.textContent=item.tanggal;
        tr.appendChild(tdTgl);

        // Nama
        let tdNama=document.createElement('td');
        tdNama.textContent=item.nama;
        tr.appendChild(tdNama);

        // Status (Dropdown)
        let tdStatus=document.createElement('td');
        let selectStatus = document.createElement('select');
        selectStatus.innerHTML = `
          <option value="late" ${item.status === "late" ? "selected" : ""}>Terlambat</option>
          <option value="izin" ${item.status === "izin" ? "selected" : ""}>Izin</option>
          <option value="dipulangkan" ${item.status === "dipulangkan" ? "selected" : ""}>Dipulangkan</option>
        `;
        selectStatus.onchange = () => updateStatusHistory(item, selectStatus.value);
        tdStatus.appendChild(selectStatus);
        tr.appendChild(tdStatus);

        // Alasan
        let tdAlasan=document.createElement('td');
        tdAlasan.textContent=item.alasan || "-";
        tr.appendChild(tdAlasan);

        // Pengisi
        let tdPengisi=document.createElement('td');
        tdPengisi.textContent=item.pengisi || "-";
        tr.appendChild(tdPengisi);

        // Aksi
        let tdAksi=document.createElement('td');
        let btnE=document.createElement('button');
        btnE.textContent="Edit Tanggal";
        btnE.classList.add('btn-secondary');
        btnE.onclick=()=>editRiwayatTanggal(item);

        let btnH=document.createElement('button');
        btnH.textContent="Hapus";
        btnH.classList.add('btn-danger');
        btnH.onclick=()=>deleteRiwayat(item);

        tdAksi.appendChild(btnE);
        tdAksi.appendChild(btnH);
        tr.appendChild(tdAksi);

        tbody.appendChild(tr);
      });
    }

    async function updateStatusHistory(item, newStatus){
      try {
        // Update status di Firestore
        let collectionName = 'historyAbsensi';
        let snapshot = await db.collection(collectionName).where('nama', '==', item.nama).where('tanggal', '==', item.tanggal).get();
        if(snapshot.empty){
          // Cek di archiveAbsensi
          collectionName = 'archiveAbsensi';
          snapshot = await db.collection(collectionName).where('nama', '==', item.nama).where('tanggal', '==', item.tanggal).get();
        }
        snapshot.forEach(doc => {
          db.collection(collectionName).doc(doc.id).update({status: newStatus});
        });

        // Alert sukses
        alert("Status absensi berhasil diperbarui!");

        // Update UI
        renderHome();
      } catch (error) {
        console.error("Error memperbarui status absensi:", error);
        alert("Terjadi kesalahan saat memperbarui status absensi.");
      }
    }

    async function editRiwayatTanggal(item){
      let oldDate = item.tanggal;
      let newDate=prompt("Tanggal baru (YYYY-MM-DD):",oldDate);
      if(newDate && newDate !== oldDate){
        // Validasi siswa masih ada
        let namaLower = item.nama.toLowerCase();
        let siswaExists = databaseSiswa.some(s => s.nama.toLowerCase() === namaLower);
        if(!siswaExists){
          alert("Siswa tidak ditemukan di database. Silakan tambahkan siswa di menu Data Siswa.");
          return;
        }

        try {
          // Update di Firestore
          let collectionName = 'historyAbsensi';
          let snapshot = await db.collection(collectionName).where('nama', '==', item.nama).where('tanggal', '==', item.tanggal).get();
          if(snapshot.empty){
            // Cek di archiveAbsensi
            collectionName = 'archiveAbsensi';
            snapshot = await db.collection(collectionName).where('nama', '==', item.nama).where('tanggal', '==', item.tanggal).get();
          }
          snapshot.forEach(doc => {
            db.collection(collectionName).doc(doc.id).update({tanggal: newDate});
          });

          alert("Tanggal berhasil diubah!");
        } catch (error) {
          console.error("Error mengubah tanggal absensi:", error);
          alert("Terjadi kesalahan saat mengubah tanggal absensi.");
        }
      }
    }

    async function deleteRiwayat(item){
      if(!confirm(`Hapus data absensi siswa: ${item.nama} pada tanggal ${item.tanggal}?`)) return;
      try {
        let collectionName = 'historyAbsensi';
        let snapshot = await db.collection(collectionName).where('nama', '==', item.nama).where('tanggal', '==', item.tanggal).get();
        if(snapshot.empty){
          // Cek di archiveAbsensi
          collectionName = 'archiveAbsensi';
          snapshot = await db.collection(collectionName).where('nama', '==', item.nama).where('tanggal', '==', item.tanggal).get();
        }
        snapshot.forEach(doc => {
          db.collection(collectionName).doc(doc.id).delete();
        });

        alert("Data absensi terhapus!");
      } catch (error) {
        console.error("Error menghapus absensi:", error);
        alert("Terjadi kesalahan saat menghapus absensi.");
      }
    }

    /********************************************************
     *      RENDER TABEL DATA KETERLAMBATAN
     ********************************************************/
    function renderDataKeterlambatanTable(){
      let tbody = document.getElementById('dataKeterlambatanTable');
      tbody.innerHTML = "";

      dataKeterlambatan.forEach(async (siswa, index) => {
        let tr = document.createElement('tr');

        let tdNama = document.createElement('td');
        tdNama.textContent = siswa.nama;
        let tdTotal = document.createElement('td');
        tdTotal.textContent = siswa.terlambat_total;
        let tdAksi = document.createElement('td');

        // Tombol Reset
        let btnReset = document.createElement('button');
        btnReset.textContent = "Reset";
        btnReset.onclick = () => resetKeterlambatan(siswa);
        btnReset.classList.add('btn-danger');

        // Tombol Hapus
        let btnHapus = document.createElement('button');
        btnHapus.textContent = "Hapus";
        btnHapus.onclick = () => hapusKeterlambatan(siswa);
        btnHapus.classList.add('btn-danger');

        tdAksi.appendChild(btnReset);
        tdAksi.appendChild(btnHapus);

        tr.appendChild(tdNama);
        tr.appendChild(tdTotal);
        tr.appendChild(tdAksi);

        tbody.appendChild(tr);
      });
    }

    async function resetKeterlambatan(siswa){
      if(!confirm(`Reset jumlah keterlambatan siswa: ${siswa.nama}?`)) return;
      try {
        // Update Firestore
        let snapshot = await db.collection('dataKeterlambatan').where('nama', '==', siswa.nama).get();
        snapshot.forEach(doc => {
          db.collection('dataKeterlambatan').doc(doc.id).update({terlambat_total: 0});
        });
        alert(`Jumlah keterlambatan siswa "${siswa.nama}" telah direset.`);
      } catch (error) {
        console.error("Error mereset keterlambatan:", error);
        alert("Terjadi kesalahan saat mereset keterlambatan.");
      }
    }

    async function hapusKeterlambatan(siswa){
      if(!confirm(`Hapus data keterlambatan siswa: ${siswa.nama}?`)) return;
      try {
        // Hapus dari Firestore
        let snapshot = await db.collection('dataKeterlambatan').where('nama', '==', siswa.nama).get();
        snapshot.forEach(doc => {
          db.collection('dataKeterlambatan').doc(doc.id).delete();
        });
        alert("Data keterlambatan siswa dihapus dari Data Keterlambatan.");
      } catch (error) {
        console.error("Error menghapus keterlambatan:", error);
        alert("Terjadi kesalahan saat menghapus keterlambatan.");
      }
    }

    async function resetSemuaKeterlambatan(){
      if(!confirm("Yakin reset semua keterlambatan siswa?")) return;
      try {
        // Reset semua keterlambatan di Firestore
        let keterlambatanSnapshot = await db.collection('dataKeterlambatan').get();
        let batch = db.batch();
        keterlambatanSnapshot.forEach(doc => {
          batch.update(doc.ref, {terlambat_total: 0});
        });
        await batch.commit();
        alert("Semua keterlambatan siswa telah direset.");
      } catch (error) {
        console.error("Error mereset semua keterlambatan:", error);
        alert("Terjadi kesalahan saat mereset semua keterlambatan.");
      }
    }

    /********************************************************
     *      FILTER HISTORY
     ********************************************************/
    async function filterHistoryByDate(){
      let date = document.getElementById('filterDate').value;
      if(!date){
        alert("Pilih tanggal terlebih dahulu!");
        return;
      }
      // Fetch data dari Firestore
      let historySnapshot = await db.collection('historyAbsensi').where('tanggal', '==', date).get();
      let archiveSnapshot = await db.collection('archiveAbsensi').where('tanggal', '==', date).get();
      let filtered = [];
      historySnapshot.forEach(doc => {
        filtered.push(doc.data());
      });
      archiveSnapshot.forEach(doc => {
        filtered.push(doc.data());
      });
      renderHistoryTable(filtered);
      displayFilterResult(`Tampilkan data absensi tanggal ${date}`, filtered.length);
    }

    async function filterHistoryByDateRange(){
      let startDate = document.getElementById('filterStartDate').value;
      let endDate = document.getElementById('filterEndDate').value;
      if(!startDate || !endDate){
        alert("Pilih kedua tanggal (start & end)!");
        return;
      }
      if(startDate > endDate){
        alert("Tanggal mulai tidak boleh lebih besar dari tanggal akhir!");
        return;
      }
      // Fetch data dari Firestore
      let historySnapshot = await db.collection('historyAbsensi').where('tanggal', '>=', startDate).where('tanggal', '<=', endDate).get();
      let archiveSnapshot = await db.collection('archiveAbsensi').where('tanggal', '>=', startDate).where('tanggal', '<=', endDate).get();
      let filtered = [];
      historySnapshot.forEach(doc => {
        filtered.push(doc.data());
      });
      archiveSnapshot.forEach(doc => {
        filtered.push(doc.data());
      });
      renderHistoryTable(filtered);
      displayFilterResult(`Tampilkan data absensi dari ${startDate} sampai ${endDate}`, filtered.length);
    }

    function resetHistoryFilters(){
      renderHistoryTable();
      if(document.getElementById('filterDate')){
        document.getElementById('filterDate').value = "";
      }
      if(document.getElementById('filterStartDate')){
        document.getElementById('filterStartDate').value = "";
      }
      if(document.getElementById('filterEndDate')){
        document.getElementById('filterEndDate').value = "";
      }
      if(document.getElementById('filterResult')){
        document.getElementById('filterResult').style.display = "none";
      }
    }

    function displayFilterResult(description, count){
      let d = document.getElementById('filterResult');
      d.style.display = "block";
      d.innerHTML = `<p>${description}: ${count} record ditemukan.</p>`;
    }

    /********************************************************
     *      STATISTIK: BAR CHART (SKALA 0–15)
     ********************************************************/
    async function renderStatisticChart(){
      let option = document.getElementById('chartOption').value;
      let chartTitle = "";
      let labels = [];
      let values = [];
      let typeChart = 'bar'; // default

      // Mendapatkan bulan yang dipilih
      let statistikBulan = document.getElementById('statistikBulan').value;

      // Menggabungkan data dari historyAbsensi dan archiveAbsensi
      let combinedData = historyAbsensi.concat(archiveAbsensi);

      if(option === "siswa"){
        if(statistikBulan){
          chartTitle = `Siswa Paling Sering Telat untuk Bulan ${statistikBulan} (Maks 15)`;
          // Filter data berdasarkan bulan
          let filteredData = combinedData.filter(item => item.tanggal.startsWith(statistikBulan) && item.status === "late");
          // Hitung keterlambatan per siswa
          let siswaMap = {};
          filteredData.forEach(item => {
            let nama = item.nama;
            if(!siswaMap[nama]){
              siswaMap[nama] = 0;
            }
            siswaMap[nama]++;
          });
          // Konversi ke array dan sortir
          let arr = [];
          for(let nama in siswaMap){
            arr.push({label: nama, value: siswaMap[nama]});
          }
          arr.sort((a,b) => b.value - a.value);
          arr = arr.slice(0,15); // Maks 15
          labels = arr.map(x => x.label);
          values = arr.map(x => x.value);
        } else {
          chartTitle = "Siswa Paling Sering Telat (Maks 15)";
          // Hitung keterlambatan per siswa
          let siswaMap = {};
          combinedData.forEach(item => {
            if(item.status === "late"){
              let nama = item.nama;
              if(!siswaMap[nama]){
                siswaMap[nama] = 0;
              }
              siswaMap[nama]++;
            }
          });
          // Konversi ke array dan sortir
          let arr = [];
          for(let nama in siswaMap){
            arr.push({label: nama, value: siswaMap[nama]});
          }
          arr.sort((a,b) => b.value - a.value);
          arr = arr.slice(0,15); // Maks 15
          labels = arr.map(x => x.label);
          values = arr.map(x => x.value);
        }

      } else if(option === "alasan"){
        if(statistikBulan){
          chartTitle = `Alasan Keterlambatan Terbanyak untuk Bulan ${statistikBulan} (Maks 15)`;
          // Filter data berdasarkan bulan
          let filteredData = combinedData.filter(item => item.tanggal.startsWith(statistikBulan) && item.status === "late");
          // Hitung keterlambatan per alasan
          let alasanCount = {};
          filteredData.forEach(item => {
            let alasan = item.alasan;
            if(!alasanCount[alasan]){
              alasanCount[alasan] = 0;
            }
            alasanCount[alasan]++;
          });
          // Konversi ke array dan sortir
          let arr = [];
          for(let alasan in alasanCount){
            arr.push({label: alasan, value: alasanCount[alasan]});
          }
          arr.sort((a,b) => b.value - a.value);
          arr = arr.slice(0,15); // Maks 15
          labels = arr.map(x => x.label);
          values = arr.map(x => x.value);
        } else {
          chartTitle = "Alasan Keterlambatan Terbanyak (Maks 15)";
          // Hitung keterlambatan per alasan
          let alasanCount = {};
          combinedData.forEach(item => {
            if(item.status === "late"){
              let alasan = item.alasan;
              if(!alasanCount[alasan]){
                alasanCount[alasan] = 0;
              }
              alasanCount[alasan]++;
            }
          });
          // Konversi ke array dan sortir
          let arr = [];
          for(let alasan in alasanCount){
            arr.push({label: alasan, value: alasanCount[alasan]});
          }
          arr.sort((a,b) => b.value - a.value);
          arr = arr.slice(0,15); // Maks 15
          labels = arr.map(x => x.label);
          values = arr.map(x => x.value);
        }

      } else if(option === "bulanan"){
        chartTitle = "Grafik Keterlambatan Bulanan";
        typeChart = 'line';
        // Hitung keterlambatan per tanggal
        let latenessByDate = {};
        combinedData.forEach(item => {
          if(item.status === "late"){
            let tanggal = item.tanggal;
            if(statistikBulan && !tanggal.startsWith(statistikBulan)){
              return; // Lewati data yang tidak termasuk bulan yang dipilih
            }
            if(!latenessByDate[tanggal]){
              latenessByDate[tanggal] = 0;
            }
            latenessByDate[tanggal]++;
          }
        });
        // Sort tanggal
        labels = Object.keys(latenessByDate).sort();
        values = labels.map(date => latenessByDate[date]);
      }

      // Mendapatkan konteks canvas
      let ctx = document.getElementById('chartStatistic').getContext('2d');

      // Jika chart sudah ada, destroy untuk menghindari overlap
      if(chartObj) chartObj.destroy();
      if(attendanceLineChart) attendanceLineChart.destroy();

      // Menentukan jenis grafik
      if(option === "bulanan"){
        // Grafik Keterlambatan Bulanan
        attendanceLineChart = new Chart(ctx, {
          type: typeChart,
          data: {
            labels,
            datasets: [{
              label: chartTitle,
              data: values,
              backgroundColor: 'rgba(46, 204, 113, 0.2)',
              borderColor: 'rgba(46, 204, 113, 1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive:true,
            scales:{
              y:{
                beginAtZero:true,
                min:0,
                max:15,
                ticks:{
                  stepSize:1
                }
              }
            }
          }
        });
        // Tampilkan tombol download jika grafik bulanan
        document.getElementById('downloadSection').style.display = "block";
      } else {
        // Grafik Siswa atau Alasan
        chartObj = new Chart(ctx, {
          type: typeChart,
          data: {
            labels,
            datasets: [{
              label: chartTitle,
              data: values,
              backgroundColor: option === "siswa" ? 'rgba(54,162,235,0.6)' : 'rgba(255,206,86,0.6)',
              borderColor: option === "siswa" ? 'rgba(54,162,235,1)' : 'rgba(255,206,86,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive:true,
            scales:{
              y:{
                beginAtZero:true,
                min:0,
                max:15,
                ticks:{ stepSize:1 }
              }
            }
          }
        });
        document.getElementById('downloadSection').style.display = "none";
      }
    }

    /********************************************************
     *      IMPORT DATA SISWA (Excel)
     ********************************************************/
    async function importDataSiswa(){
      let fileInput = document.getElementById('importFileSiswa');
      let file = fileInput.files[0];
      if(!file){
        alert("Silakan pilih file Excel terlebih dahulu.");
        return;
      }

      let reader = new FileReader();
      reader.onload = async function(e){
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, {type: 'array'});

        // Asumsikan data siswa berada di sheet pertama
        let firstSheetName = workbook.SheetNames[0];
        let worksheet = workbook.Sheets[firstSheetName];
        let jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});

        // Parsing data
        // Asumsikan baris pertama adalah header: ["Nama", "Kelas", "NIS", "WaliKelas"]
        if(jsonData.length < 2){
          alert("File Excel tidak memiliki data yang cukup.");
          return;
        }

        let headers = jsonData[0];
        let requiredHeaders = ["Nama", "Kelas", "NIS", "WaliKelas"];
        let isValid = requiredHeaders.every((header, index) => header === jsonData[0][index]);
        if(!isValid){
          alert("Format header Excel tidak sesuai. Harus: " + requiredHeaders.join(", "));
          return;
        }

        // Mulai dari baris kedua
        let importedCount = 0;
        for(let i=1; i<jsonData.length; i++){
          let row = jsonData[i];
          let [nama, kelas, nis, waliKelas] = row;

          if(!nama || !kelas || !nis || !waliKelas){
            // Lewati baris yang tidak lengkap
            continue;
          }

          // Cek duplikat di databaseSiswa
          let dupe = databaseSiswa.some(s => s.nama.toLowerCase() === nama.toLowerCase() || s.nis === nis);
          if(dupe){
            // Lewati duplikat
            continue;
          }

          // Tambah siswa
          let siswa = {nama, kelas, nis, waliKelas};
          try {
            await db.collection('databaseSiswa').add(siswa);
            importedCount++;
          } catch (error) {
            console.error("Error mengimpor siswa:", error);
          }
        }

        if(importedCount > 0){
          alert(`${importedCount} data siswa berhasil diimpor.`);
        } else {
          alert("Tidak ada data siswa yang diimpor. Pastikan file tidak kosong atau data sudah ada di database.");
        }

        // Reset input file
        fileInput.value = "";
      };
      reader.onerror = function(){
        alert("Terjadi kesalahan saat membaca file.");
      };
      reader.readAsArrayBuffer(file);
    }

    /********************************************************
     *      DOWNLOAD DATA BULANAN (Excel)
     ********************************************************/
    async function downloadMonthlyData(){
      let month = prompt("Masukkan bulan yang ingin di-download (YYYY-MM):", "2025-01");
      if(!month){
        alert("Bulan tidak boleh kosong!");
        return;
      }

      try {
        // Filter data untuk bulan tersebut dari archiveAbsensi dan historyAbsensi
        let historySnapshot = await db.collection('historyAbsensi').where('tanggal', '>=', `${month}-01`).where('tanggal', '<=', `${month}-31`).get();
        let archiveSnapshot = await db.collection('archiveAbsensi').where('tanggal', '>=', `${month}-01`).where('tanggal', '<=', `${month}-31`).get();
        let filtered = [];
        historySnapshot.forEach(doc => {
          let data = doc.data();
          if(['late','izin','dipulangkan'].includes(data.status)){
            filtered.push(data);
          }
        });
        archiveSnapshot.forEach(doc => {
          let data = doc.data();
          if(['late','izin','dipulangkan'].includes(data.status)){
            filtered.push(data);
          }
        });

        if(filtered.length === 0){
          alert("Tidak ada data absensi untuk bulan tersebut.");
          return;
        }

        // Buat worksheet
        let ws_data = [["Nama Siswa", "Tanggal Absensi", "Status", "Alasan", "Kelas", "Wali Kelas"]];
        for(let item of filtered){
          // Cari kelas dan wali kelas dari databaseSiswa
          let siswa = databaseSiswa.find(s => s.nama.toLowerCase() === item.nama.toLowerCase());
          let kelas = siswa ? siswa.kelas : "-";
          let waliKelas = siswa ? siswa.waliKelas : "-";
          ws_data.push([item.nama, item.tanggal, capitalizeFirstLetter(item.status), item.alasan, kelas, waliKelas]);
        }

        let ws = XLSX.utils.aoa_to_sheet(ws_data);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Absensi");

        // Download
        XLSX.writeFile(wb, `Absensi_${month}.xlsx`);
      } catch (error) {
        console.error("Error mendownload data bulanan:", error);
        alert("Terjadi kesalahan saat mendownload data bulanan.");
      }
    }

    // Helper function untuk mengkapitalisasi huruf pertama
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    /********************************************************
     *               PROFILE
     ********************************************************/
    async function updateProfileInfo(){
      try {
        let historyCount = (await db.collection('historyAbsensi').get()).size;
        let archiveCount = (await db.collection('archiveAbsensi').get()).size;
        document.getElementById('profileAbsensiCount').textContent = historyCount + archiveCount;
      } catch (error) {
        console.error("Error menghitung total absensi:", error);
        document.getElementById('profileAbsensiCount').textContent = "0";
      }
    }

    // Tampilkan data guru di table, diurut hari senin-sabtu
    function renderProfileGuru(){
      let sorted = [...petugasGuru];
      // Sort by day index
      sorted.sort((a,b)=> dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari));

      let tbody=document.getElementById('profileGuruTbody');
      tbody.innerHTML="";
      sorted.forEach((item, index)=>{
        let tr=document.createElement('tr');
        let tdHari=document.createElement('td');
        tdHari.textContent=item.hari;
        let tdNama=document.createElement('td');
        tdNama.textContent=item.nama;
        let tdAksi=document.createElement('td');

        // Tombol Edit di Profile
        let btnEdit = document.createElement('button');
        btnEdit.textContent = "Edit";
        btnEdit.onclick = () => openEditGuruModal(item.id);
        btnEdit.classList.add('btn-secondary');

        // Tombol Hapus di Profile
        let btnHapus = document.createElement('button');
        btnHapus.textContent = "Hapus";
        btnHapus.onclick = () => hapusPetugasGuru(item.id);
        btnHapus.classList.add('btn-danger');

        tdAksi.appendChild(btnEdit);
        tdAksi.appendChild(btnHapus);

        tr.appendChild(tdHari);
        tr.appendChild(tdNama);
        tr.appendChild(tdAksi);
        tbody.appendChild(tr);
      });
    }
    // Tampilkan petugasSiswa di <ul>
    function renderProfileSiswa(){
      let ul = document.getElementById('profileSiswaList');
      ul.innerHTML="";
      petugasSiswa.forEach(s=>{
        let li=document.createElement('li');
        li.textContent=s;
        ul.appendChild(li);
      });
    }

    // Menampilkan dropdown Pengisi => hanya guru sesuai hari aktual
    function renderProfilePengisiToday(){
      let dayName = getTodayDayName(); // ex "Selasa"
      document.getElementById('hariAktualSpan').textContent= dayName || "(Minggu)";

      let dropdown=document.getElementById('dropdownPengisi');
      dropdown.innerHTML="";

      if(!dayName){
        // Minggu atau hari lain yang tidak piket
        let opt=document.createElement('option');
        opt.value="";
        opt.textContent="(Hari ini libur/Minggu)";
        dropdown.appendChild(opt);
      } else {
        // filter petugasGuru => item.hari==dayName
        let todayGuru = petugasGuru.filter(g=>g.hari===dayName);
        if(todayGuru.length===0){
          let opt=document.createElement('option');
          opt.value="";
          opt.textContent="(Tidak ada guru piket hari ini)";
          dropdown.appendChild(opt);
        } else {
          todayGuru.forEach(g=>{
            let opt=document.createElement('option');
            opt.value=g.nama; 
            opt.textContent=g.nama + ` (${g.hari})`;
            dropdown.appendChild(opt);
          });
        }
      }
      // Set selected option to currentPengisi if sesuai hari
      if(currentPengisi){
        let options = dropdown.options;
        for(let i=0; i<options.length; i++){
          if(options[i].value === currentPengisi){
            dropdown.selectedIndex = i;
            break;
          }
        }
      }

      // Tampilkan currentPengisi di <span>
      document.getElementById('currentPengisiSpan').textContent = currentPengisi || "-";
    }

    async function setPengisi(){
      let dd=document.getElementById('dropdownPengisi');
      let val=dd.value;
      currentPengisi=val;
      document.getElementById('currentPengisiSpan').textContent= currentPengisi||"-";
      try {
        await db.collection('currentPengisi').doc('pengisi').set({nama: currentPengisi});
        alert("Pengisi saat ini => "+currentPengisi);
      } catch (error) {
        console.error("Error menyimpan pengisi:", error);
        alert("Terjadi kesalahan saat menyimpan pengisi.");
      }
    }

    // Return dayName dari sistem date => dayOrder atau ""
    function getTodayDayName(){
      let d=new Date();
      let dayNum=d.getDay(); // 0=Sun,1=Mon,2=Tue,...6=Sat
      if(dayNum===0||dayNum>6)return "";
      return dayOrder[dayNum-1]||"";
    }

    /********************************************************
     *      DASHBOARD: RENDER DATA (TERINTEGRASI KE HOME)
     ********************************************************/
    async function renderHome(){
      // 1. Grafik Kehadiran Bulanan
      await renderAttendanceLineChart();

      // 2. Top 5 Siswa dengan Keterlambatan Terbanyak
      renderTop5LateStudents();
    }

    async function renderAttendanceLineChart(){
      // Ambil bulan terakhir dari data
      let combinedData = historyAbsensi.concat(archiveAbsensi);
      if(combinedData.length === 0){
        // Tidak ada data absensi untuk membuat grafik
        let ctx = document.getElementById('chartAttendanceLine').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
      }
      // Tentukan bulan terakhir berdasarkan data
      let latestDate = combinedData.reduce((max, item) => item.tanggal > max ? item.tanggal : max, combinedData[0].tanggal);
      let latestMonth = latestDate.slice(0,7); // YYYY-MM

      // Ambil data untuk bulan terakhir
      let monthlyData = combinedData.filter(item => item.tanggal.startsWith(latestMonth));

      // Hitung kehadiran per hari
      let attendanceByDate = {};
      monthlyData.forEach(item => {
        let date = item.tanggal;
        if(!attendanceByDate[date]){
          attendanceByDate[date] = new Set();
        }
        // Anggap setiap status selain 'late', 'izin', 'dipulangkan' sebagai hadir
        if(!['late', 'izin', 'dipulangkan'].includes(item.status)){
          attendanceByDate[date].add(item.nama);
        }
      });

      // Buat array tanggal dan jumlah hadir
      let dates = [];
      let counts = [];
      let year = parseInt(latestMonth.slice(0,4));
      let month = parseInt(latestMonth.slice(5,7));
      let daysInMonth = new Date(year, month, 0).getDate();
      for(let day=1; day<=daysInMonth; day++){
        let dateStr = `${latestMonth}-${day.toString().padStart(2,'0')}`;
        dates.push(dateStr);
        counts.push(attendanceByDate[dateStr] ? attendanceByDate[dateStr].size : 0);
      }

      // Render chart
      let ctx = document.getElementById('chartAttendanceLine').getContext('2d');

      // Destroy existing chart if any
      if(attendanceLineChart) attendanceLineChart.destroy();

      attendanceLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: `Jumlah Kehadiran pada Bulan ${latestMonth}`,
            data: counts,
            backgroundColor: 'rgba(46, 204, 113, 0.2)',
            borderColor: 'rgba(46, 204, 113, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 30,
              ticks: {
                stepSize: 5
              }
            }
          }
        }
      });
    }

    function renderTop5LateStudents(){
      let tbody = document.getElementById('dashboardTop5TableBody');
      tbody.innerHTML = "";

      // Sort dataKeterlambatan descending
      let sortedKeterlambatan = [...dataKeterlambatan].sort((a,b) => b.terlambat_total - a.terlambat_total);
      let top5 = sortedKeterlambatan.slice(0,5);

      top5.forEach((siswa, index) => {
        let tr = document.createElement('tr');

        let tdRank = document.createElement('td');
        tdRank.textContent = index + 1;
        tdRank.style.fontWeight = 'bold';

        let tdNama = document.createElement('td');
        tdNama.textContent = siswa.nama;

        let tdTotal = document.createElement('td');
        tdTotal.textContent = siswa.terlambat_total;

        tr.appendChild(tdRank);
        tr.appendChild(tdNama);
        tr.appendChild(tdTotal);

        tbody.appendChild(tr);
      });
    }

    /********************************************************
     *      FIREBASE CONFIGURATION
     ********************************************************/
    // 1. Konfigurasi Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyAFhjJBCAX9Lwd4x9WD2I8AcJyXXLW_SWg",
      authDomain: "absensiketerlambatanapp.firebaseapp.com",
      projectId: "absensiketerlambatanapp",
      storageBucket: "absensiketerlambatanapp.firebasestorage.app",
      messagingSenderId: "522595195668",
      appId: "1:522595195668:web:b61422a0cccc2cf9778001"
    };
    // 2. Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    /********************************************************
     *      FUNGSI FIRESTORE CRUD & LOGIKA LAINNYA
     ********************************************************/
    // Semua fungsi CRUD dan logika lain telah didefinisikan di atas

    /********************************************************
     *      INIT 
     ********************************************************/
    async function init(){
      await loadData();
      await archiveWeeklyData();
      recalcDataSiswaFromHistory();
      renderHistoryTable();
      renderDataKeterlambatanTable();
      renderPetugasGuruTable();
      renderDataSiswaTable();
      renderDataSiswaList(); // Render datalist untuk autocomplete
      renderProfileGuru();
      renderProfileSiswa();
      renderProfilePengisiToday();
      await updateProfileInfo();
      renderHome(); // Render Home dashboard saat inisialisasi
    }

    /********************************************************
     *      FUNGSI HAPUS SEMUA & HAPUS PILIH SISWA DI DATA SISWA SCREEN
     ********************************************************/
    async function hapusSemuaSiswa(){
      if(!confirm("Apakah Anda yakin ingin menghapus semua data siswa?")) return;
      try {
        // Hapus semua siswa dari Firestore
        let snapshot = await db.collection('databaseSiswa').get();
        let batch = db.batch();
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();

        // Hapus semua petugasSiswa
        let petugasSnapshot = await db.collection('petugasSiswa').get();
        let batchPetugas = db.batch();
        petugasSnapshot.forEach(doc => {
          batchPetugas.delete(doc.ref);
        });
        await batchPetugas.commit();

        // Hapus semua historyAbsensi
        let historySnapshot = await db.collection('historyAbsensi').get();
        let batchHistory = db.batch();
        historySnapshot.forEach(doc => {
          batchHistory.delete(doc.ref);
        });
        await batchHistory.commit();

        // Hapus semua archiveAbsensi
        let archiveSnapshot = await db.collection('archiveAbsensi').get();
        let batchArchive = db.batch();
        archiveSnapshot.forEach(doc => {
          batchArchive.delete(doc.ref);
        });
        await batchArchive.commit();

        // Hapus semua dataKeterlambatan
        let keterlambatanSnapshot = await db.collection('dataKeterlambatan').get();
        let batchKeterlambatan = db.batch();
        keterlambatanSnapshot.forEach(doc => {
          batchKeterlambatan.delete(doc.ref);
        });
        await batchKeterlambatan.commit();

        // Hapus semua petugasGuru
        let guruSnapshot = await db.collection('petugasGuru').get();
        let batchGuru = db.batch();
        guruSnapshot.forEach(doc => {
          batchGuru.delete(doc.ref);
        });
        await batchGuru.commit();

        // Hapus semua pengisi
        await db.collection('currentPengisi').doc('pengisi').set({nama: ""});
        currentPengisi = "";

        alert("Semua data siswa telah dihapus!");
      } catch (error) {
        console.error("Error menghapus semua siswa:", error);
        alert("Terjadi kesalahan saat menghapus semua siswa.");
      }
    }

    async function hapusPilihSiswa(){
      // Dapatkan semua checkbox yang dipilih
      let checkboxes = document.querySelectorAll('.select-siswa:checked');
      if(checkboxes.length === 0){
        alert("Pilih minimal satu siswa untuk dihapus.");
        return;
      }
      if(!confirm(`Apakah Anda yakin ingin menghapus ${checkboxes.length} siswa yang dipilih?`)) return;

      // Ambil data siswa yang dipilih
      let selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
      let selectedSiswa = selectedIndices.map(index => databaseSiswa[index]);

      try {
        // Hapus siswa dari Firestore
        for(let siswa of selectedSiswa){
          // Hapus dari databaseSiswa
          let snapshot = await db.collection('databaseSiswa').where('nama', '==', siswa.nama).where('nis', '==', siswa.nis).get();
          snapshot.forEach(doc => {
            db.collection('databaseSiswa').doc(doc.id).delete();
          });

          // Hapus dari historyAbsensi dan archiveAbsensi
          let historySnapshot = await db.collection('historyAbsensi').where('nama', '==', siswa.nama).get();
          historySnapshot.forEach(doc => {
            db.collection('historyAbsensi').doc(doc.id).delete();
          });
          let archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', siswa.nama).get();
          archiveSnapshot.forEach(doc => {
            db.collection('archiveAbsensi').doc(doc.id).delete();
          });

          // Hapus dari dataKeterlambatan
          let ketSnapshot = await db.collection('dataKeterlambatan').where('nama', '==', siswa.nama).get();
          ketSnapshot.forEach(doc => {
            db.collection('dataKeterlambatan').doc(doc.id).delete();
          });

          // Hapus dari petugasSiswa jika ada
          let petugasSnapshot = await db.collection('petugasSiswa').where('nama', '==', siswa.nama).get();
          petugasSnapshot.forEach(doc => {
            db.collection('petugasSiswa').doc(doc.id).delete();
          });
        }

        alert(`Data siswa yang dihapus: ${selectedSiswa.map(s => s.nama).join(", ")}`);
      } catch (error) {
        console.error("Error menghapus siswa yang dipilih:", error);
        alert("Terjadi kesalahan saat menghapus siswa yang dipilih.");
      }
    }

    function toggleSelectAll(source){
      let checkboxes = document.querySelectorAll('.select-siswa');
      checkboxes.forEach(cb => cb.checked = source.checked);
    }

    /********************************************************
     *      FIREBASE LISTENERS SETUP
     ********************************************************/
    // Didefinisikan di loadData()

    // Memanggil init saat halaman dimuat
    window.onload = init;

  </script>
</body>
</html>
